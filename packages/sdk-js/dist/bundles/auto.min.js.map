{"version":3,"file":"auto.min.js","sources":["../../../../node_modules/js-cookie/dist/js.cookie.mjs","../../src/util.ts","../../src/feature-repository.ts","../../../../node_modules/dom-mutator/dist/dom-mutator.esm.js","../../src/mongrule.ts","../../src/GrowthBook.ts","../../src/sticky-bucket-service.ts","../../src/auto-wrapper.ts"],"sourcesContent":["/*! js-cookie v3.0.5 | MIT */\n/* eslint-disable no-var */\nfunction assign (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n    for (var key in source) {\n      target[key] = source[key];\n    }\n  }\n  return target\n}\n/* eslint-enable no-var */\n\n/* eslint-disable no-var */\nvar defaultConverter = {\n  read: function (value) {\n    if (value[0] === '\"') {\n      value = value.slice(1, -1);\n    }\n    return value.replace(/(%[\\dA-F]{2})+/gi, decodeURIComponent)\n  },\n  write: function (value) {\n    return encodeURIComponent(value).replace(\n      /%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,\n      decodeURIComponent\n    )\n  }\n};\n/* eslint-enable no-var */\n\n/* eslint-disable no-var */\n\nfunction init (converter, defaultAttributes) {\n  function set (name, value, attributes) {\n    if (typeof document === 'undefined') {\n      return\n    }\n\n    attributes = assign({}, defaultAttributes, attributes);\n\n    if (typeof attributes.expires === 'number') {\n      attributes.expires = new Date(Date.now() + attributes.expires * 864e5);\n    }\n    if (attributes.expires) {\n      attributes.expires = attributes.expires.toUTCString();\n    }\n\n    name = encodeURIComponent(name)\n      .replace(/%(2[346B]|5E|60|7C)/g, decodeURIComponent)\n      .replace(/[()]/g, escape);\n\n    var stringifiedAttributes = '';\n    for (var attributeName in attributes) {\n      if (!attributes[attributeName]) {\n        continue\n      }\n\n      stringifiedAttributes += '; ' + attributeName;\n\n      if (attributes[attributeName] === true) {\n        continue\n      }\n\n      // Considers RFC 6265 section 5.2:\n      // ...\n      // 3.  If the remaining unparsed-attributes contains a %x3B (\";\")\n      //     character:\n      // Consume the characters of the unparsed-attributes up to,\n      // not including, the first %x3B (\";\") character.\n      // ...\n      stringifiedAttributes += '=' + attributes[attributeName].split(';')[0];\n    }\n\n    return (document.cookie =\n      name + '=' + converter.write(value, name) + stringifiedAttributes)\n  }\n\n  function get (name) {\n    if (typeof document === 'undefined' || (arguments.length && !name)) {\n      return\n    }\n\n    // To prevent the for loop in the first place assign an empty array\n    // in case there are no cookies at all.\n    var cookies = document.cookie ? document.cookie.split('; ') : [];\n    var jar = {};\n    for (var i = 0; i < cookies.length; i++) {\n      var parts = cookies[i].split('=');\n      var value = parts.slice(1).join('=');\n\n      try {\n        var found = decodeURIComponent(parts[0]);\n        jar[found] = converter.read(value, found);\n\n        if (name === found) {\n          break\n        }\n      } catch (e) {}\n    }\n\n    return name ? jar[name] : jar\n  }\n\n  return Object.create(\n    {\n      set,\n      get,\n      remove: function (name, attributes) {\n        set(\n          name,\n          '',\n          assign({}, attributes, {\n            expires: -1\n          })\n        );\n      },\n      withAttributes: function (attributes) {\n        return init(this.converter, assign({}, this.attributes, attributes))\n      },\n      withConverter: function (converter) {\n        return init(assign({}, this.converter, converter), this.attributes)\n      }\n    },\n    {\n      attributes: { value: Object.freeze(defaultAttributes) },\n      converter: { value: Object.freeze(converter) }\n    }\n  )\n}\n\nvar api = init(defaultConverter, { path: '/' });\n/* eslint-enable no-var */\n\nexport { api as default };\n","import {\n  AutoExperiment,\n  AutoExperimentChangeType,\n  Polyfills,\n  UrlTarget,\n  UrlTargetType,\n  VariationRange,\n} from \"./types/growthbook\";\n\nconst polyfills: Polyfills = {\n  fetch: globalThis.fetch ? globalThis.fetch.bind(globalThis) : undefined,\n  SubtleCrypto: globalThis.crypto ? globalThis.crypto.subtle : undefined,\n  EventSource: globalThis.EventSource,\n};\nexport function getPolyfills(): Polyfills {\n  return polyfills;\n}\n\nfunction hashFnv32a(str: string): number {\n  let hval = 0x811c9dc5;\n  const l = str.length;\n\n  for (let i = 0; i < l; i++) {\n    hval ^= str.charCodeAt(i);\n    hval +=\n      (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);\n  }\n  return hval >>> 0;\n}\n\nexport function hash(\n  seed: string,\n  value: string,\n  version: number\n): number | null {\n  // New unbiased hashing algorithm\n  if (version === 2) {\n    return (hashFnv32a(hashFnv32a(seed + value) + \"\") % 10000) / 10000;\n  }\n  // Original biased hashing algorithm (keep for backwards compatibility)\n  if (version === 1) {\n    return (hashFnv32a(value + seed) % 1000) / 1000;\n  }\n\n  // Unknown hash version\n  return null;\n}\n\nexport function getEqualWeights(n: number): number[] {\n  if (n <= 0) return [];\n  return new Array(n).fill(1 / n);\n}\n\nexport function inRange(n: number, range: VariationRange): boolean {\n  return n >= range[0] && n < range[1];\n}\n\nexport function inNamespace(\n  hashValue: string,\n  namespace: [string, number, number]\n): boolean {\n  const n = hash(\"__\" + namespace[0], hashValue, 1);\n  if (n === null) return false;\n  return n >= namespace[1] && n < namespace[2];\n}\n\nexport function chooseVariation(n: number, ranges: VariationRange[]): number {\n  for (let i = 0; i < ranges.length; i++) {\n    if (inRange(n, ranges[i])) {\n      return i;\n    }\n  }\n  return -1;\n}\n\nexport function getUrlRegExp(regexString: string): RegExp | undefined {\n  try {\n    const escaped = regexString.replace(/([^\\\\])\\//g, \"$1\\\\/\");\n    return new RegExp(escaped);\n  } catch (e) {\n    console.error(e);\n    return undefined;\n  }\n}\n\nexport function isURLTargeted(url: string, targets: UrlTarget[]) {\n  if (!targets.length) return false;\n  let hasIncludeRules = false;\n  let isIncluded = false;\n\n  for (let i = 0; i < targets.length; i++) {\n    const match = _evalURLTarget(url, targets[i].type, targets[i].pattern);\n    if (targets[i].include === false) {\n      if (match) return false;\n    } else {\n      hasIncludeRules = true;\n      if (match) isIncluded = true;\n    }\n  }\n\n  return isIncluded || !hasIncludeRules;\n}\n\nfunction _evalSimpleUrlPart(\n  actual: string,\n  pattern: string,\n  isPath: boolean\n): boolean {\n  try {\n    // Escape special regex characters and change wildcard `_____` to `.*`\n    let escaped = pattern\n      .replace(/[*.+?^${}()|[\\]\\\\]/g, \"\\\\$&\")\n      .replace(/_____/g, \".*\");\n\n    if (isPath) {\n      // When matching pathname, make leading/trailing slashes optional\n      escaped = \"\\\\/?\" + escaped.replace(/(^\\/|\\/$)/g, \"\") + \"\\\\/?\";\n    }\n\n    const regex = new RegExp(\"^\" + escaped + \"$\", \"i\");\n    return regex.test(actual);\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalSimpleUrlTarget(actual: URL, pattern: string) {\n  try {\n    // If a protocol is missing, but a host is specified, add `https://` to the front\n    // Use \"_____\" as the wildcard since `*` is not a valid hostname in some browsers\n    const expected = new URL(\n      pattern.replace(/^([^:/?]*)\\./i, \"https://$1.\").replace(/\\*/g, \"_____\"),\n      \"https://_____\"\n    );\n\n    // Compare each part of the URL separately\n    const comps: Array<[string, string, boolean]> = [\n      [actual.host, expected.host, false],\n      [actual.pathname, expected.pathname, true],\n    ];\n    // We only want to compare hashes if it's explicitly being targeted\n    if (expected.hash) {\n      comps.push([actual.hash, expected.hash, false]);\n    }\n\n    expected.searchParams.forEach((v, k) => {\n      comps.push([actual.searchParams.get(k) || \"\", v, false]);\n    });\n\n    // If any comparisons fail, the whole thing fails\n    return !comps.some(\n      (data) => !_evalSimpleUrlPart(data[0], data[1], data[2])\n    );\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalURLTarget(\n  url: string,\n  type: UrlTargetType,\n  pattern: string\n): boolean {\n  try {\n    const parsed = new URL(url, \"https://_\");\n\n    if (type === \"regex\") {\n      const regex = getUrlRegExp(pattern);\n      if (!regex) return false;\n      return (\n        regex.test(parsed.href) ||\n        regex.test(parsed.href.substring(parsed.origin.length))\n      );\n    } else if (type === \"simple\") {\n      return _evalSimpleUrlTarget(parsed, pattern);\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nexport function getBucketRanges(\n  numVariations: number,\n  coverage: number | undefined,\n  weights?: number[]\n): VariationRange[] {\n  coverage = coverage === undefined ? 1 : coverage;\n\n  // Make sure coverage is within bounds\n  if (coverage < 0) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be greater than or equal to 0\");\n    }\n    coverage = 0;\n  } else if (coverage > 1) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be less than or equal to 1\");\n    }\n    coverage = 1;\n  }\n\n  // Default to equal weights if missing or invalid\n  const equal = getEqualWeights(numVariations);\n  weights = weights || equal;\n  if (weights.length !== numVariations) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\n        \"Experiment.weights array must be the same length as Experiment.variations\"\n      );\n    }\n    weights = equal;\n  }\n\n  // If weights don't add up to 1 (or close to it), default to equal weights\n  const totalWeight = weights.reduce((w, sum) => sum + w, 0);\n  if (totalWeight < 0.99 || totalWeight > 1.01) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.weights must add up to 1\");\n    }\n    weights = equal;\n  }\n\n  // Covert weights to ranges\n  let cumulative = 0;\n  return weights.map((w) => {\n    const start = cumulative;\n    cumulative += w;\n    return [start, start + (coverage as number) * w];\n  }) as VariationRange[];\n}\n\nexport function getQueryStringOverride(\n  id: string,\n  url: string,\n  numVariations: number\n) {\n  if (!url) {\n    return null;\n  }\n\n  const search = url.split(\"?\")[1];\n  if (!search) {\n    return null;\n  }\n\n  const match = search\n    .replace(/#.*/, \"\") // Get rid of anchor\n    .split(\"&\") // Split into key/value pairs\n    .map((kv) => kv.split(\"=\", 2))\n    .filter(([k]) => k === id) // Look for key that matches the experiment id\n    .map(([, v]) => parseInt(v)); // Parse the value into an integer\n\n  if (match.length > 0 && match[0] >= 0 && match[0] < numVariations)\n    return match[0];\n\n  return null;\n}\n\nexport function isIncluded(include: () => boolean) {\n  try {\n    return include();\n  } catch (e) {\n    console.error(e);\n    return false;\n  }\n}\n\nconst base64ToBuf = (b: string) =>\n  Uint8Array.from(atob(b), (c) => c.charCodeAt(0));\n\nexport async function decrypt(\n  encryptedString: string,\n  decryptionKey?: string,\n  subtle?: SubtleCrypto\n): Promise<string> {\n  decryptionKey = decryptionKey || \"\";\n  subtle =\n    subtle ||\n    (globalThis.crypto && globalThis.crypto.subtle) ||\n    polyfills.SubtleCrypto;\n  if (!subtle) {\n    throw new Error(\"No SubtleCrypto implementation found\");\n  }\n  try {\n    const key = await subtle.importKey(\n      \"raw\",\n      base64ToBuf(decryptionKey),\n      { name: \"AES-CBC\", length: 128 },\n      true,\n      [\"encrypt\", \"decrypt\"]\n    );\n    const [iv, cipherText] = encryptedString.split(\".\");\n    const plainTextBuffer = await subtle.decrypt(\n      { name: \"AES-CBC\", iv: base64ToBuf(iv) },\n      key,\n      base64ToBuf(cipherText)\n    );\n\n    return new TextDecoder().decode(plainTextBuffer);\n  } catch (e) {\n    throw new Error(\"Failed to decrypt\");\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function toString(input: any): string {\n  if (typeof input === \"string\") return input;\n  return JSON.stringify(input);\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function paddedVersionString(input: any): string {\n  if (typeof input === \"number\") {\n    input = input + \"\";\n  }\n  if (!input || typeof input !== \"string\") {\n    input = \"0\";\n  }\n  // Remove build info and leading `v` if any\n  // Split version into parts (both core version numbers and pre-release tags)\n  // \"v1.2.3-rc.1+build123\" -> [\"1\",\"2\",\"3\",\"rc\",\"1\"]\n  const parts = (input as string).replace(/(^v|\\+.*$)/g, \"\").split(/[-.]/);\n\n  // If it's SemVer without a pre-release, add `~` to the end\n  // [\"1\",\"0\",\"0\"] -> [\"1\",\"0\",\"0\",\"~\"]\n  // \"~\" is the largest ASCII character, so this will make \"1.0.0\" greater than \"1.0.0-beta\" for example\n  if (parts.length === 3) {\n    parts.push(\"~\");\n  }\n\n  // Left pad each numeric part with spaces so string comparisons will work (\"9\">\"10\", but \" 9\"<\"10\")\n  // Then, join back together into a single string\n  return parts\n    .map((v) => (v.match(/^[0-9]+$/) ? v.padStart(5, \" \") : v))\n    .join(\"-\");\n}\n\nexport function loadSDKVersion(): string {\n  let version: string;\n  try {\n    // @ts-expect-error right-hand value to be replaced by build with string literal\n    version = __SDK_VERSION__;\n  } catch (e) {\n    version = \"\";\n  }\n  return version;\n}\n\nexport function mergeQueryStrings(oldUrl: string, newUrl: string): string {\n  let currUrl: URL;\n  let redirectUrl: URL;\n  try {\n    currUrl = new URL(oldUrl);\n    redirectUrl = new URL(newUrl);\n  } catch (e) {\n    console.error(`Unable to merge query strings: ${e}`);\n    return newUrl;\n  }\n\n  currUrl.searchParams.forEach((value, key) => {\n    // skip  if search param already exists in redirectUrl\n    if (redirectUrl.searchParams.has(key)) {\n      return;\n    }\n    redirectUrl.searchParams.set(key, value);\n  });\n\n  return redirectUrl.toString();\n}\n\nfunction isObj(x: unknown): x is Record<string, unknown> {\n  return typeof x === \"object\" && x !== null;\n}\n\nexport function getAutoExperimentChangeType(\n  exp: AutoExperiment\n): AutoExperimentChangeType {\n  if (\n    exp.urlPatterns &&\n    exp.variations.some(\n      (variation) => isObj(variation) && \"urlRedirect\" in variation\n    )\n  ) {\n    return \"redirect\";\n  } else if (\n    exp.variations.some(\n      (variation) =>\n        isObj(variation) &&\n        (variation.domMutations || \"js\" in variation || \"css\" in variation)\n    )\n  ) {\n    return \"visual\";\n  }\n\n  return \"unknown\";\n}\n","import {\n  Attributes,\n  CacheSettings,\n  FeatureApiResponse,\n  FetchResponse,\n  Helpers,\n  Polyfills,\n} from \"./types/growthbook\";\nimport { getPolyfills } from \"./util\";\nimport type { GrowthBook } from \".\";\n\ntype CacheEntry = {\n  data: FeatureApiResponse;\n  sse?: boolean;\n  version: string;\n  staleAt: Date;\n};\ntype ScopedChannel = {\n  src: EventSource | null;\n  cb: (event: MessageEvent<string>) => void;\n  host: string;\n  clientKey: string;\n  headers?: Record<string, string>;\n  errors: number;\n  state: \"active\" | \"idle\" | \"disabled\";\n};\n\n// Config settings\nconst cacheSettings: CacheSettings = {\n  // Consider a fetch stale after 1 minute\n  staleTTL: 1000 * 60,\n  // Max time to keep a fetch in cache (24 hours default)\n  maxAge: 1000 * 60 * 60 * 24,\n  cacheKey: \"gbFeaturesCache\",\n  backgroundSync: true,\n  maxEntries: 10,\n  disableIdleStreams: false,\n  idleStreamInterval: 20000,\n  disableCache: false,\n};\n\nconst polyfills = getPolyfills();\n\nexport const helpers: Helpers = {\n  fetchFeaturesCall: ({ host, clientKey, headers }) => {\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/features/${clientKey}`,\n      { headers }\n    );\n  },\n  fetchRemoteEvalCall: ({ host, clientKey, payload, headers }) => {\n    const options = {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", ...headers },\n      body: JSON.stringify(payload),\n    };\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/eval/${clientKey}`,\n      options\n    );\n  },\n  eventSourceCall: ({ host, clientKey, headers }) => {\n    if (headers) {\n      return new polyfills.EventSource(`${host}/sub/${clientKey}`, {\n        headers,\n      });\n    }\n    return new polyfills.EventSource(`${host}/sub/${clientKey}`);\n  },\n  startIdleListener: () => {\n    let idleTimeout: number | undefined;\n    const isBrowser =\n      typeof window !== \"undefined\" && typeof document !== \"undefined\";\n    if (!isBrowser) return;\n    const onVisibilityChange = () => {\n      if (document.visibilityState === \"visible\") {\n        window.clearTimeout(idleTimeout);\n        onVisible();\n      } else if (document.visibilityState === \"hidden\") {\n        idleTimeout = window.setTimeout(\n          onHidden,\n          cacheSettings.idleStreamInterval\n        );\n      }\n    };\n    document.addEventListener(\"visibilitychange\", onVisibilityChange);\n    return () =>\n      document.removeEventListener(\"visibilitychange\", onVisibilityChange);\n  },\n  stopIdleListener: () => {\n    // No-op, replaced by startIdleListener\n  },\n};\n\ntry {\n  if (globalThis.localStorage) {\n    polyfills.localStorage = globalThis.localStorage;\n  }\n} catch (e) {\n  // Ignore localStorage errors\n}\n\n// Global state\nconst subscribedInstances: Map<string, Set<GrowthBook>> = new Map();\nlet cacheInitialized = false;\nconst cache: Map<string, CacheEntry> = new Map();\nconst activeFetches: Map<string, Promise<FetchResponse>> = new Map();\nconst streams: Map<string, ScopedChannel> = new Map();\nconst supportsSSE: Set<string> = new Set();\n\n// Public functions\nexport function setPolyfills(overrides: Partial<Polyfills>): void {\n  Object.assign(polyfills, overrides);\n}\nexport function configureCache(overrides: Partial<CacheSettings>): void {\n  Object.assign(cacheSettings, overrides);\n  if (!cacheSettings.backgroundSync) {\n    clearAutoRefresh();\n  }\n}\n\nexport async function clearCache(): Promise<void> {\n  cache.clear();\n  activeFetches.clear();\n  clearAutoRefresh();\n  cacheInitialized = false;\n  await updatePersistentCache();\n}\n\n// Get or fetch features and refresh the SDK instance\nexport async function refreshFeatures({\n  instance,\n  timeout,\n  skipCache,\n  allowStale,\n  backgroundSync,\n}: {\n  instance: GrowthBook;\n  timeout?: number;\n  skipCache?: boolean;\n  allowStale?: boolean;\n  backgroundSync?: boolean;\n}): Promise<FetchResponse> {\n  if (!backgroundSync) {\n    cacheSettings.backgroundSync = false;\n  }\n\n  return fetchFeaturesWithCache({\n    instance,\n    allowStale,\n    timeout,\n    skipCache,\n  });\n}\n\n// Subscribe a GrowthBook instance to feature changes\nexport function subscribe(instance: GrowthBook): void {\n  const key = getKey(instance);\n  const subs = subscribedInstances.get(key) || new Set();\n  subs.add(instance);\n  subscribedInstances.set(key, subs);\n}\nexport function unsubscribe(instance: GrowthBook): void {\n  subscribedInstances.forEach((s) => s.delete(instance));\n}\n\nexport function onHidden() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    channel.state = \"idle\";\n    disableChannel(channel);\n  });\n}\n\nexport function onVisible() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    if (channel.state !== \"idle\") return;\n    enableChannel(channel);\n  });\n}\n\n// Private functions\n\nasync function updatePersistentCache() {\n  try {\n    if (!polyfills.localStorage) return;\n    await polyfills.localStorage.setItem(\n      cacheSettings.cacheKey,\n      JSON.stringify(Array.from(cache.entries()))\n    );\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n}\n\n// SWR wrapper for fetching features. May indirectly or directly start SSE streaming.\nasync function fetchFeaturesWithCache({\n  instance,\n  allowStale,\n  timeout,\n  skipCache,\n}: {\n  instance: GrowthBook;\n  allowStale?: boolean;\n  timeout?: number;\n  skipCache?: boolean;\n}): Promise<FetchResponse> {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const now = new Date();\n\n  const minStaleAt = new Date(\n    now.getTime() - cacheSettings.maxAge + cacheSettings.staleTTL\n  );\n\n  await initializeCache();\n  const existing =\n    !cacheSettings.disableCache && !skipCache ? cache.get(cacheKey) : undefined;\n  if (\n    existing &&\n    (allowStale || existing.staleAt > now) &&\n    existing.staleAt > minStaleAt\n  ) {\n    // Restore from cache whether SSE is supported\n    if (existing.sse) supportsSSE.add(key);\n\n    // Reload features in the background if stale\n    if (existing.staleAt < now) {\n      fetchFeatures(instance);\n    }\n    // Otherwise, if we don't need to refresh now, start a background sync\n    else {\n      startAutoRefresh(instance);\n    }\n    return { data: existing.data, success: true, source: \"cache\" };\n  } else {\n    const res = await promiseTimeout(fetchFeatures(instance), timeout);\n    return (\n      res || {\n        data: null,\n        success: false,\n        source: \"timeout\",\n        error: new Error(\"Timeout\"),\n      }\n    );\n  }\n}\n\nfunction getKey(instance: GrowthBook): string {\n  const [apiHost, clientKey] = instance.getApiInfo();\n  return `${apiHost}||${clientKey}`;\n}\n\nfunction getCacheKey(instance: GrowthBook): string {\n  const baseKey = getKey(instance);\n  if (!instance.isRemoteEval()) return baseKey;\n\n  const attributes = instance.getAttributes();\n  const cacheKeyAttributes =\n    instance.getCacheKeyAttributes() || Object.keys(instance.getAttributes());\n  const ca: Attributes = {};\n  cacheKeyAttributes.forEach((key) => {\n    ca[key] = attributes[key];\n  });\n\n  const fv = instance.getForcedVariations();\n  const url = instance.getUrl();\n\n  return `${baseKey}||${JSON.stringify({\n    ca,\n    fv,\n    url,\n  })}`;\n}\n\n// Guarantee the promise always resolves within {timeout} ms\n// Resolved value will be `null` when there's an error or it takes too long\n// Note: The promise will continue running in the background, even if the timeout is hit\nfunction promiseTimeout<T>(\n  promise: Promise<T>,\n  timeout?: number\n): Promise<T | null> {\n  return new Promise((resolve) => {\n    let resolved = false;\n    let timer: NodeJS.Timeout | undefined;\n    const finish = (data?: T) => {\n      if (resolved) return;\n      resolved = true;\n      timer && clearTimeout(timer);\n      resolve(data || null);\n    };\n\n    if (timeout) {\n      timer = setTimeout(() => finish(), timeout);\n    }\n\n    promise.then((data) => finish(data)).catch(() => finish());\n  });\n}\n\n// Populate cache from localStorage (if available)\nasync function initializeCache(): Promise<void> {\n  if (cacheInitialized) return;\n  cacheInitialized = true;\n  try {\n    if (polyfills.localStorage) {\n      const value = await polyfills.localStorage.getItem(\n        cacheSettings.cacheKey\n      );\n      if (!cacheSettings.disableCache && value) {\n        const parsed: [string, CacheEntry][] = JSON.parse(value);\n        if (parsed && Array.isArray(parsed)) {\n          parsed.forEach(([key, data]) => {\n            cache.set(key, {\n              ...data,\n              staleAt: new Date(data.staleAt),\n            });\n          });\n        }\n        cleanupCache();\n      }\n    }\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n  if (!cacheSettings.disableIdleStreams) {\n    const cleanupFn = helpers.startIdleListener();\n    if (cleanupFn) {\n      helpers.stopIdleListener = cleanupFn;\n    }\n  }\n}\n\n// Enforce the maxEntries limit\nfunction cleanupCache() {\n  const entriesWithTimestamps = Array.from(cache.entries())\n    .map(([key, value]) => ({\n      key,\n      staleAt: value.staleAt.getTime(),\n    }))\n    .sort((a, b) => a.staleAt - b.staleAt);\n\n  const entriesToRemoveCount = Math.min(\n    Math.max(0, cache.size - cacheSettings.maxEntries),\n    cache.size\n  );\n\n  for (let i = 0; i < entriesToRemoveCount; i++) {\n    cache.delete(entriesWithTimestamps[i].key);\n  }\n}\n\n// Called whenever new features are fetched from the API\nfunction onNewFeatureData(\n  key: string,\n  cacheKey: string,\n  data: FeatureApiResponse\n): void {\n  // If contents haven't changed, ignore the update, extend the stale TTL\n  const version = data.dateUpdated || \"\";\n  const staleAt = new Date(Date.now() + cacheSettings.staleTTL);\n  const existing = !cacheSettings.disableCache\n    ? cache.get(cacheKey)\n    : undefined;\n  if (existing && version && existing.version === version) {\n    existing.staleAt = staleAt;\n    updatePersistentCache();\n    return;\n  }\n\n  if (!cacheSettings.disableCache) {\n    // Update in-memory cache\n    cache.set(cacheKey, {\n      data,\n      version,\n      staleAt,\n      sse: supportsSSE.has(key),\n    });\n    cleanupCache();\n  }\n  // Update local storage (don't await this, just update asynchronously)\n  updatePersistentCache();\n\n  // Update features for all subscribed GrowthBook instances\n  const instances = subscribedInstances.get(key);\n  instances && instances.forEach((instance) => refreshInstance(instance, data));\n}\n\nasync function refreshInstance(\n  instance: GrowthBook,\n  data: FeatureApiResponse | null\n): Promise<void> {\n  await instance.setPayload(data || instance.getPayload());\n}\n\n// Fetch the features payload from helper function or from in-mem injected payload\nasync function fetchFeatures(instance: GrowthBook): Promise<FetchResponse> {\n  const { apiHost, apiRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n  const remoteEval = instance.isRemoteEval();\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n\n  let promise = activeFetches.get(cacheKey);\n  if (!promise) {\n    const fetcher: Promise<Response> = remoteEval\n      ? helpers.fetchRemoteEvalCall({\n          host: apiHost,\n          clientKey,\n          payload: {\n            attributes: instance.getAttributes(),\n            forcedVariations: instance.getForcedVariations(),\n            forcedFeatures: Array.from(instance.getForcedFeatures().entries()),\n            url: instance.getUrl(),\n          },\n          headers: apiRequestHeaders,\n        })\n      : helpers.fetchFeaturesCall({\n          host: apiHost,\n          clientKey,\n          headers: apiRequestHeaders,\n        });\n\n    // TODO: auto-retry if status code indicates a temporary error\n    promise = fetcher\n      .then((res) => {\n        if (!res.ok) {\n          throw new Error(`HTTP error: ${res.status}`);\n        }\n        if (res.headers.get(\"x-sse-support\") === \"enabled\") {\n          supportsSSE.add(key);\n        }\n        return res.json();\n      })\n      .then((data: FeatureApiResponse) => {\n        onNewFeatureData(key, cacheKey, data);\n        startAutoRefresh(instance);\n        activeFetches.delete(cacheKey);\n        return { data, success: true, source: \"network\" as const };\n      })\n      .catch((e) => {\n        process.env.NODE_ENV !== \"production\" &&\n          instance.log(\"Error fetching features\", {\n            apiHost,\n            clientKey,\n            error: e ? e.message : null,\n          });\n        activeFetches.delete(cacheKey);\n\n        return {\n          data: null,\n          source: \"error\" as const,\n          success: false,\n          error: e,\n        };\n      });\n    activeFetches.set(cacheKey, promise);\n  }\n  return promise;\n}\n\n// Start SSE streaming, listens to feature payload changes and triggers a refresh or re-fetch\nexport function startAutoRefresh(\n  instance: GrowthBook,\n  forceSSE: boolean = false\n): void {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const { streamingHost, streamingHostRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n\n  if (forceSSE) {\n    supportsSSE.add(key);\n  }\n\n  if (\n    cacheSettings.backgroundSync &&\n    supportsSSE.has(key) &&\n    polyfills.EventSource\n  ) {\n    if (streams.has(key)) return;\n    const channel: ScopedChannel = {\n      src: null,\n      host: streamingHost,\n      clientKey,\n      headers: streamingHostRequestHeaders,\n      cb: (event: MessageEvent<string>) => {\n        try {\n          if (event.type === \"features-updated\") {\n            const instances = subscribedInstances.get(key);\n            instances &&\n              instances.forEach((instance) => {\n                fetchFeatures(instance);\n              });\n          } else if (event.type === \"features\") {\n            const json: FeatureApiResponse = JSON.parse(event.data);\n            onNewFeatureData(key, cacheKey, json);\n          }\n          // Reset error count on success\n          channel.errors = 0;\n        } catch (e) {\n          process.env.NODE_ENV !== \"production\" &&\n            instance.log(\"SSE Error\", {\n              streamingHost,\n              clientKey,\n              error: e ? (e as Error).message : null,\n            });\n          onSSEError(channel);\n        }\n      },\n      errors: 0,\n      state: \"active\",\n    };\n    streams.set(key, channel);\n    enableChannel(channel);\n  }\n}\n\nfunction onSSEError(channel: ScopedChannel) {\n  if (channel.state === \"idle\") return;\n  channel.errors++;\n  if (channel.errors > 3 || (channel.src && channel.src.readyState === 2)) {\n    // exponential backoff after 4 errors, with jitter\n    const delay =\n      Math.pow(3, channel.errors - 3) * (1000 + Math.random() * 1000);\n    disableChannel(channel);\n    setTimeout(() => {\n      if ([\"idle\", \"active\"].includes(channel.state)) return;\n      enableChannel(channel);\n    }, Math.min(delay, 300000)); // 5 minutes max\n  }\n}\n\nfunction disableChannel(channel: ScopedChannel) {\n  if (!channel.src) return;\n  channel.src.onopen = null;\n  channel.src.onerror = null;\n  channel.src.close();\n  channel.src = null;\n  if (channel.state === \"active\") {\n    channel.state = \"disabled\";\n  }\n}\n\nfunction enableChannel(channel: ScopedChannel) {\n  channel.src = helpers.eventSourceCall({\n    host: channel.host,\n    clientKey: channel.clientKey,\n    headers: channel.headers,\n  }) as EventSource;\n  channel.state = \"active\";\n  channel.src.addEventListener(\"features\", channel.cb);\n  channel.src.addEventListener(\"features-updated\", channel.cb);\n  channel.src.onerror = () => onSSEError(channel);\n  channel.src.onopen = () => {\n    channel.errors = 0;\n  };\n}\n\nfunction destroyChannel(channel: ScopedChannel, key: string) {\n  disableChannel(channel);\n  streams.delete(key);\n}\n\nfunction clearAutoRefresh() {\n  // Clear list of which keys are auto-updated\n  supportsSSE.clear();\n\n  // Stop listening for any SSE events\n  streams.forEach(destroyChannel);\n\n  // Remove all references to GrowthBook instances\n  subscribedInstances.clear();\n\n  // Run the idle stream cleanup function\n  helpers.stopIdleListener();\n}\n","var validAttributeName = /^[a-zA-Z:_][a-zA-Z0-9:_.-]*$/;\nvar nullController = {\n  revert: function revert() {}\n};\nvar elements = /*#__PURE__*/new Map();\nvar mutations = /*#__PURE__*/new Set();\n\nfunction getObserverInit(attr) {\n  return attr === 'html' ? {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    characterData: true\n  } : {\n    childList: false,\n    subtree: false,\n    attributes: true,\n    attributeFilter: [attr]\n  };\n}\n\nfunction getElementRecord(element) {\n  var record = elements.get(element);\n\n  if (!record) {\n    record = {\n      element: element,\n      attributes: {}\n    };\n    elements.set(element, record);\n  }\n\n  return record;\n}\n\nfunction createElementPropertyRecord(el, attr, getCurrentValue, setValue, mutationRunner) {\n  var currentValue = getCurrentValue(el);\n  var record = {\n    isDirty: false,\n    originalValue: currentValue,\n    virtualValue: currentValue,\n    mutations: [],\n    el: el,\n    _positionTimeout: null,\n    observer: new MutationObserver(function () {\n      // enact a 1 second timeout that blocks subsequent firing of the\n      // observer until the timeout is complete. This will prevent multiple\n      // mutations from firing in quick succession, which can cause the\n      // mutation to be reverted before the DOM has a chance to update.\n      if (attr === 'position' && record._positionTimeout) return;else if (attr === 'position') record._positionTimeout = setTimeout(function () {\n        record._positionTimeout = null;\n      }, 1000);\n      var currentValue = getCurrentValue(el);\n      if (attr === 'position' && currentValue.parentNode === record.virtualValue.parentNode && currentValue.insertBeforeNode === record.virtualValue.insertBeforeNode) return;\n      if (currentValue === record.virtualValue) return;\n      record.originalValue = currentValue;\n      mutationRunner(record);\n    }),\n    mutationRunner: mutationRunner,\n    setValue: setValue,\n    getCurrentValue: getCurrentValue\n  };\n\n  if (attr === 'position' && el.parentNode) {\n    record.observer.observe(el.parentNode, {\n      childList: true,\n      subtree: true,\n      attributes: false,\n      characterData: false\n    });\n  } else {\n    record.observer.observe(el, getObserverInit(attr));\n  }\n\n  return record;\n}\n\nfunction queueIfNeeded(val, record) {\n  var currentVal = record.getCurrentValue(record.el);\n  record.virtualValue = val;\n\n  if (val && typeof val !== 'string') {\n    if (!currentVal || val.parentNode !== currentVal.parentNode || val.insertBeforeNode !== currentVal.insertBeforeNode) {\n      record.isDirty = true;\n      runDOMUpdates();\n    }\n  } else if (val !== currentVal) {\n    record.isDirty = true;\n    runDOMUpdates();\n  }\n}\n\nfunction htmlMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(getTransformedHTML(val), record);\n}\n\nfunction classMutationRunner(record) {\n  var val = new Set(record.originalValue.split(/\\s+/).filter(Boolean));\n  record.mutations.forEach(function (m) {\n    return m.mutate(val);\n  });\n  queueIfNeeded(Array.from(val).filter(Boolean).join(' '), record);\n}\n\nfunction attrMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(val, record);\n}\n\nfunction _loadDOMNodes(_ref) {\n  var parentSelector = _ref.parentSelector,\n      insertBeforeSelector = _ref.insertBeforeSelector;\n  var parentNode = document.querySelector(parentSelector);\n  if (!parentNode) return null;\n  var insertBeforeNode = insertBeforeSelector ? document.querySelector(insertBeforeSelector) : null;\n  if (insertBeforeSelector && !insertBeforeNode) return null;\n  return {\n    parentNode: parentNode,\n    insertBeforeNode: insertBeforeNode\n  };\n}\n\nfunction positionMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    var selectors = m.mutate();\n\n    var newNodes = _loadDOMNodes(selectors);\n\n    val = newNodes || val;\n  });\n  queueIfNeeded(val, record);\n}\n\nvar getHTMLValue = function getHTMLValue(el) {\n  return el.innerHTML;\n};\n\nvar setHTMLValue = function setHTMLValue(el, value) {\n  return el.innerHTML = value;\n};\n\nfunction getElementHTMLRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.html) {\n    elementRecord.html = createElementPropertyRecord(element, 'html', getHTMLValue, setHTMLValue, htmlMutationRunner);\n  }\n\n  return elementRecord.html;\n}\n\nvar getElementPosition = function getElementPosition(el) {\n  return {\n    parentNode: el.parentElement,\n    insertBeforeNode: el.nextElementSibling\n  };\n};\n\nvar setElementPosition = function setElementPosition(el, value) {\n  if (value.insertBeforeNode && !value.parentNode.contains(value.insertBeforeNode)) {\n    // skip position mutation - insertBeforeNode not a child of parent. happens\n    // when mutation observer for indvidual element fires out of order\n    return;\n  }\n\n  value.parentNode.insertBefore(el, value.insertBeforeNode);\n};\n\nfunction getElementPositionRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.position) {\n    elementRecord.position = createElementPropertyRecord(element, 'position', getElementPosition, setElementPosition, positionMutationRunner);\n  }\n\n  return elementRecord.position;\n}\n\nvar setClassValue = function setClassValue(el, val) {\n  return val ? el.className = val : el.removeAttribute('class');\n};\n\nvar getClassValue = function getClassValue(el) {\n  return el.className;\n};\n\nfunction getElementClassRecord(el) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.classes) {\n    elementRecord.classes = createElementPropertyRecord(el, 'class', getClassValue, setClassValue, classMutationRunner);\n  }\n\n  return elementRecord.classes;\n}\n\nvar getAttrValue = function getAttrValue(attrName) {\n  return function (el) {\n    var _el$getAttribute;\n\n    return (_el$getAttribute = el.getAttribute(attrName)) != null ? _el$getAttribute : null;\n  };\n};\n\nvar setAttrValue = function setAttrValue(attrName) {\n  return function (el, val) {\n    return val !== null ? el.setAttribute(attrName, val) : el.removeAttribute(attrName);\n  };\n};\n\nfunction getElementAttributeRecord(el, attr) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.attributes[attr]) {\n    elementRecord.attributes[attr] = createElementPropertyRecord(el, attr, getAttrValue(attr), setAttrValue(attr), attrMutationRunner);\n  }\n\n  return elementRecord.attributes[attr];\n}\n\nfunction deleteElementPropertyRecord(el, attr) {\n  var element = elements.get(el);\n  if (!element) return;\n\n  if (attr === 'html') {\n    var _element$html, _element$html$observe;\n\n    (_element$html = element.html) == null ? void 0 : (_element$html$observe = _element$html.observer) == null ? void 0 : _element$html$observe.disconnect();\n    delete element.html;\n  } else if (attr === 'class') {\n    var _element$classes, _element$classes$obse;\n\n    (_element$classes = element.classes) == null ? void 0 : (_element$classes$obse = _element$classes.observer) == null ? void 0 : _element$classes$obse.disconnect();\n    delete element.classes;\n  } else if (attr === 'position') {\n    var _element$position, _element$position$obs;\n\n    (_element$position = element.position) == null ? void 0 : (_element$position$obs = _element$position.observer) == null ? void 0 : _element$position$obs.disconnect();\n    delete element.position;\n  } else {\n    var _element$attributes, _element$attributes$a, _element$attributes$a2;\n\n    (_element$attributes = element.attributes) == null ? void 0 : (_element$attributes$a = _element$attributes[attr]) == null ? void 0 : (_element$attributes$a2 = _element$attributes$a.observer) == null ? void 0 : _element$attributes$a2.disconnect();\n    delete element.attributes[attr];\n  }\n}\n\nvar transformContainer;\n\nfunction getTransformedHTML(html) {\n  if (!transformContainer) {\n    transformContainer = document.createElement('div');\n  }\n\n  transformContainer.innerHTML = html;\n  return transformContainer.innerHTML;\n}\n\nfunction setPropertyValue(el, attr, m) {\n  if (!m.isDirty) return;\n  m.isDirty = false;\n  var val = m.virtualValue;\n\n  if (!m.mutations.length) {\n    deleteElementPropertyRecord(el, attr);\n  }\n\n  m.setValue(el, val);\n}\n\nfunction setValue(m, el) {\n  m.html && setPropertyValue(el, 'html', m.html);\n  m.classes && setPropertyValue(el, 'class', m.classes);\n  m.position && setPropertyValue(el, 'position', m.position);\n  Object.keys(m.attributes).forEach(function (attr) {\n    setPropertyValue(el, attr, m.attributes[attr]);\n  });\n}\n\nfunction runDOMUpdates() {\n  elements.forEach(setValue);\n} // find or create ElementPropertyRecord, add mutation to it, then run\n\n\nfunction startMutating(mutation, element) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(element);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(element);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(element, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(element);\n  }\n\n  if (!record) return;\n  record.mutations.push(mutation);\n  record.mutationRunner(record);\n} // get (existing) ElementPropertyRecord, remove mutation from it, then run\n\n\nfunction stopMutating(mutation, el) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(el);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(el);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(el, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(el);\n  }\n\n  if (!record) return;\n  var index = record.mutations.indexOf(mutation);\n  if (index !== -1) record.mutations.splice(index, 1);\n  record.mutationRunner(record);\n} // maintain list of elements associated with mutation\n\n\nfunction refreshElementsSet(mutation) {\n  // if a position mutation has already found an element to move, don't move\n  // any more elements\n  if (mutation.kind === 'position' && mutation.elements.size === 1) return;\n  var existingElements = new Set(mutation.elements);\n  var matchingElements = document.querySelectorAll(mutation.selector);\n  matchingElements.forEach(function (el) {\n    if (!existingElements.has(el)) {\n      mutation.elements.add(el);\n      startMutating(mutation, el);\n    }\n  });\n}\n\nfunction revertMutation(mutation) {\n  mutation.elements.forEach(function (el) {\n    return stopMutating(mutation, el);\n  });\n  mutation.elements.clear();\n  mutations[\"delete\"](mutation);\n}\n\nfunction refreshAllElementSets() {\n  mutations.forEach(refreshElementsSet);\n} // Observer for elements that don't exist in the DOM yet\n\n\nvar observer;\nfunction disconnectGlobalObserver() {\n  observer && observer.disconnect();\n}\nfunction connectGlobalObserver() {\n  if (typeof document === 'undefined') return;\n\n  if (!observer) {\n    observer = new MutationObserver(function () {\n      refreshAllElementSets();\n    });\n  }\n\n  refreshAllElementSets();\n  observer.observe(document.documentElement, {\n    childList: true,\n    subtree: true,\n    attributes: false,\n    characterData: false\n  });\n} // run on init\n\nconnectGlobalObserver();\n\nfunction newMutation(m) {\n  // Not in a browser\n  if (typeof document === 'undefined') return nullController; // add to global index of mutations\n\n  mutations.add(m); // run refresh on init to establish list of elements associated w/ mutation\n\n  refreshElementsSet(m);\n  return {\n    revert: function revert() {\n      revertMutation(m);\n    }\n  };\n}\n\nfunction html(selector, mutate) {\n  return newMutation({\n    kind: 'html',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction position(selector, mutate) {\n  return newMutation({\n    kind: 'position',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction classes(selector, mutate) {\n  return newMutation({\n    kind: 'class',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction attribute(selector, attribute, mutate) {\n  if (!validAttributeName.test(attribute)) return nullController;\n\n  if (attribute === 'class' || attribute === 'className') {\n    return classes(selector, function (classnames) {\n      var mutatedClassnames = mutate(Array.from(classnames).join(' '));\n      classnames.clear();\n      if (!mutatedClassnames) return;\n      mutatedClassnames.split(/\\s+/g).filter(Boolean).forEach(function (c) {\n        return classnames.add(c);\n      });\n    });\n  }\n\n  return newMutation({\n    kind: 'attribute',\n    attribute: attribute,\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction declarative(_ref2) {\n  var selector = _ref2.selector,\n      action = _ref2.action,\n      value = _ref2.value,\n      attr = _ref2.attribute,\n      parentSelector = _ref2.parentSelector,\n      insertBeforeSelector = _ref2.insertBeforeSelector;\n\n  if (attr === 'html') {\n    if (action === 'append') {\n      return html(selector, function (val) {\n        return val + (value != null ? value : '');\n      });\n    } else if (action === 'set') {\n      return html(selector, function () {\n        return value != null ? value : '';\n      });\n    }\n  } else if (attr === 'class') {\n    if (action === 'append') {\n      return classes(selector, function (val) {\n        if (value) val.add(value);\n      });\n    } else if (action === 'remove') {\n      return classes(selector, function (val) {\n        if (value) val[\"delete\"](value);\n      });\n    } else if (action === 'set') {\n      return classes(selector, function (val) {\n        val.clear();\n        if (value) val.add(value);\n      });\n    }\n  } else if (attr === 'position') {\n    if (action === 'set' && parentSelector) {\n      return position(selector, function () {\n        return {\n          insertBeforeSelector: insertBeforeSelector,\n          parentSelector: parentSelector\n        };\n      });\n    }\n  } else {\n    if (action === 'append') {\n      return attribute(selector, attr, function (val) {\n        return val !== null ? val + (value != null ? value : '') : value != null ? value : '';\n      });\n    } else if (action === 'set') {\n      return attribute(selector, attr, function () {\n        return value != null ? value : '';\n      });\n    } else if (action === 'remove') {\n      return attribute(selector, attr, function () {\n        return null;\n      });\n    }\n  }\n\n  return nullController;\n}\n\nvar index = {\n  html: html,\n  classes: classes,\n  attribute: attribute,\n  position: position,\n  declarative: declarative\n};\n\nexport default index;\nexport { connectGlobalObserver, disconnectGlobalObserver, validAttributeName };\n//# sourceMappingURL=dom-mutator.esm.js.map\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n\nimport {\n  ConditionInterface,\n  TestedObj,\n  ConditionValue,\n  Operator,\n  OperatorConditionValue,\n  VarType,\n} from \"./types/mongrule\";\nimport { paddedVersionString } from \"./util\";\n\nconst _regexCache: { [key: string]: RegExp } = {};\n\n// The top-level condition evaluation function\nexport function evalCondition(\n  obj: TestedObj,\n  condition: ConditionInterface\n): boolean {\n  // Condition is an object, keys are either specific operators or object paths\n  // values are either arguments for operators or conditions for paths\n  for (const [k, v] of Object.entries(condition)) {\n    switch (k) {\n      case \"$or\":\n        if (!evalOr(obj, v as ConditionInterface[])) return false;\n        break;\n      case \"$nor\":\n        if (evalOr(obj, v as ConditionInterface[])) return false;\n        break;\n      case \"$and\":\n        if (!evalAnd(obj, v as ConditionInterface[])) return false;\n        break;\n      case \"$not\":\n        if (evalCondition(obj, v as ConditionInterface)) return false;\n        break;\n      default:\n        if (!evalConditionValue(v, getPath(obj, k))) return false;\n    }\n  }\n  return true;\n}\n\n// Return value at dot-separated path of an object\nfunction getPath(obj: TestedObj, path: string) {\n  const parts = path.split(\".\");\n  let current: any = obj;\n  for (let i = 0; i < parts.length; i++) {\n    if (current && typeof current === \"object\" && parts[i] in current) {\n      current = current[parts[i]];\n    } else {\n      return null;\n    }\n  }\n  return current;\n}\n\n// Transform a regex string into a real RegExp object\nfunction getRegex(regex: string): RegExp {\n  if (!_regexCache[regex]) {\n    _regexCache[regex] = new RegExp(regex.replace(/([^\\\\])\\//g, \"$1\\\\/\"));\n  }\n  return _regexCache[regex];\n}\n\n// Evaluate a single value against a condition\nfunction evalConditionValue(condition: ConditionValue, value: any) {\n  // Simple equality comparisons\n  if (typeof condition === \"string\") {\n    return value + \"\" === condition;\n  }\n  if (typeof condition === \"number\") {\n    return value * 1 === condition;\n  }\n  if (typeof condition === \"boolean\") {\n    return !!value === condition;\n  }\n\n  if (condition === null) {\n    return value === null;\n  }\n\n  if (Array.isArray(condition) || !isOperatorObject(condition)) {\n    return JSON.stringify(value) === JSON.stringify(condition);\n  }\n\n  // This is a special operator condition and we should evaluate each one separately\n  for (const op in condition) {\n    if (\n      !evalOperatorCondition(\n        op as Operator,\n        value,\n        condition[op as keyof OperatorConditionValue]\n      )\n    ) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// If the object has only keys that start with '$'\nfunction isOperatorObject(obj: any): boolean {\n  const keys = Object.keys(obj);\n  return (\n    keys.length > 0 && keys.filter((k) => k[0] === \"$\").length === keys.length\n  );\n}\n\n// Return the data type of a value\nfunction getType(v: any): VarType | \"unknown\" {\n  if (v === null) return \"null\";\n  if (Array.isArray(v)) return \"array\";\n  const t = typeof v;\n  if ([\"string\", \"number\", \"boolean\", \"object\", \"undefined\"].includes(t)) {\n    return t as VarType;\n  }\n  return \"unknown\";\n}\n\n// At least one element of actual must match the expected condition/value\nfunction elemMatch(actual: any, expected: any) {\n  if (!Array.isArray(actual)) return false;\n  const check = isOperatorObject(expected)\n    ? (v: any) => evalConditionValue(expected, v)\n    : (v: any) => evalCondition(v, expected);\n  for (let i = 0; i < actual.length; i++) {\n    if (actual[i] && check(actual[i])) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction isIn(actual: any, expected: Array<any>): boolean {\n  // Do an intersection is attribute is an array\n  if (Array.isArray(actual)) {\n    return actual.some((el) => expected.includes(el));\n  }\n  return expected.includes(actual);\n}\n\n// Evaluate a single operator condition\nfunction evalOperatorCondition(\n  operator: Operator,\n  actual: any,\n  expected: any\n): boolean {\n  switch (operator) {\n    case \"$veq\":\n      return paddedVersionString(actual) === paddedVersionString(expected);\n    case \"$vne\":\n      return paddedVersionString(actual) !== paddedVersionString(expected);\n    case \"$vgt\":\n      return paddedVersionString(actual) > paddedVersionString(expected);\n    case \"$vgte\":\n      return paddedVersionString(actual) >= paddedVersionString(expected);\n    case \"$vlt\":\n      return paddedVersionString(actual) < paddedVersionString(expected);\n    case \"$vlte\":\n      return paddedVersionString(actual) <= paddedVersionString(expected);\n    case \"$eq\":\n      return actual === expected;\n    case \"$ne\":\n      return actual !== expected;\n    case \"$lt\":\n      return actual < expected;\n    case \"$lte\":\n      return actual <= expected;\n    case \"$gt\":\n      return actual > expected;\n    case \"$gte\":\n      return actual >= expected;\n    case \"$exists\":\n      // Using `!=` and `==` instead of strict checks so it also matches for undefined\n      return expected ? actual != null : actual == null;\n    case \"$in\":\n      if (!Array.isArray(expected)) return false;\n      return isIn(actual, expected);\n    case \"$nin\":\n      if (!Array.isArray(expected)) return false;\n      return !isIn(actual, expected);\n    case \"$not\":\n      return !evalConditionValue(expected, actual);\n    case \"$size\":\n      if (!Array.isArray(actual)) return false;\n      return evalConditionValue(expected, actual.length);\n    case \"$elemMatch\":\n      return elemMatch(actual, expected);\n    case \"$all\":\n      if (!Array.isArray(actual)) return false;\n      for (let i = 0; i < expected.length; i++) {\n        let passed = false;\n        for (let j = 0; j < actual.length; j++) {\n          if (evalConditionValue(expected[i], actual[j])) {\n            passed = true;\n            break;\n          }\n        }\n        if (!passed) return false;\n      }\n      return true;\n    case \"$regex\":\n      try {\n        return getRegex(expected).test(actual);\n      } catch (e) {\n        return false;\n      }\n    case \"$type\":\n      return getType(actual) === expected;\n    default:\n      console.error(\"Unknown operator: \" + operator);\n      return false;\n  }\n}\n\n// Recursive $or rule\nfunction evalOr(obj: TestedObj, conditions: ConditionInterface[]): boolean {\n  if (!conditions.length) return true;\n  for (let i = 0; i < conditions.length; i++) {\n    if (evalCondition(obj, conditions[i])) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Recursive $and rule\nfunction evalAnd(obj: TestedObj, conditions: ConditionInterface[]): boolean {\n  for (let i = 0; i < conditions.length; i++) {\n    if (!evalCondition(obj, conditions[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n","import mutate, { DeclarativeMutation } from \"dom-mutator\";\nimport type {\n  ApiHost,\n  Attributes,\n  AutoExperiment,\n  AutoExperimentVariation,\n  ClientKey,\n  Context,\n  Experiment,\n  FeatureApiResponse,\n  FeatureDefinition,\n  FeatureResult,\n  FeatureResultSource,\n  Filter,\n  LoadFeaturesOptions,\n  RealtimeUsageData,\n  RefreshFeaturesOptions,\n  RenderFunction,\n  Result,\n  StickyAssignments,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n  StickyExperimentKey,\n  SubscriptionFunction,\n  TrackingCallback,\n  TrackingData,\n  VariationMeta,\n  VariationRange,\n  WidenPrimitives,\n  FeatureEvalContext,\n  InitOptions,\n  InitResponse,\n  InitSyncOptions,\n  PrefetchOptions,\n} from \"./types/growthbook\";\nimport type { ConditionInterface } from \"./types/mongrule\";\nimport {\n  chooseVariation,\n  decrypt,\n  getAutoExperimentChangeType,\n  getBucketRanges,\n  getQueryStringOverride,\n  getUrlRegExp,\n  hash,\n  inNamespace,\n  inRange,\n  isIncluded,\n  isURLTargeted,\n  loadSDKVersion,\n  mergeQueryStrings,\n  toString,\n} from \"./util\";\nimport { evalCondition } from \"./mongrule\";\nimport {\n  refreshFeatures,\n  startAutoRefresh,\n  subscribe,\n  unsubscribe,\n} from \"./feature-repository\";\n\nconst isBrowser =\n  typeof window !== \"undefined\" && typeof document !== \"undefined\";\n\nconst SDK_VERSION = loadSDKVersion();\n\nexport class GrowthBook<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>\n> {\n  // context is technically private, but some tools depend on it so we can't mangle the name\n  // _ctx below is a clone of this property that we use internally\n  private context: Context;\n  public debug: boolean;\n  public ready: boolean;\n  public version: string;\n\n  // Properties and methods that start with \"_\" are mangled by Terser (saves ~150 bytes)\n  private _ctx: Context;\n  private _renderer: null | RenderFunction;\n  private _redirectedUrl: string;\n  private _trackedExperiments: Set<string>;\n  private _completedChangeIds: Set<string>;\n  private _trackedFeatures: Record<string, string>;\n  private _subscriptions: Set<SubscriptionFunction>;\n  private _rtQueue: RealtimeUsageData[];\n  private _rtTimer: number;\n  private _assigned: Map<\n    string,\n    {\n      // eslint-disable-next-line\n      experiment: Experiment<any>;\n      // eslint-disable-next-line\n      result: Result<any>;\n    }\n  >;\n  // eslint-disable-next-line\n  private _forcedFeatureValues: Map<string, any>;\n  private _attributeOverrides: Attributes;\n  private _activeAutoExperiments: Map<\n    AutoExperiment,\n    { valueHash: string; undo: () => void }\n  >;\n  private _triggeredExpKeys: Set<string>;\n  private _initialized: boolean;\n  private _deferredTrackingCalls: Map<string, TrackingData>;\n\n  private _payload: FeatureApiResponse | undefined;\n  private _decryptedPayload: FeatureApiResponse | undefined;\n\n  private _autoExperimentsAllowed: boolean;\n\n  constructor(context?: Context) {\n    context = context || {};\n    // These properties are all initialized in the constructor instead of above\n    // This saves ~80 bytes in the final output\n    this.version = SDK_VERSION;\n    this._ctx = this.context = context;\n    this._renderer = context.renderer || null;\n    this._trackedExperiments = new Set();\n    this._completedChangeIds = new Set();\n    this._trackedFeatures = {};\n    this.debug = !!context.debug;\n    this._subscriptions = new Set();\n    this._rtQueue = [];\n    this._rtTimer = 0;\n    this.ready = false;\n    this._assigned = new Map();\n    this._forcedFeatureValues = new Map();\n    this._attributeOverrides = {};\n    this._activeAutoExperiments = new Map();\n    this._triggeredExpKeys = new Set();\n    this._initialized = false;\n    this._redirectedUrl = \"\";\n    this._deferredTrackingCalls = new Map();\n    this._autoExperimentsAllowed = !context.disableExperimentsOnLoad;\n\n    if (context.remoteEval) {\n      if (context.decryptionKey) {\n        throw new Error(\"Encryption is not available for remoteEval\");\n      }\n      if (!context.clientKey) {\n        throw new Error(\"Missing clientKey\");\n      }\n      let isGbHost = false;\n      try {\n        isGbHost = !!new URL(context.apiHost || \"\").hostname.match(\n          /growthbook\\.io$/i\n        );\n      } catch (e) {\n        // ignore invalid URLs\n      }\n      if (isGbHost) {\n        throw new Error(\"Cannot use remoteEval on GrowthBook Cloud\");\n      }\n    } else {\n      if (context.cacheKeyAttributes) {\n        throw new Error(\"cacheKeyAttributes are only used for remoteEval\");\n      }\n    }\n\n    if (context.features) {\n      this.ready = true;\n    }\n\n    if (isBrowser && context.enableDevMode) {\n      window._growthbook = this;\n      document.dispatchEvent(new Event(\"gbloaded\"));\n    }\n\n    if (context.experiments) {\n      this.ready = true;\n      this._updateAllAutoExperiments();\n    } else if (context.antiFlicker) {\n      this._setAntiFlicker();\n    }\n\n    // Hydrate sticky bucket service\n    if (this._ctx.stickyBucketService && this._ctx.stickyBucketAssignmentDocs) {\n      for (const key in this._ctx.stickyBucketAssignmentDocs) {\n        const doc = this._ctx.stickyBucketAssignmentDocs[key];\n        if (doc) {\n          this._ctx.stickyBucketService.saveAssignments(doc).catch(() => {\n            // Ignore hydration errors\n          });\n        }\n      }\n    }\n\n    // Legacy - passing in features/experiments into the constructor instead of using init\n    if (this.ready) {\n      this.refreshStickyBuckets(this.getPayload());\n    }\n  }\n\n  public async setPayload(payload: FeatureApiResponse): Promise<void> {\n    this._payload = payload;\n    const data = await this.decryptPayload(payload);\n    this._decryptedPayload = data;\n    await this.refreshStickyBuckets(data);\n    if (data.features) {\n      this._ctx.features = data.features;\n    }\n    if (data.experiments) {\n      this._ctx.experiments = data.experiments;\n      this._updateAllAutoExperiments();\n    }\n    this.ready = true;\n    this._render();\n  }\n\n  public initSync(options: InitSyncOptions): GrowthBook {\n    this._initialized = true;\n\n    const payload = options.payload;\n\n    if (payload.encryptedExperiments || payload.encryptedFeatures) {\n      throw new Error(\"initSync does not support encrypted payloads\");\n    }\n\n    if (\n      this._ctx.stickyBucketService &&\n      !this._ctx.stickyBucketAssignmentDocs\n    ) {\n      throw new Error(\n        \"initSync requires you to pass stickyBucketAssignmentDocs into the GrowthBook constructor\"\n      );\n    }\n\n    this._payload = payload;\n    this._decryptedPayload = payload;\n    if (payload.features) {\n      this._ctx.features = payload.features;\n    }\n    if (payload.experiments) {\n      this._ctx.experiments = payload.experiments;\n      this._updateAllAutoExperiments();\n    }\n\n    this.ready = true;\n\n    if (options.streaming) {\n      if (!this._ctx.clientKey) {\n        throw new Error(\"Must specify clientKey to enable streaming\");\n      }\n      startAutoRefresh(this, true);\n      subscribe(this);\n    }\n\n    return this;\n  }\n\n  public async init(options?: InitOptions): Promise<InitResponse> {\n    this._initialized = true;\n\n    options = options || {};\n    if (options.payload) {\n      await this.setPayload(options.payload);\n      if (options.streaming) {\n        if (!this._ctx.clientKey) {\n          throw new Error(\"Must specify clientKey to enable streaming\");\n        }\n        startAutoRefresh(this, true);\n        subscribe(this);\n      }\n\n      return {\n        success: true,\n        source: \"init\",\n      };\n    } else {\n      const { data, ...res } = await this._refresh({\n        ...options,\n        allowStale: true,\n      });\n      if (options.streaming) {\n        subscribe(this);\n      }\n\n      await this.setPayload(data || {});\n      return res;\n    }\n  }\n\n  /** @deprecated Use {@link init} */\n  public async loadFeatures(options?: LoadFeaturesOptions): Promise<void> {\n    this._initialized = true;\n\n    options = options || {};\n    if (options.autoRefresh) {\n      // interpret deprecated autoRefresh option as subscribeToChanges\n      this._ctx.subscribeToChanges = true;\n    }\n    const { data } = await this._refresh({\n      ...options,\n      allowStale: true,\n    });\n    await this.setPayload(data || {});\n\n    if (this._canSubscribe()) {\n      subscribe(this);\n    }\n  }\n\n  public async refreshFeatures(\n    options?: RefreshFeaturesOptions\n  ): Promise<void> {\n    const res = await this._refresh({\n      ...(options || {}),\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return [this.getApiHosts().apiHost, this.getClientKey()];\n  }\n  public getApiHosts(): {\n    apiHost: string;\n    streamingHost: string;\n    apiRequestHeaders?: Record<string, string>;\n    streamingHostRequestHeaders?: Record<string, string>;\n  } {\n    const defaultHost = this._ctx.apiHost || \"https://cdn.growthbook.io\";\n    return {\n      apiHost: defaultHost.replace(/\\/*$/, \"\"),\n      streamingHost: (this._ctx.streamingHost || defaultHost).replace(\n        /\\/*$/,\n        \"\"\n      ),\n      apiRequestHeaders: this._ctx.apiHostRequestHeaders,\n      streamingHostRequestHeaders: this._ctx.streamingHostRequestHeaders,\n    };\n  }\n  public getClientKey(): string {\n    return this._ctx.clientKey || \"\";\n  }\n  public getPayload(): FeatureApiResponse {\n    return (\n      this._payload || {\n        features: this.getFeatures(),\n        experiments: this.getExperiments(),\n      }\n    );\n  }\n  public getDecryptedPayload(): FeatureApiResponse {\n    return this._decryptedPayload || this.getPayload();\n  }\n\n  public isRemoteEval(): boolean {\n    return this._ctx.remoteEval || false;\n  }\n\n  public getCacheKeyAttributes(): (keyof Attributes)[] | undefined {\n    return this._ctx.cacheKeyAttributes;\n  }\n\n  private async _refresh({\n    timeout,\n    skipCache,\n    allowStale,\n    streaming,\n  }: RefreshFeaturesOptions & {\n    allowStale?: boolean;\n    streaming?: boolean;\n  }) {\n    if (!this._ctx.clientKey) {\n      throw new Error(\"Missing clientKey\");\n    }\n    // Trigger refresh in feature repository\n    return refreshFeatures({\n      instance: this,\n      timeout,\n      skipCache: skipCache || this._ctx.disableCache,\n      allowStale,\n      backgroundSync: streaming ?? this._ctx.backgroundSync ?? true,\n    });\n  }\n\n  private _render() {\n    if (this._renderer) {\n      try {\n        this._renderer();\n      } catch (e) {\n        console.error(\"Failed to render\", e);\n      }\n    }\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setFeatures(features: Record<string, FeatureDefinition>) {\n    this._ctx.features = features;\n    this.ready = true;\n    this._render();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedFeatures(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const featuresJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._ctx.decryptionKey,\n      subtle\n    );\n    this.setFeatures(\n      JSON.parse(featuresJSON) as Record<string, FeatureDefinition>\n    );\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setExperiments(experiments: AutoExperiment[]): void {\n    this._ctx.experiments = experiments;\n    this.ready = true;\n    this._updateAllAutoExperiments();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedExperiments(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const experimentsJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._ctx.decryptionKey,\n      subtle\n    );\n    this.setExperiments(JSON.parse(experimentsJSON) as AutoExperiment[]);\n  }\n\n  public async decryptPayload(\n    data: FeatureApiResponse,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<FeatureApiResponse> {\n    data = { ...data };\n    if (data.encryptedFeatures) {\n      data.features = JSON.parse(\n        await decrypt(\n          data.encryptedFeatures,\n          decryptionKey || this._ctx.decryptionKey,\n          subtle\n        )\n      );\n      delete data.encryptedFeatures;\n    }\n    if (data.encryptedExperiments) {\n      data.experiments = JSON.parse(\n        await decrypt(\n          data.encryptedExperiments,\n          decryptionKey || this._ctx.decryptionKey,\n          subtle\n        )\n      );\n      delete data.encryptedExperiments;\n    }\n    return data;\n  }\n\n  public async setAttributes(attributes: Attributes) {\n    this._ctx.attributes = attributes;\n    if (this._ctx.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._ctx.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async updateAttributes(attributes: Attributes) {\n    return this.setAttributes({ ...this._ctx.attributes, ...attributes });\n  }\n\n  public async setAttributeOverrides(overrides: Attributes) {\n    this._attributeOverrides = overrides;\n    if (this._ctx.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._ctx.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async setForcedVariations(vars: Record<string, number>) {\n    this._ctx.forcedVariations = vars || {};\n    if (this._ctx.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  // eslint-disable-next-line\n  public setForcedFeatures(map: Map<string, any>) {\n    this._forcedFeatureValues = map;\n    this._render();\n  }\n\n  public async setURL(url: string) {\n    this._ctx.url = url;\n    this._redirectedUrl = \"\";\n    if (this._ctx.remoteEval) {\n      await this._refreshForRemoteEval();\n      this._updateAllAutoExperiments(true);\n      return;\n    }\n    this._updateAllAutoExperiments(true);\n  }\n\n  public getAttributes() {\n    return { ...this._ctx.attributes, ...this._attributeOverrides };\n  }\n\n  public getForcedVariations() {\n    return this._ctx.forcedVariations || {};\n  }\n\n  public getForcedFeatures() {\n    // eslint-disable-next-line\n    return this._forcedFeatureValues || new Map<string, any>();\n  }\n\n  public getStickyBucketAssignmentDocs() {\n    return this._ctx.stickyBucketAssignmentDocs || {};\n  }\n\n  public getUrl() {\n    return this._ctx.url || \"\";\n  }\n\n  public getFeatures() {\n    return this._ctx.features || {};\n  }\n\n  public getExperiments() {\n    return this._ctx.experiments || [];\n  }\n\n  public getCompletedChangeIds(): string[] {\n    return Array.from(this._completedChangeIds);\n  }\n\n  public subscribe(cb: SubscriptionFunction): () => void {\n    this._subscriptions.add(cb);\n    return () => {\n      this._subscriptions.delete(cb);\n    };\n  }\n\n  private _canSubscribe() {\n    return (this._ctx.backgroundSync ?? true) && this._ctx.subscribeToChanges;\n  }\n\n  private async _refreshForRemoteEval() {\n    if (!this._ctx.remoteEval) return;\n    if (!this._initialized) return;\n    const res = await this._refresh({\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getAllResults() {\n    return new Map(this._assigned);\n  }\n\n  public destroy() {\n    // Release references to save memory\n    this._subscriptions.clear();\n    this._assigned.clear();\n    this._trackedExperiments.clear();\n    this._completedChangeIds.clear();\n    this._deferredTrackingCalls.clear();\n    this._trackedFeatures = {};\n    this._rtQueue = [];\n    this._payload = undefined;\n    if (this._rtTimer) {\n      clearTimeout(this._rtTimer);\n    }\n    unsubscribe(this);\n\n    if (isBrowser && window._growthbook === this) {\n      delete window._growthbook;\n    }\n\n    // Undo any active auto experiments\n    this._activeAutoExperiments.forEach((exp) => {\n      exp.undo();\n    });\n    this._activeAutoExperiments.clear();\n    this._triggeredExpKeys.clear();\n  }\n\n  public setRenderer(renderer: null | RenderFunction) {\n    this._renderer = renderer;\n  }\n\n  public forceVariation(key: string, variation: number) {\n    this._ctx.forcedVariations = this._ctx.forcedVariations || {};\n    this._ctx.forcedVariations[key] = variation;\n    if (this._ctx.remoteEval) {\n      this._refreshForRemoteEval();\n      return;\n    }\n    this._updateAllAutoExperiments();\n    this._render();\n  }\n\n  public run<T>(experiment: Experiment<T>): Result<T> {\n    const result = this._run(experiment, null);\n    this._fireSubscriptions(experiment, result);\n    return result;\n  }\n\n  public triggerExperiment(key: string) {\n    this._triggeredExpKeys.add(key);\n    if (!this._ctx.experiments) return null;\n    const experiments = this._ctx.experiments.filter((exp) => exp.key === key);\n    return experiments\n      .map((exp) => {\n        return this._runAutoExperiment(exp);\n      })\n      .filter((res) => res !== null);\n  }\n\n  public triggerAutoExperiments() {\n    this._autoExperimentsAllowed = true;\n    this._updateAllAutoExperiments(true);\n  }\n\n  private _runAutoExperiment(experiment: AutoExperiment, forceRerun?: boolean) {\n    const existing = this._activeAutoExperiments.get(experiment);\n\n    // If this is a manual experiment and it's not already running, skip\n    if (\n      experiment.manual &&\n      !this._triggeredExpKeys.has(experiment.key) &&\n      !existing\n    )\n      return null;\n\n    // Check if this particular experiment is blocked by context settings\n    // For example, if all visualEditor experiments are disabled\n    const isBlocked = this._isAutoExperimentBlockedByContext(experiment);\n    if (isBlocked) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Auto experiment blocked\", { id: experiment.key });\n    }\n\n    // Run the experiment (if blocked exclude)\n    const result = isBlocked\n      ? this._getResult(experiment, -1, false, \"\")\n      : this.run(experiment);\n\n    // A hash to quickly tell if the assigned value changed\n    const valueHash = JSON.stringify(result.value);\n\n    // If the changes are already active, no need to re-apply them\n    if (\n      !forceRerun &&\n      result.inExperiment &&\n      existing &&\n      existing.valueHash === valueHash\n    ) {\n      return result;\n    }\n\n    // Undo any existing changes\n    if (existing) this._undoActiveAutoExperiment(experiment);\n\n    // Apply new changes\n    if (result.inExperiment) {\n      const changeType = getAutoExperimentChangeType(experiment);\n\n      if (\n        changeType === \"redirect\" &&\n        result.value.urlRedirect &&\n        experiment.urlPatterns\n      ) {\n        const url = experiment.persistQueryString\n          ? mergeQueryStrings(this._getContextUrl(), result.value.urlRedirect)\n          : result.value.urlRedirect;\n\n        if (isURLTargeted(url, experiment.urlPatterns)) {\n          this.log(\n            \"Skipping redirect because original URL matches redirect URL\",\n            {\n              id: experiment.key,\n            }\n          );\n          return result;\n        }\n        this._redirectedUrl = url;\n        const navigate = this._getNavigateFunction();\n        if (navigate) {\n          if (isBrowser) {\n            this._setAntiFlicker();\n            window.setTimeout(() => {\n              try {\n                navigate(url);\n              } catch (e) {\n                console.error(e);\n              }\n            }, this._ctx.navigateDelay ?? 100);\n          } else {\n            try {\n              navigate(url);\n            } catch (e) {\n              console.error(e);\n            }\n          }\n        }\n      } else if (changeType === \"visual\") {\n        const undo = this._ctx.applyDomChangesCallback\n          ? this._ctx.applyDomChangesCallback(result.value)\n          : this._applyDOMChanges(result.value);\n        if (undo) {\n          this._activeAutoExperiments.set(experiment, {\n            undo,\n            valueHash,\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  private _undoActiveAutoExperiment(exp: AutoExperiment) {\n    const data = this._activeAutoExperiments.get(exp);\n    if (data) {\n      data.undo();\n      this._activeAutoExperiments.delete(exp);\n    }\n  }\n\n  private _updateAllAutoExperiments(forceRerun?: boolean) {\n    if (!this._autoExperimentsAllowed) return;\n\n    const experiments = this._ctx.experiments || [];\n\n    // Stop any experiments that are no longer defined\n    const keys = new Set(experiments);\n    this._activeAutoExperiments.forEach((v, k) => {\n      if (!keys.has(k)) {\n        v.undo();\n        this._activeAutoExperiments.delete(k);\n      }\n    });\n\n    // Re-run all new/updated experiments\n    for (const exp of experiments) {\n      const result = this._runAutoExperiment(exp, forceRerun);\n\n      // Once you're in a redirect experiment, break out of the loop and don't run any further experiments\n      if (\n        result?.inExperiment &&\n        getAutoExperimentChangeType(exp) === \"redirect\"\n      ) {\n        break;\n      }\n    }\n  }\n\n  private _fireSubscriptions<T>(experiment: Experiment<T>, result: Result<T>) {\n    const key = experiment.key;\n\n    // If assigned variation has changed, fire subscriptions\n    const prev = this._assigned.get(key);\n    // TODO: what if the experiment definition has changed?\n    if (\n      !prev ||\n      prev.result.inExperiment !== result.inExperiment ||\n      prev.result.variationId !== result.variationId\n    ) {\n      this._assigned.set(key, { experiment, result });\n      this._subscriptions.forEach((cb) => {\n        try {\n          cb(experiment, result);\n        } catch (e) {\n          console.error(e);\n        }\n      });\n    }\n  }\n\n  private _trackFeatureUsage(key: string, res: FeatureResult): void {\n    // Don't track feature usage that was forced via an override\n    if (res.source === \"override\") return;\n\n    // Only track a feature once, unless the assigned value changed\n    const stringifiedValue = JSON.stringify(res.value);\n    if (this._trackedFeatures[key] === stringifiedValue) return;\n    this._trackedFeatures[key] = stringifiedValue;\n\n    // Fire user-supplied callback\n    if (this._ctx.onFeatureUsage) {\n      try {\n        this._ctx.onFeatureUsage(key, res);\n      } catch (e) {\n        // Ignore feature usage callback errors\n      }\n    }\n\n    // In browser environments, queue up feature usage to be tracked in batches\n    if (!isBrowser || !window.fetch) return;\n    this._rtQueue.push({\n      key,\n      on: res.on,\n    });\n    if (!this._rtTimer) {\n      this._rtTimer = window.setTimeout(() => {\n        // Reset the queue\n        this._rtTimer = 0;\n        const q = [...this._rtQueue];\n        this._rtQueue = [];\n\n        // Skip logging if a real-time usage key is not configured\n        if (!this._ctx.realtimeKey) return;\n\n        window\n          .fetch(\n            `https://rt.growthbook.io/?key=${\n              this._ctx.realtimeKey\n            }&events=${encodeURIComponent(JSON.stringify(q))}`,\n\n            {\n              cache: \"no-cache\",\n              mode: \"no-cors\",\n            }\n          )\n          .catch(() => {\n            // TODO: retry in case of network errors?\n          });\n      }, this._ctx.realtimeInterval || 2000);\n    }\n  }\n\n  private _getFeatureResult<T>(\n    key: string,\n    value: T,\n    source: FeatureResultSource,\n    ruleId?: string,\n    experiment?: Experiment<T>,\n    result?: Result<T>\n  ): FeatureResult<T> {\n    const ret: FeatureResult = {\n      value,\n      on: !!value,\n      off: !value,\n      source,\n      ruleId: ruleId || \"\",\n    };\n    if (experiment) ret.experiment = experiment;\n    if (result) ret.experimentResult = result;\n\n    // Track the usage of this feature in real-time\n    this._trackFeatureUsage(key, ret);\n\n    return ret;\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).on;\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).off;\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(key: K, defaultValue: V): WidenPrimitives<V> {\n    const value = this.evalFeature<WidenPrimitives<V>, K>(key).value;\n    return value === null ? (defaultValue as WidenPrimitives<V>) : value;\n  }\n\n  /**\n   * @deprecated Use {@link evalFeature}\n   * @param id\n   */\n  // eslint-disable-next-line\n  public feature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    return this.evalFeature(id);\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    return this._evalFeature(id);\n  }\n\n  private _evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K, evalCtx?: FeatureEvalContext): FeatureResult<V | null> {\n    evalCtx = evalCtx || { evaluatedFeatures: new Set() };\n\n    if (evalCtx.evaluatedFeatures.has(id)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\n          `evalFeature: circular dependency detected: ${evalCtx.id} -> ${id}`,\n          { from: evalCtx.id, to: id }\n        );\n      return this._getFeatureResult(id, null, \"cyclicPrerequisite\");\n    }\n    evalCtx.evaluatedFeatures.add(id);\n    evalCtx.id = id;\n\n    // Global override\n    if (this._forcedFeatureValues.has(id)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Global override\", {\n          id,\n          value: this._forcedFeatureValues.get(id),\n        });\n      return this._getFeatureResult(\n        id,\n        this._forcedFeatureValues.get(id),\n        \"override\"\n      );\n    }\n\n    // Unknown feature id\n    if (!this._ctx.features || !this._ctx.features[id]) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Unknown feature\", { id });\n      return this._getFeatureResult(id, null, \"unknownFeature\");\n    }\n\n    // Get the feature\n    const feature: FeatureDefinition<V> = this._ctx.features[id];\n\n    // Loop through the rules\n    if (feature.rules) {\n      rules: for (const rule of feature.rules) {\n        // If there are prerequisite flag(s), evaluate them\n        if (rule.parentConditions) {\n          for (const parentCondition of rule.parentConditions) {\n            const parentResult = this._evalFeature(parentCondition.id, evalCtx);\n            // break out for cyclic prerequisites\n            if (parentResult.source === \"cyclicPrerequisite\") {\n              return this._getFeatureResult(id, null, \"cyclicPrerequisite\");\n            }\n\n            const evalObj = { value: parentResult.value };\n            const evaled = evalCondition(\n              evalObj,\n              parentCondition.condition || {}\n            );\n            if (!evaled) {\n              // blocking prerequisite eval failed: feature evaluation fails\n              if (parentCondition.gate) {\n                process.env.NODE_ENV !== \"production\" &&\n                  this.log(\"Feature blocked by prerequisite\", { id, rule });\n                return this._getFeatureResult(id, null, \"prerequisite\");\n              }\n              // non-blocking prerequisite eval failed: break out of parentConditions loop, jump to the next rule\n              process.env.NODE_ENV !== \"production\" &&\n                this.log(\"Skip rule because prerequisite evaluation fails\", {\n                  id,\n                  rule,\n                });\n              continue rules;\n            }\n          }\n        }\n\n        // If there are filters for who is included (e.g. namespaces)\n        if (rule.filters && this._isFilteredOut(rule.filters)) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip rule because of filters\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        // Feature value is being forced\n        if (\"force\" in rule) {\n          // If it's a conditional rule, skip if the condition doesn't pass\n          if (rule.condition && !this._conditionPasses(rule.condition)) {\n            process.env.NODE_ENV !== \"production\" &&\n              this.log(\"Skip rule because of condition ff\", {\n                id,\n                rule,\n              });\n            continue;\n          }\n\n          // If this is a percentage rollout, skip if not included\n          if (\n            !this._isIncludedInRollout(\n              rule.seed || id,\n              rule.hashAttribute,\n              this._ctx.stickyBucketService && !rule.disableStickyBucketing\n                ? rule.fallbackAttribute\n                : undefined,\n              rule.range,\n              rule.coverage,\n              rule.hashVersion\n            )\n          ) {\n            process.env.NODE_ENV !== \"production\" &&\n              this.log(\"Skip rule because user not included in rollout\", {\n                id,\n                rule,\n              });\n            continue;\n          }\n\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Force value from rule\", {\n              id,\n              rule,\n            });\n\n          // If this was a remotely evaluated experiment, fire the tracking callbacks\n          if (rule.tracks) {\n            rule.tracks.forEach((t) => {\n              this._track(t.experiment, t.result);\n            });\n          }\n\n          return this._getFeatureResult(id, rule.force as V, \"force\", rule.id);\n        }\n        if (!rule.variations) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip invalid rule\", {\n              id,\n              rule,\n            });\n\n          continue;\n        }\n\n        // For experiment rules, run an experiment\n        const exp: Experiment<V> = {\n          variations: rule.variations as [V, V, ...V[]],\n          key: rule.key || id,\n        };\n        if (\"coverage\" in rule) exp.coverage = rule.coverage;\n        if (rule.weights) exp.weights = rule.weights;\n        if (rule.hashAttribute) exp.hashAttribute = rule.hashAttribute;\n        if (rule.fallbackAttribute)\n          exp.fallbackAttribute = rule.fallbackAttribute;\n        if (rule.disableStickyBucketing)\n          exp.disableStickyBucketing = rule.disableStickyBucketing;\n        if (rule.bucketVersion !== undefined)\n          exp.bucketVersion = rule.bucketVersion;\n        if (rule.minBucketVersion !== undefined)\n          exp.minBucketVersion = rule.minBucketVersion;\n        if (rule.namespace) exp.namespace = rule.namespace;\n        if (rule.meta) exp.meta = rule.meta;\n        if (rule.ranges) exp.ranges = rule.ranges;\n        if (rule.name) exp.name = rule.name;\n        if (rule.phase) exp.phase = rule.phase;\n        if (rule.seed) exp.seed = rule.seed;\n        if (rule.hashVersion) exp.hashVersion = rule.hashVersion;\n        if (rule.filters) exp.filters = rule.filters;\n        if (rule.condition) exp.condition = rule.condition;\n\n        // Only return a value if the user is part of the experiment\n        const res = this._run(exp, id);\n        this._fireSubscriptions(exp, res);\n        if (res.inExperiment && !res.passthrough) {\n          return this._getFeatureResult(\n            id,\n            res.value,\n            \"experiment\",\n            rule.id,\n            exp,\n            res\n          );\n        }\n      }\n    }\n\n    process.env.NODE_ENV !== \"production\" &&\n      this.log(\"Use default value\", {\n        id,\n        value: feature.defaultValue,\n      });\n\n    // Fall back to using the default value\n    return this._getFeatureResult(\n      id,\n      feature.defaultValue === undefined ? null : feature.defaultValue,\n      \"defaultValue\"\n    );\n  }\n\n  private _isIncludedInRollout(\n    seed: string,\n    hashAttribute: string | undefined,\n    fallbackAttribute: string | undefined,\n    range: VariationRange | undefined,\n    coverage: number | undefined,\n    hashVersion: number | undefined\n  ): boolean {\n    if (!range && coverage === undefined) return true;\n\n    if (!range && coverage === 0) return false;\n\n    const { hashValue } = this._getHashAttribute(\n      hashAttribute,\n      fallbackAttribute\n    );\n    if (!hashValue) {\n      return false;\n    }\n\n    const n = hash(seed, hashValue, hashVersion || 1);\n    if (n === null) return false;\n\n    return range\n      ? inRange(n, range)\n      : coverage !== undefined\n      ? n <= coverage\n      : true;\n  }\n\n  private _conditionPasses(condition: ConditionInterface): boolean {\n    return evalCondition(this.getAttributes(), condition);\n  }\n\n  private _isFilteredOut(filters: Filter[]): boolean {\n    return filters.some((filter) => {\n      const { hashValue } = this._getHashAttribute(filter.attribute);\n      if (!hashValue) return true;\n      const n = hash(filter.seed, hashValue, filter.hashVersion || 2);\n      if (n === null) return true;\n      return !filter.ranges.some((r) => inRange(n, r));\n    });\n  }\n\n  private _run<T>(\n    experiment: Experiment<T>,\n    featureId: string | null\n  ): Result<T> {\n    const key = experiment.key;\n    const numVariations = experiment.variations.length;\n\n    // 1. If experiment has less than 2 variations, return immediately\n    if (numVariations < 2) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Invalid experiment\", { id: key });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 2. If the context is disabled, return immediately\n    if (this._ctx.enabled === false) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Context disabled\", { id: key });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 2.5. Merge in experiment overrides from the context\n    experiment = this._mergeOverrides(experiment);\n\n    // 2.6 New, more powerful URL targeting\n    if (\n      experiment.urlPatterns &&\n      !isURLTargeted(this._getContextUrl(), experiment.urlPatterns)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of url targeting\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 3. If a variation is forced from a querystring, return the forced variation\n    const qsOverride = getQueryStringOverride(\n      key,\n      this._getContextUrl(),\n      numVariations\n    );\n    if (qsOverride !== null) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force via querystring\", {\n          id: key,\n          variation: qsOverride,\n        });\n      return this._getResult(experiment, qsOverride, false, featureId);\n    }\n\n    // 4. If a variation is forced in the context, return the forced variation\n    if (this._ctx.forcedVariations && key in this._ctx.forcedVariations) {\n      const variation = this._ctx.forcedVariations[key];\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force via dev tools\", {\n          id: key,\n          variation,\n        });\n      return this._getResult(experiment, variation, false, featureId);\n    }\n\n    // 5. Exclude if a draft experiment or not active\n    if (experiment.status === \"draft\" || experiment.active === false) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because inactive\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 6. Get the hash attribute and return if empty\n    const { hashAttribute, hashValue } = this._getHashAttribute(\n      experiment.hashAttribute,\n      this._ctx.stickyBucketService && !experiment.disableStickyBucketing\n        ? experiment.fallbackAttribute\n        : undefined\n    );\n    if (!hashValue) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because missing hashAttribute\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    let assigned = -1;\n\n    let foundStickyBucket = false;\n    let stickyBucketVersionIsBlocked = false;\n    if (this._ctx.stickyBucketService && !experiment.disableStickyBucketing) {\n      const { variation, versionIsBlocked } = this._getStickyBucketVariation({\n        expKey: experiment.key,\n        expBucketVersion: experiment.bucketVersion,\n        expHashAttribute: experiment.hashAttribute,\n        expFallbackAttribute: experiment.fallbackAttribute,\n        expMinBucketVersion: experiment.minBucketVersion,\n        expMeta: experiment.meta,\n      });\n      foundStickyBucket = variation >= 0;\n      assigned = variation;\n      stickyBucketVersionIsBlocked = !!versionIsBlocked;\n    }\n\n    // Some checks are not needed if we already have a sticky bucket\n    if (!foundStickyBucket) {\n      // 7. Exclude if user is filtered out (used to be called \"namespace\")\n      if (experiment.filters) {\n        if (this._isFilteredOut(experiment.filters)) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip because of filters\", {\n              id: key,\n            });\n          return this._getResult(experiment, -1, false, featureId);\n        }\n      } else if (\n        experiment.namespace &&\n        !inNamespace(hashValue, experiment.namespace)\n      ) {\n        process.env.NODE_ENV !== \"production\" &&\n          this.log(\"Skip because of namespace\", {\n            id: key,\n          });\n        return this._getResult(experiment, -1, false, featureId);\n      }\n\n      // 7.5. Exclude if experiment.include returns false or throws\n      if (experiment.include && !isIncluded(experiment.include)) {\n        process.env.NODE_ENV !== \"production\" &&\n          this.log(\"Skip because of include function\", {\n            id: key,\n          });\n        return this._getResult(experiment, -1, false, featureId);\n      }\n\n      // 8. Exclude if condition is false\n      if (\n        experiment.condition &&\n        !this._conditionPasses(experiment.condition)\n      ) {\n        process.env.NODE_ENV !== \"production\" &&\n          this.log(\"Skip because of condition exp\", {\n            id: key,\n          });\n        return this._getResult(experiment, -1, false, featureId);\n      }\n\n      // 8.05. Exclude if prerequisites are not met\n      if (experiment.parentConditions) {\n        for (const parentCondition of experiment.parentConditions) {\n          const parentResult = this._evalFeature(parentCondition.id);\n          // break out for cyclic prerequisites\n          if (parentResult.source === \"cyclicPrerequisite\") {\n            return this._getResult(experiment, -1, false, featureId);\n          }\n\n          const evalObj = { value: parentResult.value };\n          if (!evalCondition(evalObj, parentCondition.condition || {})) {\n            process.env.NODE_ENV !== \"production\" &&\n              this.log(\"Skip because prerequisite evaluation fails\", {\n                id: key,\n              });\n            return this._getResult(experiment, -1, false, featureId);\n          }\n        }\n      }\n\n      // 8.1. Exclude if user is not in a required group\n      if (\n        experiment.groups &&\n        !this._hasGroupOverlap(experiment.groups as string[])\n      ) {\n        process.env.NODE_ENV !== \"production\" &&\n          this.log(\"Skip because of groups\", {\n            id: key,\n          });\n        return this._getResult(experiment, -1, false, featureId);\n      }\n    }\n\n    // 8.2. Old style URL targeting\n    if (experiment.url && !this._urlIsValid(experiment.url as RegExp)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of url\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 9. Get the variation from the sticky bucket or get bucket ranges and choose variation\n    const n = hash(\n      experiment.seed || key,\n      hashValue,\n      experiment.hashVersion || 1\n    );\n    if (n === null) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of invalid hash version\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    if (!foundStickyBucket) {\n      const ranges =\n        experiment.ranges ||\n        getBucketRanges(\n          numVariations,\n          experiment.coverage === undefined ? 1 : experiment.coverage,\n          experiment.weights\n        );\n      assigned = chooseVariation(n, ranges);\n    }\n\n    // 9.5 Unenroll if any prior sticky buckets are blocked by version\n    if (stickyBucketVersionIsBlocked) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because sticky bucket version is blocked\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId, undefined, true);\n    }\n\n    // 10. Return if not in experiment\n    if (assigned < 0) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of coverage\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 11. Experiment has a forced variation\n    if (\"force\" in experiment) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force variation\", {\n          id: key,\n          variation: experiment.force,\n        });\n      return this._getResult(\n        experiment,\n        experiment.force === undefined ? -1 : experiment.force,\n        false,\n        featureId\n      );\n    }\n\n    // 12. Exclude if in QA mode\n    if (this._ctx.qaMode) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because QA mode\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 12.5. Exclude if experiment is stopped\n    if (experiment.status === \"stopped\") {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because stopped\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 13. Build the result object\n    const result = this._getResult(\n      experiment,\n      assigned,\n      true,\n      featureId,\n      n,\n      foundStickyBucket\n    );\n\n    // 13.5. Persist sticky bucket\n    if (this._ctx.stickyBucketService && !experiment.disableStickyBucketing) {\n      const {\n        changed,\n        key: attrKey,\n        doc,\n      } = this._generateStickyBucketAssignmentDoc(\n        hashAttribute,\n        toString(hashValue),\n        {\n          [this._getStickyBucketExperimentKey(\n            experiment.key,\n            experiment.bucketVersion\n          )]: result.key,\n        }\n      );\n      if (changed) {\n        // update local docs\n        this._ctx.stickyBucketAssignmentDocs =\n          this._ctx.stickyBucketAssignmentDocs || {};\n        this._ctx.stickyBucketAssignmentDocs[attrKey] = doc;\n        // save doc\n        this._ctx.stickyBucketService.saveAssignments(doc);\n      }\n    }\n\n    // 14. Fire the tracking callback\n    this._track(experiment, result);\n\n    // 14.1 Keep track of completed changeIds\n    \"changeId\" in experiment &&\n      experiment.changeId &&\n      this._completedChangeIds.add(experiment.changeId as string);\n\n    // 15. Return the result\n    process.env.NODE_ENV !== \"production\" &&\n      this.log(\"In experiment\", {\n        id: key,\n        variation: result.variationId,\n      });\n    return result;\n  }\n\n  log(msg: string, ctx: Record<string, unknown>) {\n    if (!this.debug) return;\n    if (this._ctx.log) this._ctx.log(msg, ctx);\n    else console.log(msg, ctx);\n  }\n\n  public getDeferredTrackingCalls(): TrackingData[] {\n    return Array.from(this._deferredTrackingCalls.values());\n  }\n\n  public setDeferredTrackingCalls(calls: TrackingData[]) {\n    this._deferredTrackingCalls = new Map(\n      calls\n        .filter((c) => c && c.experiment && c.result)\n        .map((c) => {\n          return [this._getTrackKey(c.experiment, c.result), c];\n        })\n    );\n  }\n\n  public fireDeferredTrackingCalls() {\n    if (!this._ctx.trackingCallback) return;\n\n    this._deferredTrackingCalls.forEach((call: TrackingData) => {\n      if (!call || !call.experiment || !call.result) {\n        console.error(\"Invalid deferred tracking call\", { call: call });\n      } else {\n        this._track(call.experiment, call.result);\n      }\n    });\n\n    this._deferredTrackingCalls.clear();\n  }\n\n  public setTrackingCallback(callback: TrackingCallback) {\n    this._ctx.trackingCallback = callback;\n    this.fireDeferredTrackingCalls();\n  }\n\n  private _getTrackKey(\n    experiment: Experiment<unknown>,\n    result: Result<unknown>\n  ) {\n    return (\n      result.hashAttribute +\n      result.hashValue +\n      experiment.key +\n      result.variationId\n    );\n  }\n\n  private _track<T>(experiment: Experiment<T>, result: Result<T>) {\n    const k = this._getTrackKey(experiment, result);\n\n    if (!this._ctx.trackingCallback) {\n      // Add to deferred tracking if it hasn't already been added\n      if (!this._deferredTrackingCalls.has(k)) {\n        this._deferredTrackingCalls.set(k, { experiment, result });\n      }\n      return;\n    }\n\n    // Make sure a tracking callback is only fired once per unique experiment\n    if (this._trackedExperiments.has(k)) return;\n    this._trackedExperiments.add(k);\n\n    try {\n      this._ctx.trackingCallback(experiment, result);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  private _mergeOverrides<T>(experiment: Experiment<T>): Experiment<T> {\n    const key = experiment.key;\n    const o = this._ctx.overrides;\n    if (o && o[key]) {\n      experiment = Object.assign({}, experiment, o[key]);\n      if (typeof experiment.url === \"string\") {\n        experiment.url = getUrlRegExp(\n          // eslint-disable-next-line\n          experiment.url as any\n        );\n      }\n    }\n\n    return experiment;\n  }\n\n  private _getHashAttribute(attr?: string, fallback?: string) {\n    let hashAttribute = attr || \"id\";\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    let hashValue: any = \"\";\n\n    if (this._attributeOverrides[hashAttribute]) {\n      hashValue = this._attributeOverrides[hashAttribute];\n    } else if (this._ctx.attributes) {\n      hashValue = this._ctx.attributes[hashAttribute] || \"\";\n    } else if (this._ctx.user) {\n      hashValue = this._ctx.user[hashAttribute] || \"\";\n    }\n\n    // if no match, try fallback\n    if (!hashValue && fallback) {\n      if (this._attributeOverrides[fallback]) {\n        hashValue = this._attributeOverrides[fallback];\n      } else if (this._ctx.attributes) {\n        hashValue = this._ctx.attributes[fallback] || \"\";\n      } else if (this._ctx.user) {\n        hashValue = this._ctx.user[fallback] || \"\";\n      }\n      if (hashValue) {\n        hashAttribute = fallback;\n      }\n    }\n\n    return { hashAttribute, hashValue };\n  }\n\n  private _getResult<T>(\n    experiment: Experiment<T>,\n    variationIndex: number,\n    hashUsed: boolean,\n    featureId: string | null,\n    bucket?: number,\n    stickyBucketUsed?: boolean\n  ): Result<T> {\n    let inExperiment = true;\n    // If assigned variation is not valid, use the baseline and mark the user as not in the experiment\n    if (variationIndex < 0 || variationIndex >= experiment.variations.length) {\n      variationIndex = 0;\n      inExperiment = false;\n    }\n\n    const { hashAttribute, hashValue } = this._getHashAttribute(\n      experiment.hashAttribute,\n      this._ctx.stickyBucketService && !experiment.disableStickyBucketing\n        ? experiment.fallbackAttribute\n        : undefined\n    );\n\n    const meta: Partial<VariationMeta> = experiment.meta\n      ? experiment.meta[variationIndex]\n      : {};\n\n    const res: Result<T> = {\n      key: meta.key || \"\" + variationIndex,\n      featureId,\n      inExperiment,\n      hashUsed,\n      variationId: variationIndex,\n      value: experiment.variations[variationIndex],\n      hashAttribute,\n      hashValue,\n      stickyBucketUsed: !!stickyBucketUsed,\n    };\n\n    if (meta.name) res.name = meta.name;\n    if (bucket !== undefined) res.bucket = bucket;\n    if (meta.passthrough) res.passthrough = meta.passthrough;\n\n    return res;\n  }\n\n  private _getContextUrl() {\n    return this._ctx.url || (isBrowser ? window.location.href : \"\");\n  }\n\n  private _urlIsValid(urlRegex: RegExp): boolean {\n    const url = this._getContextUrl();\n    if (!url) return false;\n\n    const pathOnly = url.replace(/^https?:\\/\\//, \"\").replace(/^[^/]*\\//, \"/\");\n\n    if (urlRegex.test(url)) return true;\n    if (urlRegex.test(pathOnly)) return true;\n    return false;\n  }\n\n  private _hasGroupOverlap(expGroups: string[]): boolean {\n    const groups = this._ctx.groups || {};\n    for (let i = 0; i < expGroups.length; i++) {\n      if (groups[expGroups[i]]) return true;\n    }\n    return false;\n  }\n\n  private _isAutoExperimentBlockedByContext(\n    experiment: AutoExperiment\n  ): boolean {\n    const changeType = getAutoExperimentChangeType(experiment);\n    if (changeType === \"visual\") {\n      if (this._ctx.disableVisualExperiments) return true;\n\n      if (this._ctx.disableJsInjection) {\n        if (experiment.variations.some((v) => v.js)) {\n          return true;\n        }\n      }\n    } else if (changeType === \"redirect\") {\n      if (this._ctx.disableUrlRedirectExperiments) return true;\n\n      // Validate URLs\n      try {\n        const current = new URL(this._getContextUrl());\n        for (const v of experiment.variations) {\n          if (!v || !v.urlRedirect) continue;\n          const url = new URL(v.urlRedirect);\n\n          // If we're blocking cross origin redirects, block if the protocol or host is different\n          if (this._ctx.disableCrossOriginUrlRedirectExperiments) {\n            if (url.protocol !== current.protocol) return true;\n            if (url.host !== current.host) return true;\n          }\n        }\n      } catch (e) {\n        // Problem parsing one of the URLs\n        this.log(\"Error parsing current or redirect URL\", {\n          id: experiment.key,\n          error: e,\n        });\n        return true;\n      }\n    } else {\n      // Block any unknown changeTypes\n      return true;\n    }\n\n    if (\n      experiment.changeId &&\n      (this._ctx.blockedChangeIds || []).includes(experiment.changeId)\n    ) {\n      return true;\n    }\n\n    return false;\n  }\n\n  public getRedirectUrl(): string {\n    return this._redirectedUrl;\n  }\n\n  private _getNavigateFunction():\n    | null\n    | ((url: string) => void | Promise<void>) {\n    if (this._ctx.navigate) {\n      return this._ctx.navigate;\n    } else if (isBrowser) {\n      return (url: string) => {\n        window.location.replace(url);\n      };\n    }\n    return null;\n  }\n\n  private _setAntiFlicker() {\n    if (!this._ctx.antiFlicker || !isBrowser) return;\n    try {\n      const styleTag = document.createElement(\"style\");\n      styleTag.innerHTML =\n        \".gb-anti-flicker { opacity: 0 !important; pointer-events: none; }\";\n      document.head.appendChild(styleTag);\n      document.documentElement.classList.add(\"gb-anti-flicker\");\n\n      // Fallback if GrowthBook fails to load in specified time or 3.5 seconds\n      setTimeout(() => {\n        document.documentElement.classList.remove(\"gb-anti-flicker\");\n      }, this._ctx.antiFlickerTimeout ?? 3500);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  private _applyDOMChanges(changes: AutoExperimentVariation) {\n    if (!isBrowser) return;\n    const undo: (() => void)[] = [];\n    if (changes.css) {\n      const s = document.createElement(\"style\");\n      s.innerHTML = changes.css;\n      document.head.appendChild(s);\n      undo.push(() => s.remove());\n    }\n    if (changes.js) {\n      const script = document.createElement(\"script\");\n      script.innerHTML = changes.js;\n      if (this._ctx.jsInjectionNonce) {\n        script.nonce = this._ctx.jsInjectionNonce;\n      }\n      document.head.appendChild(script);\n      undo.push(() => script.remove());\n    }\n    if (changes.domMutations) {\n      changes.domMutations.forEach((mutation) => {\n        undo.push(mutate.declarative(mutation as DeclarativeMutation).revert);\n      });\n    }\n    return () => {\n      undo.forEach((fn) => fn());\n    };\n  }\n\n  private _deriveStickyBucketIdentifierAttributes(data?: FeatureApiResponse) {\n    const attributes = new Set<string>();\n    const features = data && data.features ? data.features : this.getFeatures();\n    const experiments =\n      data && data.experiments ? data.experiments : this.getExperiments();\n    Object.keys(features).forEach((id) => {\n      const feature = features[id];\n      if (feature.rules) {\n        for (const rule of feature.rules) {\n          if (rule.variations) {\n            attributes.add(rule.hashAttribute || \"id\");\n            if (rule.fallbackAttribute) {\n              attributes.add(rule.fallbackAttribute);\n            }\n          }\n        }\n      }\n    });\n    experiments.map((experiment) => {\n      attributes.add(experiment.hashAttribute || \"id\");\n      if (experiment.fallbackAttribute) {\n        attributes.add(experiment.fallbackAttribute);\n      }\n    });\n    return Array.from(attributes);\n  }\n\n  public async refreshStickyBuckets(data?: FeatureApiResponse) {\n    if (this._ctx.stickyBucketService) {\n      const attributes = this._getStickyBucketAttributes(data);\n      this._ctx.stickyBucketAssignmentDocs = await this._ctx.stickyBucketService.getAllAssignments(\n        attributes\n      );\n    }\n  }\n\n  private _getStickyBucketAssignments(\n    expHashAttribute: string,\n    expFallbackAttribute?: string\n  ): StickyAssignments {\n    if (!this._ctx.stickyBucketAssignmentDocs) return {};\n    const { hashAttribute, hashValue } = this._getHashAttribute(\n      expHashAttribute\n    );\n    const hashKey = `${hashAttribute}||${toString(hashValue)}`;\n\n    const {\n      hashAttribute: fallbackAttribute,\n      hashValue: fallbackValue,\n    } = this._getHashAttribute(expFallbackAttribute);\n    const fallbackKey = fallbackValue\n      ? `${fallbackAttribute}||${toString(fallbackValue)}`\n      : null;\n\n    const assignments: StickyAssignments = {};\n    if (fallbackKey && this._ctx.stickyBucketAssignmentDocs[fallbackKey]) {\n      Object.assign(\n        assignments,\n        this._ctx.stickyBucketAssignmentDocs[fallbackKey].assignments || {}\n      );\n    }\n    if (this._ctx.stickyBucketAssignmentDocs[hashKey]) {\n      Object.assign(\n        assignments,\n        this._ctx.stickyBucketAssignmentDocs[hashKey].assignments || {}\n      );\n    }\n    return assignments;\n  }\n\n  private _getStickyBucketVariation({\n    expKey,\n    expBucketVersion,\n    expHashAttribute,\n    expFallbackAttribute,\n    expMinBucketVersion,\n    expMeta,\n  }: {\n    expKey: string;\n    expBucketVersion?: number;\n    expHashAttribute?: string;\n    expFallbackAttribute?: string;\n    expMinBucketVersion?: number;\n    expMeta?: VariationMeta[];\n  }): {\n    variation: number;\n    versionIsBlocked?: boolean;\n  } {\n    expBucketVersion = expBucketVersion || 0;\n    expMinBucketVersion = expMinBucketVersion || 0;\n    expHashAttribute = expHashAttribute || \"id\";\n    expMeta = expMeta || [];\n    const id = this._getStickyBucketExperimentKey(expKey, expBucketVersion);\n    const assignments = this._getStickyBucketAssignments(\n      expHashAttribute,\n      expFallbackAttribute\n    );\n\n    // users with any blocked bucket version (0 to minExperimentBucketVersion) are excluded from the test\n    if (expMinBucketVersion > 0) {\n      for (let i = 0; i <= expMinBucketVersion; i++) {\n        const blockedKey = this._getStickyBucketExperimentKey(expKey, i);\n        if (assignments[blockedKey] !== undefined) {\n          return {\n            variation: -1,\n            versionIsBlocked: true,\n          };\n        }\n      }\n    }\n    const variationKey = assignments[id];\n    if (variationKey === undefined)\n      // no assignment found\n      return { variation: -1 };\n    const variation = expMeta.findIndex((m) => m.key === variationKey);\n    if (variation < 0)\n      // invalid assignment, treat as \"no assignment found\"\n      return { variation: -1 };\n\n    return { variation };\n  }\n\n  private _getStickyBucketExperimentKey(\n    experimentKey: string,\n    experimentBucketVersion?: number\n  ): StickyExperimentKey {\n    experimentBucketVersion = experimentBucketVersion || 0;\n    return `${experimentKey}__${experimentBucketVersion}`;\n  }\n\n  private _getStickyBucketAttributes(\n    data?: FeatureApiResponse\n  ): Record<string, string> {\n    const attributes: Record<string, string> = {};\n    this._ctx.stickyBucketIdentifierAttributes = !this._ctx\n      .stickyBucketIdentifierAttributes\n      ? this._deriveStickyBucketIdentifierAttributes(data)\n      : this._ctx.stickyBucketIdentifierAttributes;\n    this._ctx.stickyBucketIdentifierAttributes.forEach((attr) => {\n      const { hashValue } = this._getHashAttribute(attr);\n      attributes[attr] = toString(hashValue);\n    });\n    return attributes;\n  }\n\n  private _generateStickyBucketAssignmentDoc(\n    attributeName: string,\n    attributeValue: string,\n    assignments: StickyAssignments\n  ): {\n    key: StickyAttributeKey;\n    doc: StickyAssignmentsDocument;\n    changed: boolean;\n  } {\n    const key = `${attributeName}||${attributeValue}`;\n    const existingAssignments =\n      this._ctx.stickyBucketAssignmentDocs &&\n      this._ctx.stickyBucketAssignmentDocs[key]\n        ? this._ctx.stickyBucketAssignmentDocs[key].assignments || {}\n        : {};\n    const newAssignments = { ...existingAssignments, ...assignments };\n    const changed =\n      JSON.stringify(existingAssignments) !== JSON.stringify(newAssignments);\n\n    return {\n      key,\n      doc: {\n        attributeName,\n        attributeValue,\n        assignments: newAssignments,\n      },\n      changed,\n    };\n  }\n}\n\nexport async function prefetchPayload(options: PrefetchOptions) {\n  // Create a temporary instance, just to fetch the payload\n  const instance = new GrowthBook(options);\n\n  await refreshFeatures({\n    instance,\n    skipCache: options.skipCache,\n    allowStale: false,\n    backgroundSync: options.streaming,\n  });\n\n  instance.destroy();\n}\n","import {\n  LocalStorageCompat,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n} from \"./types/growthbook\";\n\nexport interface CookieAttributes {\n  expires?: number | Date | undefined;\n  path?: string | undefined;\n  domain?: string | undefined;\n  secure?: boolean | undefined;\n  sameSite?: \"strict\" | \"Strict\" | \"lax\" | \"Lax\" | \"none\" | \"None\" | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [property: string]: any;\n}\nexport interface JsCookiesCompat<T = string> {\n  set(\n    name: string,\n    value: string | T,\n    options?: CookieAttributes\n  ): string | undefined;\n  get(name: string): string | T | undefined;\n  get(): { [key: string]: string };\n  remove(name: string, options?: CookieAttributes): void;\n}\n\nexport interface IORedisCompat {\n  mget(...keys: string[]): Promise<string[]>;\n  set(key: string, value: string): Promise<string>;\n}\n\nexport interface RequestCompat {\n  cookies: Record<string, string>;\n  [key: string]: unknown;\n}\nexport interface ResponseCompat {\n  cookie(\n    name: string,\n    value: string,\n    options?: CookieAttributes\n  ): ResponseCompat;\n  [key: string]: unknown;\n}\n\n/**\n * Responsible for reading and writing documents which describe sticky bucket assignments.\n */\nexport abstract class StickyBucketService {\n  abstract getAssignments(\n    attributeName: string,\n    attributeValue: string\n  ): Promise<StickyAssignmentsDocument | null>;\n\n  abstract saveAssignments(doc: StickyAssignmentsDocument): Promise<unknown>;\n\n  /**\n   * The SDK calls getAllAssignments to populate sticky buckets. This in turn will\n   * typically loop through individual getAssignments calls. However, some StickyBucketService\n   * instances (i.e. Redis) will instead perform a multi-query inside getAllAssignments instead.\n   */\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    (\n      await Promise.all(\n        Object.entries(attributes).map(([attributeName, attributeValue]) =>\n          this.getAssignments(attributeName, attributeValue)\n        )\n      )\n    ).forEach((doc) => {\n      if (doc) {\n        const key = `${doc.attributeName}||${doc.attributeValue}`;\n        docs[key] = doc;\n      }\n    });\n    return docs;\n  }\n}\n\nexport class LocalStorageStickyBucketService extends StickyBucketService {\n  private prefix: string;\n  private localStorage: LocalStorageCompat | undefined;\n  constructor(opts?: { prefix?: string; localStorage?: LocalStorageCompat }) {\n    opts = opts || {};\n    super();\n    this.prefix = opts.prefix || \"gbStickyBuckets__\";\n    try {\n      this.localStorage = opts.localStorage || globalThis.localStorage;\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = `${attributeName}||${attributeValue}`;\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.localStorage) return doc;\n    try {\n      const raw = (await this.localStorage.getItem(this.prefix + key)) || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = `${doc.attributeName}||${doc.attributeValue}`;\n    if (!this.localStorage) return;\n    try {\n      await this.localStorage.setItem(this.prefix + key, JSON.stringify(doc));\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n}\n\nexport class ExpressCookieStickyBucketService extends StickyBucketService {\n  /**\n   * Intended to be used with cookieParser() middleware from npm: 'cookie-parser'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value must be manually encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private prefix: string;\n  private req: RequestCompat;\n  private res: ResponseCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    req,\n    res,\n    cookieAttributes = {},\n  }: {\n    prefix?: string;\n    req: RequestCompat;\n    res: ResponseCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.req = req;\n    this.res = res;\n    this.cookieAttributes = cookieAttributes;\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = `${attributeName}||${attributeValue}`;\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.req) return doc;\n    try {\n      const raw = this.req.cookies[this.prefix + key] || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = `${doc.attributeName}||${doc.attributeValue}`;\n    if (!this.res) return;\n    const str = JSON.stringify(doc);\n    this.res.cookie(\n      encodeURIComponent(this.prefix + key),\n      encodeURIComponent(str),\n      this.cookieAttributes\n    );\n  }\n}\n\nexport class BrowserCookieStickyBucketService extends StickyBucketService {\n  /**\n   * Intended to be used with npm: 'js-cookie'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value is automatically encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private prefix: string;\n  private jsCookie: JsCookiesCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    jsCookie,\n    cookieAttributes = {},\n  }: {\n    prefix?: string;\n    jsCookie: JsCookiesCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.jsCookie = jsCookie;\n    this.cookieAttributes = cookieAttributes;\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = `${attributeName}||${attributeValue}`;\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.jsCookie) return doc;\n    try {\n      const raw = this.jsCookie.get(this.prefix + key);\n      const data = JSON.parse(raw || \"{}\");\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = `${doc.attributeName}||${doc.attributeValue}`;\n    if (!this.jsCookie) return;\n    const str = JSON.stringify(doc);\n    this.jsCookie.set(this.prefix + key, str, this.cookieAttributes);\n  }\n}\n\nexport class RedisStickyBucketService extends StickyBucketService {\n  /** Intended to be used with npm: 'ioredis'. **/\n  private redis: IORedisCompat | undefined;\n  constructor({ redis }: { redis: IORedisCompat }) {\n    super();\n    this.redis = redis;\n  }\n\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<StickyAttributeKey, StickyAssignmentsDocument> = {};\n    const keys = Object.entries(attributes).map(\n      ([attributeName, attributeValue]) => `${attributeName}||${attributeValue}`\n    );\n    if (!this.redis) return docs;\n    await this.redis.mget(...keys).then((values) => {\n      values.forEach((raw) => {\n        try {\n          const data = JSON.parse(raw || \"{}\");\n          if (data.attributeName && data.attributeValue && data.assignments) {\n            const key = `${data.attributeName}||${data.attributeValue}`;\n            docs[key] = data;\n          }\n        } catch (e) {\n          // ignore redis doc parse errors\n        }\n      });\n    });\n    return docs;\n  }\n\n  async getAssignments(_attributeName: string, _attributeValue: string) {\n    // not implemented\n    return null;\n  }\n\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = `${doc.attributeName}||${doc.attributeValue}`;\n    if (!this.redis) return;\n    await this.redis.set(key, JSON.stringify(doc));\n  }\n}\n","import Cookies from \"js-cookie\";\nimport {\n  BrowserCookieStickyBucketService,\n  Context,\n  FeatureApiResponse,\n  GrowthBook,\n  LocalStorageStickyBucketService,\n  StickyBucketService,\n} from \"./index\";\n\ntype WindowContext = Context & {\n  uuidCookieName?: string;\n  uuidKey?: string;\n  uuid?: string;\n  persistUuidOnLoad?: boolean;\n  noStreaming?: boolean;\n  useStickyBucketService?: \"cookie\" | \"localStorage\";\n  stickyBucketPrefix?: string;\n  payload?: FeatureApiResponse;\n};\ndeclare global {\n  interface Window {\n    _growthbook?: GrowthBook;\n    growthbook_queue?:\n      | Array<(gb: GrowthBook) => void>\n      | { push: (cb: (gb: GrowthBook) => void) => void };\n    growthbook_config?: WindowContext;\n    // eslint-disable-next-line\n    dataLayer?: any[];\n    analytics?: {\n      track?: (name: string, props?: Record<string, unknown>) => void;\n    };\n    // eslint-disable-next-line\n    gtag?: (...args: any) => void;\n  }\n}\n\n// Ensure dataLayer exists\nwindow.dataLayer = window.dataLayer || [];\n\nconst currentScript = document.currentScript;\nconst dataContext: DOMStringMap = currentScript ? currentScript.dataset : {};\nconst windowContext: WindowContext = window.growthbook_config || {};\n\nfunction setCookie(name: string, value: string) {\n  const d = new Date();\n  const COOKIE_DAYS = 400; // 400 days is the max cookie duration for chrome\n  d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * COOKIE_DAYS);\n  document.cookie = name + \"=\" + value + \";path=/;expires=\" + d.toUTCString();\n}\n\nfunction getCookie(name: string): string {\n  const value = \"; \" + document.cookie;\n  const parts = value.split(`; ${name}=`);\n  return parts.length === 2 ? parts[1].split(\";\")[0] : \"\";\n}\n\n// Use the browsers crypto.randomUUID if set to generate a UUID\nfunction genUUID() {\n  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();\n  return (\"\" + 1e7 + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, (c) =>\n    (\n      ((c as unknown) as number) ^\n      (crypto.getRandomValues(new Uint8Array(1))[0] &\n        (15 >> (((c as unknown) as number) / 4)))\n    ).toString(16)\n  );\n}\n\nconst COOKIE_NAME =\n  windowContext.uuidCookieName || dataContext.uuidCookieName || \"gbuuid\";\nconst uuidKey = windowContext.uuidKey || dataContext.uuidKey || \"id\";\nlet uuid = windowContext.uuid || dataContext.uuid || \"\";\nfunction persistUUID() {\n  setCookie(COOKIE_NAME, uuid);\n}\nfunction getUUID(persist = true) {\n  // Already stored in memory, return\n  if (uuid) return uuid;\n\n  // If cookie is already set, return\n  uuid = getCookie(COOKIE_NAME);\n  if (uuid) return uuid;\n\n  // Generate a new UUID and optionally persist it in a cookie\n  uuid = genUUID();\n  if (persist) {\n    persistUUID();\n  }\n\n  return uuid;\n}\n\nfunction getUtmAttributes() {\n  // Store utm- params in sessionStorage for future page loads\n  let utms: Record<string, string> = {};\n  try {\n    const existing = sessionStorage.getItem(\"utm_params\");\n    if (existing) {\n      utms = JSON.parse(existing);\n    }\n\n    // Add utm params from querystring\n    if (location.search) {\n      const params = new URLSearchParams(location.search);\n      let hasChanges = false;\n      [\"source\", \"medium\", \"campaign\", \"term\", \"content\"].forEach((k) => {\n        // Querystring is in snake_case\n        const param = `utm_${k}`;\n        // Attribute keys are camelCase\n        const attr = `utm` + k[0].toUpperCase() + k.slice(1);\n\n        if (params.has(param)) {\n          utms[attr] = params.get(param) || \"\";\n          hasChanges = true;\n        }\n      });\n\n      // Write back to sessionStorage\n      if (hasChanges) {\n        sessionStorage.setItem(\"utm_params\", JSON.stringify(utms));\n      }\n    }\n  } catch (e) {\n    // Do nothing if sessionStorage is disabled (e.g. incognito window)\n  }\n\n  return utms;\n}\n\nfunction getDataLayerVariables() {\n  if (!window.dataLayer || !window.dataLayer.forEach) return {};\n  const obj: Record<string, unknown> = {};\n  window.dataLayer.forEach((item: unknown) => {\n    // Skip empty and non-object entries\n    if (!item || typeof item !== \"object\" || \"length\" in item) return;\n\n    // Skip events\n    if (\"event\" in item) return;\n\n    Object.keys(item).forEach((k) => {\n      // Filter out known properties that aren't useful\n      if (typeof k !== \"string\" || k.match(/^(gtm)/)) return;\n\n      const val = (item as Record<string, unknown>)[k];\n\n      // Only add primitive variable values\n      const valueType = typeof val;\n      if ([\"string\", \"number\", \"boolean\"].includes(valueType)) {\n        obj[k] = val;\n      }\n    });\n  });\n  return obj;\n}\n\nfunction getAutoAttributes(\n  dataContext: DOMStringMap,\n  windowContext: WindowContext\n) {\n  const useCookies = dataContext.noAutoCookies == null;\n\n  const ua = navigator.userAgent;\n\n  const browser = ua.match(/Edg/)\n    ? \"edge\"\n    : ua.match(/Chrome/)\n    ? \"chrome\"\n    : ua.match(/Firefox/)\n    ? \"firefox\"\n    : ua.match(/Safari/)\n    ? \"safari\"\n    : \"unknown\";\n\n  const _uuid = getUUID(useCookies);\n  if (\n    (windowContext.persistUuidOnLoad || dataContext.persistUuidOnLoad) &&\n    useCookies\n  ) {\n    persistUUID();\n  }\n\n  return {\n    ...getDataLayerVariables(),\n    [uuidKey]: _uuid,\n    url: location.href,\n    path: location.pathname,\n    host: location.host,\n    query: location.search,\n    pageTitle: document && document.title,\n    deviceType: ua.match(/Mobi/) ? \"mobile\" : \"desktop\",\n    browser,\n    ...getUtmAttributes(),\n  };\n}\n\nfunction getAttributes() {\n  // Merge auto attributes and user-supplied attributes\n  const attributes = dataContext[\"noAutoAttributes\"]\n    ? {}\n    : getAutoAttributes(dataContext, windowContext);\n  if (windowContext.attributes) {\n    Object.assign(attributes, windowContext.attributes);\n  }\n  return attributes;\n}\n\n// Create sticky bucket service\nlet stickyBucketService: StickyBucketService | undefined = undefined;\nif (\n  windowContext.useStickyBucketService === \"cookie\" ||\n  dataContext.useStickyBucketService === \"cookie\"\n) {\n  stickyBucketService = new BrowserCookieStickyBucketService({\n    prefix:\n      windowContext.stickyBucketPrefix ||\n      dataContext.stickyBucketPrefix ||\n      undefined,\n    jsCookie: Cookies,\n  });\n} else if (\n  windowContext.useStickyBucketService === \"localStorage\" ||\n  dataContext.useStickyBucketService === \"localStorage\"\n) {\n  stickyBucketService = new LocalStorageStickyBucketService({\n    prefix:\n      windowContext.stickyBucketPrefix ||\n      dataContext.stickyBucketPrefix ||\n      undefined,\n  });\n}\n// Create GrowthBook instance\nconst gb = new GrowthBook({\n  ...dataContext,\n  remoteEval: !!dataContext.remoteEval,\n  trackingCallback: (e, r) => {\n    const p = { experiment_id: e.key, variation_id: r.key };\n\n    // GA4 - gtag\n    window.gtag && window.gtag(\"event\", \"experiment_viewed\", p);\n\n    // GTM - dataLayer\n    window.dataLayer &&\n      window.dataLayer.push({ event: \"experiment_viewed\", ...p });\n\n    // Segment - analytics.js\n    window.analytics &&\n      window.analytics.track &&\n      window.analytics.track(\"Experiment Viewed\", p);\n  },\n  ...windowContext,\n  attributes: getAttributes(),\n  stickyBucketService,\n});\n\n// Set the renderer to fire a custom DOM event\n// This will let us attach multiple listeners\ngb.setRenderer(() => {\n  document.dispatchEvent(new CustomEvent(\"growthbookdata\"));\n});\n\ngb.init({\n  payload: windowContext.payload,\n  streaming: !(\n    windowContext.noStreaming ||\n    dataContext.noStreaming ||\n    windowContext.backgroundSync === false\n  ),\n});\n\n// Poll for URL changes and update GrowthBook\nlet currentUrl = location.href;\nsetInterval(() => {\n  if (location.href !== currentUrl) {\n    currentUrl = location.href;\n    gb.setURL(currentUrl);\n    gb.updateAttributes(getAttributes());\n  }\n}, 500);\n\n// Listen for a custom event to update URL and attributes\ndocument.addEventListener(\"growthbookrefresh\", () => {\n  if (location.href !== currentUrl) {\n    currentUrl = location.href;\n    gb.setURL(currentUrl);\n  }\n  gb.updateAttributes(getAttributes());\n});\n\n// Listen for a custom event to persist the UUID cookie\ndocument.addEventListener(\"growthbookpersist\", () => {\n  persistUUID();\n});\n\nconst fireCallback = (cb: (gb: GrowthBook) => void) => {\n  try {\n    cb && cb(gb);\n  } catch (e) {\n    console.error(\"Uncaught growthbook_queue error\", e);\n  }\n};\n\n// Process any queued callbacks\nif (window.growthbook_queue) {\n  if (Array.isArray(window.growthbook_queue)) {\n    window.growthbook_queue.forEach((cb) => {\n      fireCallback(cb);\n    });\n  }\n}\n// Replace the queue with a function that immediately calls the callback\nwindow.growthbook_queue = {\n  push: (cb: (gb: GrowthBook) => void) => {\n    fireCallback(cb);\n  },\n};\n\n// Store a reference in window to enable more advanced use cases\nexport default gb;\n"],"names":["assign","target","i","arguments","length","source","key","api","init","converter","defaultAttributes","set","name","value","attributes","document","expires","Date","now","toUTCString","encodeURIComponent","replace","decodeURIComponent","escape","stringifiedAttributes","attributeName","split","cookie","write","Object","create","get","cookies","jar","parts","slice","join","found","read","e","remove","withAttributes","this","withConverter","freeze","path","polyfills","fetch","globalThis","bind","undefined","SubtleCrypto","crypto","subtle","EventSource","hashFnv32a","str","hval","l","charCodeAt","hash","seed","version","inRange","n","range","getUrlRegExp","regexString","escaped","RegExp","console","error","isURLTargeted","url","targets","hasIncludeRules","isIncluded","match","_evalURLTarget","type","pattern","include","parsed","URL","regex","test","href","substring","origin","actual","expected","comps","host","pathname","push","searchParams","forEach","v","k","some","data","isPath","_evalSimpleUrlPart","_evalSimpleUrlTarget","base64ToBuf","b","Uint8Array","from","atob","c","async","decrypt","encryptedString","decryptionKey","Error","importKey","iv","cipherText","plainTextBuffer","TextDecoder","decode","toString","input","JSON","stringify","paddedVersionString","map","padStart","isObj","x","getAutoExperimentChangeType","exp","urlPatterns","variations","variation","domMutations","cacheSettings","staleTTL","maxAge","cacheKey","backgroundSync","maxEntries","disableIdleStreams","idleStreamInterval","disableCache","helpers","fetchFeaturesCall","_ref","clientKey","headers","concat","fetchRemoteEvalCall","_ref2","payload","options","method","body","eventSourceCall","_ref3","startIdleListener","idleTimeout","window","onVisibilityChange","visibilityState","clearTimeout","streams","channel","state","enableChannel","setTimeout","onHidden","addEventListener","removeEventListener","stopIdleListener","localStorage","subscribedInstances","Map","cacheInitialized","cache","activeFetches","supportsSSE","Set","subscribe","instance","getKey","subs","add","disableChannel","updatePersistentCache","setItem","Array","entries","apiHost","getApiInfo","getCacheKey","baseKey","isRemoteEval","getAttributes","cacheKeyAttributes","getCacheKeyAttributes","keys","ca","fv","getForcedVariations","getUrl","cleanupCache","entriesWithTimestamps","_ref7","staleAt","getTime","sort","a","entriesToRemoveCount","Math","min","max","size","delete","onNewFeatureData","dateUpdated","existing","sse","has","instances","setPayload","getPayload","refreshInstance","fetchFeatures","apiRequestHeaders","getApiHosts","getClientKey","remoteEval","promise","forcedVariations","forcedFeatures","getForcedFeatures","then","res","ok","status","json","startAutoRefresh","success","catch","forceSSE","streamingHost","streamingHostRequestHeaders","src","cb","event","parse","errors","onSSEError","readyState","delay","pow","random","includes","onopen","onerror","close","validAttributeName","nullController","revert","elements","mutations","getElementRecord","element","record","createElementPropertyRecord","el","attr","getCurrentValue","setValue","mutationRunner","currentValue","isDirty","originalValue","virtualValue","_positionTimeout","observer","MutationObserver","parentNode","insertBeforeNode","observe","childList","subtree","characterData","attributeFilter","getObserverInit","queueIfNeeded","val","currentVal","runDOMUpdates","htmlMutationRunner","m","mutate","html","transformContainer","createElement","innerHTML","getTransformedHTML","classMutationRunner","filter","Boolean","attrMutationRunner","positionMutationRunner","newNodes","parentSelector","insertBeforeSelector","querySelector","_loadDOMNodes","getHTMLValue","setHTMLValue","getElementHTMLRecord","elementRecord","getElementPosition","parentElement","nextElementSibling","setElementPosition","contains","insertBefore","getElementPositionRecord","position","setClassValue","className","removeAttribute","getClassValue","getElementClassRecord","classes","getElementAttributeRecord","attrName","_el$getAttribute","getAttribute","setAttribute","setAttrValue","setPropertyValue","_element$html","_element$html$observe","disconnect","_element$classes","_element$classes$obse","_element$position","_element$position$obs","_element$attributes","_element$attributes$a","_element$attributes$a2","deleteElementPropertyRecord","refreshElementsSet","mutation","kind","existingElements","querySelectorAll","selector","attribute","startMutating","refreshAllElementSets","newMutation","index","indexOf","splice","stopMutating","clear","classnames","mutatedClassnames","documentElement","_regexCache","evalCondition","obj","condition","evalOr","evalAnd","evalConditionValue","getPath","current","isArray","isOperatorObject","op","evalOperatorCondition","isIn","operator","check","elemMatch","passed","j","t","getType","conditions","isBrowser","SDK_VERSION","loadSDKVersion","StickyBucketService","docs","Promise","all","attributeValue","getAssignments","doc","dataLayer","currentScript","dataContext","dataset","windowContext","growthbook_config","getCookie","genUUID","randomUUID","getRandomValues","COOKIE_NAME","uuidCookieName","uuidKey","stickyBucketService","uuid","persistUUID","d","setTime","setCookie","getUtmAttributes","utms","sessionStorage","getItem","location","search","params","URLSearchParams","hasChanges","param","toUpperCase","getDataLayerVariables","item","useCookies","noAutoCookies","ua","navigator","userAgent","browser","_uuid","persist","getUUID","persistUuidOnLoad","query","pageTitle","title","deviceType","getAutoAttributes","useStickyBucketService","constructor","prefix","jsCookie","cookieAttributes","super","raw","assignments","stickyBucketPrefix","Cookies","opts","gb","context","_ctx","_renderer","renderer","_trackedExperiments","_completedChangeIds","_trackedFeatures","debug","_subscriptions","_rtQueue","_rtTimer","ready","_assigned","_forcedFeatureValues","_attributeOverrides","_activeAutoExperiments","_triggeredExpKeys","_initialized","_redirectedUrl","_deferredTrackingCalls","_autoExperimentsAllowed","disableExperimentsOnLoad","isGbHost","hostname","features","enableDevMode","_growthbook","dispatchEvent","Event","experiments","_updateAllAutoExperiments","antiFlicker","_setAntiFlicker","stickyBucketAssignmentDocs","saveAssignments","refreshStickyBuckets","_payload","decryptPayload","_decryptedPayload","_render","initSync","encryptedExperiments","encryptedFeatures","streaming","_refresh","allowStale","autoRefresh","subscribeToChanges","_canSubscribe","defaultHost","apiHostRequestHeaders","getFeatures","getExperiments","getDecryptedPayload","timeout","skipCache","_ref4","_ref5","minStaleAt","_ref6","cleanupFn","initializeCache","resolve","timer","resolved","finish","promiseTimeout","fetchFeaturesWithCache","refreshFeatures","setFeatures","featuresJSON","setExperiments","experimentsJSON","_refreshForRemoteEval","setAttributes","overrides","vars","setForcedFeatures","getStickyBucketAssignmentDocs","getCompletedChangeIds","_this$_ctx$background","getAllResults","destroy","s","undo","setRenderer","forceVariation","run","experiment","result","_run","_fireSubscriptions","triggerExperiment","_runAutoExperiment","triggerAutoExperiments","forceRerun","manual","_isAutoExperimentBlockedByContext","_getResult","valueHash","inExperiment","_undoActiveAutoExperiment","changeType","urlRedirect","persistQueryString","oldUrl","newUrl","currUrl","redirectUrl","mergeQueryStrings","_getContextUrl","log","id","navigate","_getNavigateFunction","_this$_ctx$navigateDe","navigateDelay","applyDomChangesCallback","_applyDOMChanges","prev","variationId","_trackFeatureUsage","stringifiedValue","onFeatureUsage","on","q","realtimeKey","mode","realtimeInterval","_getFeatureResult","ruleId","ret","off","experimentResult","isOn","evalFeature","isOff","getFeatureValue","defaultValue","feature","_evalFeature","evalCtx","evaluatedFeatures","rules","rule","parentConditions","parentCondition","parentResult","gate","filters","_isFilteredOut","_conditionPasses","_isIncludedInRollout","hashAttribute","disableStickyBucketing","fallbackAttribute","coverage","hashVersion","tracks","_track","force","weights","bucketVersion","minBucketVersion","namespace","meta","ranges","phase","passthrough","hashValue","_getHashAttribute","r","featureId","numVariations","enabled","_mergeOverrides","qsOverride","kv","parseInt","getQueryStringOverride","active","assigned","foundStickyBucket","stickyBucketVersionIsBlocked","versionIsBlocked","_getStickyBucketVariation","expKey","expBucketVersion","expHashAttribute","expFallbackAttribute","expMinBucketVersion","expMeta","inNamespace","groups","_hasGroupOverlap","_urlIsValid","chooseVariation","equal","fill","totalWeight","reduce","w","sum","cumulative","start","getBucketRanges","qaMode","changed","attrKey","_generateStickyBucketAssignmentDoc","_getStickyBucketExperimentKey","changeId","msg","ctx","getDeferredTrackingCalls","values","setDeferredTrackingCalls","calls","_getTrackKey","fireDeferredTrackingCalls","trackingCallback","call","setTrackingCallback","callback","o","fallback","user","variationIndex","hashUsed","bucket","stickyBucketUsed","urlRegex","pathOnly","expGroups","disableVisualExperiments","disableJsInjection","js","disableUrlRedirectExperiments","disableCrossOriginUrlRedirectExperiments","protocol","blockedChangeIds","getRedirectUrl","_this$_ctx$antiFlicke","styleTag","head","appendChild","classList","antiFlickerTimeout","changes","css","script","jsInjectionNonce","nonce","action","fn","_deriveStickyBucketIdentifierAttributes","_getStickyBucketAttributes","getAllAssignments","_getStickyBucketAssignments","hashKey","fallbackValue","fallbackKey","variationKey","findIndex","experimentKey","experimentBucketVersion","stickyBucketIdentifierAttributes","existingAssignments","newAssignments","p","experiment_id","variation_id","gtag","analytics","track","CustomEvent","noStreaming","currentUrl","setInterval","setURL","updateAttributes","fireCallback","growthbook_queue"],"mappings":"wCAEA,SAASA,EAAQC,GACf,IAAK,IAAIC,EAAI,EAAGA,EAAIC,UAAUC,OAAQF,IAAK,CACzC,IAAIG,EAASF,UAAUD,GACvB,IAAK,IAAII,KAAOD,EACdJ,EAAOK,GAAOD,EAAOC,EAExB,CACD,OAAOL,CACT,CAwHA,IAAIM,EAlGJ,SAASC,EAAMC,EAAWC,GACxB,SAASC,EAAKC,EAAMC,EAAOC,GACzB,GAAwB,oBAAbC,SAAX,CAMkC,iBAFlCD,EAAad,EAAO,CAAA,EAAIU,EAAmBI,IAErBE,UACpBF,EAAWE,QAAU,IAAIC,KAAKA,KAAKC,MAA6B,MAArBJ,EAAWE,UAEpDF,EAAWE,UACbF,EAAWE,QAAUF,EAAWE,QAAQG,eAG1CP,EAAOQ,mBAAmBR,GACvBS,QAAQ,uBAAwBC,oBAChCD,QAAQ,QAASE,QAEpB,IAAIC,EAAwB,GAC5B,IAAK,IAAIC,KAAiBX,EACnBA,EAAWW,KAIhBD,GAAyB,KAAOC,GAEE,IAA9BX,EAAWW,KAWfD,GAAyB,IAAMV,EAAWW,GAAeC,MAAM,KAAK,KAGtE,OAAQX,SAASY,OACff,EAAO,IAAMH,EAAUmB,MAAMf,EAAOD,GAAQY,CAtC7C,CAuCF,CA4BD,OAAOK,OAAOC,OACZ,CACEnB,MACAoB,IA7BJ,SAAcnB,GACZ,GAAwB,oBAAbG,YAA6BZ,UAAUC,QAAWQ,GAA7D,CAQA,IAFA,IAAIoB,EAAUjB,SAASY,OAASZ,SAASY,OAAOD,MAAM,MAAQ,GAC1DO,EAAM,CAAA,EACD/B,EAAI,EAAGA,EAAI8B,EAAQ5B,OAAQF,IAAK,CACvC,IAAIgC,EAAQF,EAAQ9B,GAAGwB,MAAM,KACzBb,EAAQqB,EAAMC,MAAM,GAAGC,KAAK,KAEhC,IACE,IAAIC,EAAQf,mBAAmBY,EAAM,IAGrC,GAFAD,EAAII,GAAS5B,EAAU6B,KAAKzB,EAAOwB,GAE/BzB,IAASyB,EACX,KAEU,CAAZ,MAAOE,GAAK,CACf,CAED,OAAO3B,EAAOqB,EAAIrB,GAAQqB,CApBzB,CAqBF,EAMGO,OAAQ,SAAU5B,EAAME,GACtBH,EACEC,EACA,GACAZ,EAAO,CAAE,EAAEc,EAAY,CACrBE,SAAU,IAGf,EACDyB,eAAgB,SAAU3B,GACxB,OAAON,EAAKkC,KAAKjC,UAAWT,EAAO,CAAA,EAAI0C,KAAK5B,WAAYA,GACzD,EACD6B,cAAe,SAAUlC,GACvB,OAAOD,EAAKR,EAAO,GAAI0C,KAAKjC,UAAWA,GAAYiC,KAAK5B,WACzD,GAEH,CACEA,WAAY,CAAED,MAAOgB,OAAOe,OAAOlC,IACnCD,UAAW,CAAEI,MAAOgB,OAAOe,OAAOnC,KAGxC,CAEUD,CApHa,CACrB8B,KAAM,SAAUzB,GAId,MAHiB,MAAbA,EAAM,KACRA,EAAQA,EAAMsB,MAAM,GAAI,IAEnBtB,EAAMQ,QAAQ,mBAAoBC,mBAC1C,EACDM,MAAO,SAAUf,GACf,OAAOO,mBAAmBP,GAAOQ,QAC/B,2CACAC,mBAEH,GAwG8B,CAAEuB,KAAM,MCzHzC,MAAMC,EAAuB,CAC3BC,MAAOC,WAAWD,MAAQC,WAAWD,MAAME,KAAKD,iBAAcE,EAC9DC,aAAcH,WAAWI,OAASJ,WAAWI,OAAOC,YAASH,EAC7DI,YAAaN,WAAWM,aAM1B,SAASC,EAAWC,GAClB,IAAIC,EAAO,WACX,MAAMC,EAAIF,EAAIpD,OAEd,IAAK,IAAIF,EAAI,EAAGA,EAAIwD,EAAGxD,IACrBuD,GAAQD,EAAIG,WAAWzD,GACvBuD,IACGA,GAAQ,IAAMA,GAAQ,IAAMA,GAAQ,IAAMA,GAAQ,IAAMA,GAAQ,IAErE,OAAOA,IAAS,CAClB,CAEO,SAASG,EACdC,EACAhD,EACAiD,GAGA,OAAgB,IAAZA,EACMP,EAAWA,EAAWM,EAAOhD,GAAS,IAAM,IAAS,IAG/C,IAAZiD,EACMP,EAAW1C,EAAQgD,GAAQ,IAAQ,IAItC,IACT,CAOO,SAASE,EAAQC,EAAWC,GACjC,OAAOD,GAAKC,EAAM,IAAMD,EAAIC,EAAM,EACpC,CAoBO,SAASC,EAAaC,GAC3B,IACE,MAAMC,EAAUD,EAAY9C,QAAQ,aAAc,SAClD,OAAO,IAAIgD,OAAOD,EAIpB,CAHE,MAAO7B,GAEP,YADA+B,QAAQC,MAAMhC,EAEhB,CACF,CAEO,SAASiC,EAAcC,EAAaC,GACzC,IAAKA,EAAQtE,OAAQ,OAAO,EAC5B,IAAIuE,GAAkB,EAClBC,GAAa,EAEjB,IAAK,IAAI1E,EAAI,EAAGA,EAAIwE,EAAQtE,OAAQF,IAAK,CACvC,MAAM2E,EAAQC,EAAeL,EAAKC,EAAQxE,GAAG6E,KAAML,EAAQxE,GAAG8E,SAC9D,IAA2B,IAAvBN,EAAQxE,GAAG+E,SACb,GAAIJ,EAAO,OAAO,OAElBF,GAAkB,EACdE,IAAOD,GAAa,EAE5B,CAEA,OAAOA,IAAeD,CACxB,CAyDA,SAASG,EACPL,EACAM,EACAC,GAEA,IACE,MAAME,EAAS,IAAIC,IAAIV,EAAK,aAE5B,GAAa,UAATM,EAAkB,CACpB,MAAMK,EAAQlB,EAAac,GAC3B,QAAKI,IAEHA,EAAMC,KAAKH,EAAOI,OAClBF,EAAMC,KAAKH,EAAOI,KAAKC,UAAUL,EAAOM,OAAOpF,SAEnD,CAAO,MAAa,WAAT2E,GA/Cf,SAA8BU,EAAaT,GACzC,IAGE,MAAMU,EAAW,IAAIP,IACnBH,EAAQ3D,QAAQ,gBAAiB,eAAeA,QAAQ,MAAO,SAC/D,iBAIIsE,EAA0C,CAC9C,CAACF,EAAOG,KAAMF,EAASE,MAAM,GAC7B,CAACH,EAAOI,SAAUH,EAASG,UAAU,IAYvC,OATIH,EAAS9B,MACX+B,EAAMG,KAAK,CAACL,EAAO7B,KAAM8B,EAAS9B,MAAM,IAG1C8B,EAASK,aAAaC,SAAQ,CAACC,EAAGC,KAChCP,EAAMG,KAAK,CAACL,EAAOM,aAAahE,IAAImE,IAAM,GAAID,GAAG,GAAO,KAIlDN,EAAMQ,MACXC,IAhDP,SACEX,EACAT,EACAqB,GAEA,IAEE,IAAIjC,EAAUY,EACX3D,QAAQ,sBAAuB,QAC/BA,QAAQ,SAAU,MAQrB,OANIgF,IAEFjC,EAAU,OAASA,EAAQ/C,QAAQ,aAAc,IAAM,QAG3C,IAAIgD,OAAO,IAAMD,EAAU,IAAK,KACjCiB,KAAKI,EAGpB,CAFE,MAAOlD,GACP,OAAO,CACT,CACF,CA2BiB+D,CAAmBF,EAAK,GAAIA,EAAK,GAAIA,EAAK,KAIzD,CAFE,MAAO7D,GACP,OAAO,CACT,CACF,CAkBagE,CAAqBrB,EAAQF,EAMxC,CAFE,MAAOzC,GACP,OAAO,CACT,CACF,CAwFA,MAAMiE,EAAeC,GACnBC,WAAWC,KAAKC,KAAKH,IAAKI,GAAMA,EAAElD,WAAW,KAExCmD,eAAeC,EACpBC,EACAC,EACA5D,GAOA,GALA4D,EAAgBA,GAAiB,KACjC5D,EACEA,GACCL,WAAWI,QAAUJ,WAAWI,OAAOC,QACxCP,EAAUK,cAEV,MAAM,IAAI+D,MAAM,wCAElB,IACE,MAAM5G,QAAY+C,EAAO8D,UACvB,MACAX,EAAYS,GACZ,CAAErG,KAAM,UAAWR,OAAQ,MAC3B,EACA,CAAC,UAAW,aAEPgH,EAAIC,GAAcL,EAAgBtF,MAAM,KACzC4F,QAAwBjE,EAAO0D,QACnC,CAAEnG,KAAM,UAAWwG,GAAIZ,EAAYY,IACnC9G,EACAkG,EAAYa,IAGd,OAAO,IAAIE,aAAcC,OAAOF,EAGlC,CAFE,MAAO/E,GACP,MAAM,IAAI2E,MAAM,oBAClB,CACF,CAGO,SAASO,EAASC,GACvB,MAAqB,iBAAVA,EAA2BA,EAC/BC,KAAKC,UAAUF,EACxB,CAGO,SAASG,EAAoBH,GACb,iBAAVA,IACTA,GAAgB,IAEbA,GAA0B,iBAAVA,IACnBA,EAAQ,KAKV,MAAMxF,EAASwF,EAAiBrG,QAAQ,cAAe,IAAIK,MAAM,QAWjE,OANqB,IAAjBQ,EAAM9B,QACR8B,EAAM4D,KAAK,KAKN5D,EACJ4F,KAAK7B,GAAOA,EAAEpB,MAAM,YAAcoB,EAAE8B,SAAS,EAAG,KAAO9B,IACvD7D,KAAK,IACV,CAmCA,SAAS4F,EAAMC,GACb,MAAoB,iBAANA,GAAwB,OAANA,CAClC,CAEO,SAASC,EACdC,GAEA,OACEA,EAAIC,aACJD,EAAIE,WAAWlC,MACZmC,GAAcN,EAAMM,IAAc,gBAAiBA,IAG/C,WAEPH,EAAIE,WAAWlC,MACZmC,GACCN,EAAMM,KACLA,EAAUC,cAAgB,OAAQD,GAAa,QAASA,KAGtD,SAGF,SACT,CCjXA,MAAME,EAA+B,CAEnCC,SAAU,IAEVC,OAAQ,MACRC,SAAU,kBACVC,gBAAgB,EAChBC,WAAY,GACZC,oBAAoB,EACpBC,mBAAoB,IACpBC,cAAc,GAGVlG,ED1BGA,EC4BImG,EAAmB,CAC9BC,kBAAmBC,IAAkC,IAAjCvD,KAAEA,EAAIwD,UAAEA,EAASC,QAAEA,GAASF,EAC9C,OAAQrG,EAAUC,gBACb6C,EAAI,kBAAA0D,OAAiBF,GACxB,CAAEC,WACH,EAEHE,oBAAqBC,IAA2C,IAA1C5D,KAAEA,EAAIwD,UAAEA,EAASK,QAAEA,EAAOJ,QAAEA,GAASG,EACzD,MAAME,EAAU,CACdC,OAAQ,OACRN,QAAS,CAAE,eAAgB,sBAAuBA,GAClDO,KAAMjC,KAAKC,UAAU6B,IAEvB,OAAQ3G,EAAUC,MAAK,GAAAuG,OAClB1D,EAAiBwD,cAAAA,OAAAA,GACpBM,EACD,EAEHG,gBAAiBC,IAAkC,IAAjClE,KAAEA,EAAIwD,UAAEA,EAASC,QAAEA,GAASS,EAC5C,OAAIT,EACK,IAAIvG,EAAUQ,sBAAesC,EAAI,SAAA0D,OAAQF,GAAa,CAC3DC,YAGG,IAAIvG,EAAUQ,sBAAesC,EAAI,SAAA0D,OAAQF,GAAY,EAE9DW,kBAAmB,KACjB,IAAIC,EAGJ,GADoB,oBAAXC,QAA8C,oBAAblJ,SAC1B,OAChB,MAAMmJ,EAAqB,KACQ,YAA7BnJ,SAASoJ,iBACXF,OAAOG,aAAaJ,GAmG1BK,EAAQrE,SAASsE,IACVA,GACiB,SAAlBA,EAAQC,OACZC,EAAcF,EAAQ,KApGoB,WAA7BvJ,SAASoJ,kBAClBH,EAAcC,OAAOQ,WACnBC,EACAlC,EAAcO,oBAElB,EAGF,OADAhI,SAAS4J,iBAAiB,mBAAoBT,GACvC,IACLnJ,SAAS6J,oBAAoB,mBAAoBV,EAAmB,EAExEW,iBAAkB,QAKpB,IACM7H,WAAW8H,eACbhI,EAAUgI,aAAe9H,WAAW8H,aAGtC,CADA,MAAOvI,GACP,CAIF,MAAMwI,EAAoD,IAAIC,IAC9D,IAAIC,GAAmB,EACvB,MAAMC,EAAiC,IAAIF,IACrCG,EAAqD,IAAIH,IACzDX,EAAsC,IAAIW,IAC1CI,EAA2B,IAAIC,IAgD9B,SAASC,EAAUC,GACxB,MAAMjL,EAAMkL,EAAOD,GACbE,EAAOV,EAAoBhJ,IAAIzB,IAAQ,IAAI+K,IACjDI,EAAKC,IAAIH,GACTR,EAAoBpK,IAAIL,EAAKmL,EAC/B,CAKO,SAASf,IACdL,EAAQrE,SAASsE,IACVA,IACLA,EAAQC,MAAQ,OAChBoB,EAAerB,GAAQ,GAE3B,CAYAxD,eAAe8E,IACb,IACE,IAAK9I,EAAUgI,aAAc,aACvBhI,EAAUgI,aAAae,QAC3BrD,EAAcG,SACdhB,KAAKC,UAAUkE,MAAMnF,KAAKuE,EAAMa,YAGlC,CADA,MAAOxJ,GACP,CAEJ,CAuDA,SAASiJ,EAAOD,GACd,MAAOS,EAAS5C,GAAamC,EAASU,aACtC,MAAUD,GAAAA,OAAAA,eAAY5C,EACxB,CAEA,SAAS8C,EAAYX,GACnB,MAAMY,EAAUX,EAAOD,GACvB,IAAKA,EAASa,eAAgB,OAAOD,EAErC,MAAMrL,EAAayK,EAASc,gBACtBC,EACJf,EAASgB,yBAA2B1K,OAAO2K,KAAKjB,EAASc,iBACrDI,EAAiB,CAAA,EACvBH,EAAmBtG,SAAS1F,IAC1BmM,EAAGnM,GAAOQ,EAAWR,EAAI,IAG3B,MAAMoM,EAAKnB,EAASoB,sBACdlI,EAAM8G,EAASqB,SAErB,MAAA,GAAAtD,OAAU6C,EAAO,MAAA7C,OAAK3B,KAAKC,UAAU,CACnC6E,KACAC,KACAjI,QAEJ,CA6DA,SAASoI,IACP,MAAMC,EAAwBhB,MAAMnF,KAAKuE,EAAMa,WAC5CjE,KAAIiF,IAAA,IAAEzM,EAAKO,GAAMkM,EAAA,MAAM,CACtBzM,MACA0M,QAASnM,EAAMmM,QAAQC,UACxB,IACAC,MAAK,CAACC,EAAG1G,IAAM0G,EAAEH,QAAUvG,EAAEuG,UAE1BI,EAAuBC,KAAKC,IAChCD,KAAKE,IAAI,EAAGrC,EAAMsC,KAAOhF,EAAcK,YACvCqC,EAAMsC,MAGR,IAAK,IAAItN,EAAI,EAAGA,EAAIkN,EAAsBlN,IACxCgL,EAAMuC,OAAOX,EAAsB5M,GAAGI,IAE1C,CAGA,SAASoN,EACPpN,EACAqI,EACAvC,GAGA,MAAMtC,EAAUsC,EAAKuH,aAAe,GAC9BX,EAAU,IAAI/L,KAAKA,KAAKC,MAAQsH,EAAcC,UAC9CmF,EACF1C,EAAMnJ,IAAI4G,GAEd,GAAIiF,GAAY9J,GAAW8J,EAAS9J,UAAYA,EAG9C,OAFA8J,EAASZ,QAAUA,OACnBpB,IAMAV,EAAMvK,IAAIgI,EAAU,CAClBvC,OACAtC,UACAkJ,UACAa,IAAKzC,EAAY0C,IAAIxN,KAEvBuM,IAGFjB,IAGA,MAAMmC,EAAYhD,EAAoBhJ,IAAIzB,GAC1CyN,GAAaA,EAAU/H,SAASuF,GAGlCzE,eACEyE,EACAnF,SAEMmF,EAASyC,WAAW5H,GAAQmF,EAAS0C,aAC7C,CAR+CC,CAAgB3C,EAAUnF,IACzE,CAUAU,eAAeqH,EAAc5C,GAC3B,MAAMS,QAAEA,EAAOoC,kBAAEA,GAAsB7C,EAAS8C,cAC1CjF,EAAYmC,EAAS+C,eACrBC,EAAahD,EAASa,eACtB9L,EAAMkL,EAAOD,GACb5C,EAAWuD,EAAYX,GAE7B,IAAIiD,EAAUrD,EAAcpJ,IAAI4G,GAuDhC,OAtDK6F,IAoBHA,GAnBmCD,EAC/BtF,EAAQM,oBAAoB,CAC1B3D,KAAMoG,EACN5C,YACAK,QAAS,CACP3I,WAAYyK,EAASc,gBACrBoC,iBAAkBlD,EAASoB,sBAC3B+B,eAAgB5C,MAAMnF,KAAK4E,EAASoD,oBAAoB5C,WACxDtH,IAAK8G,EAASqB,UAEhBvD,QAAS+E,IAEXnF,EAAQC,kBAAkB,CACxBtD,KAAMoG,EACN5C,YACAC,QAAS+E,KAKZQ,MAAMC,IACL,IAAKA,EAAIC,GACP,MAAM,IAAI5H,MAAK,eAAAoC,OAAgBuF,EAAIE,SAKrC,MAHyC,YAArCF,EAAIxF,QAAQtH,IAAI,kBAClBqJ,EAAYM,IAAIpL,GAEXuO,EAAIG,MAAM,IAElBJ,MAAMxI,IACLsH,EAAiBpN,EAAKqI,EAAUvC,GAChC6I,EAAiB1D,GACjBJ,EAAcsC,OAAO9E,GACd,CAAEvC,OAAM8I,SAAS,EAAM7O,OAAQ,cAEvC8O,OAAO5M,IAON4I,EAAcsC,OAAO9E,GAEd,CACLvC,KAAM,KACN/F,OAAQ,QACR6O,SAAS,EACT3K,MAAOhC,MAGb4I,EAAcxK,IAAIgI,EAAU6F,IAEvBA,CACT,CAGO,SAASS,EACd1D,GAEM,IADN6D,0DAEA,MAAM9O,EAAMkL,EAAOD,GACb5C,EAAWuD,EAAYX,IACvB8D,cAAEA,EAAaC,4BAAEA,GAAgC/D,EAAS8C,cAC1DjF,EAAYmC,EAAS+C,eAM3B,GAJIc,GACFhE,EAAYM,IAAIpL,GAIhBkI,EAAcI,gBACdwC,EAAY0C,IAAIxN,IAChBwC,EAAUQ,YACV,CACA,GAAI+G,EAAQyD,IAAIxN,GAAM,OACtB,MAAMgK,EAAyB,CAC7BiF,IAAK,KACL3J,KAAMyJ,EACNjG,YACAC,QAASiG,EACTE,GAAKC,IACH,IACE,GAAmB,qBAAfA,EAAM1K,KAA6B,CACrC,MAAMgJ,EAAYhD,EAAoBhJ,IAAIzB,GAC1CyN,GACEA,EAAU/H,SAASuF,IACjB4C,EAAc5C,EAAS,GAE7B,MAAO,GAAmB,aAAfkE,EAAM1K,KAAqB,CACpC,MAAMiK,EAA2BrH,KAAK+H,MAAMD,EAAMrJ,MAClDsH,EAAiBpN,EAAKqI,EAAUqG,EAClC,CAEA1E,EAAQqF,OAAS,CASnB,CARE,MAAOpN,GAOPqN,EAAWtF,EACb,GAEFqF,OAAQ,EACRpF,MAAO,UAETF,EAAQ1J,IAAIL,EAAKgK,GACjBE,EAAcF,EAChB,CACF,CAEA,SAASsF,EAAWtF,GAClB,GAAsB,SAAlBA,EAAQC,QACZD,EAAQqF,SACJrF,EAAQqF,OAAS,GAAMrF,EAAQiF,KAAkC,IAA3BjF,EAAQiF,IAAIM,YAAmB,CAEvE,MAAMC,EACJzC,KAAK0C,IAAI,EAAGzF,EAAQqF,OAAS,IAAM,IAAuB,IAAhBtC,KAAK2C,UACjDrE,EAAerB,GACfG,YAAW,KACL,CAAC,OAAQ,UAAUwF,SAAS3F,EAAQC,QACxCC,EAAcF,EAAQ,GACrB+C,KAAKC,IAAIwC,EAAO,KACrB,CACF,CAEA,SAASnE,EAAerB,GACjBA,EAAQiF,MACbjF,EAAQiF,IAAIW,OAAS,KACrB5F,EAAQiF,IAAIY,QAAU,KACtB7F,EAAQiF,IAAIa,QACZ9F,EAAQiF,IAAM,KACQ,WAAlBjF,EAAQC,QACVD,EAAQC,MAAQ,YAEpB,CAEA,SAASC,EAAcF,GACrBA,EAAQiF,IAAMtG,EAAQY,gBAAgB,CACpCjE,KAAM0E,EAAQ1E,KACdwD,UAAWkB,EAAQlB,UACnBC,QAASiB,EAAQjB,UAEnBiB,EAAQC,MAAQ,SAChBD,EAAQiF,IAAI5E,iBAAiB,WAAYL,EAAQkF,IACjDlF,EAAQiF,IAAI5E,iBAAiB,mBAAoBL,EAAQkF,IACzDlF,EAAQiF,IAAIY,QAAU,IAAMP,EAAWtF,GACvCA,EAAQiF,IAAIW,OAAS,KACnB5F,EAAQqF,OAAS,CAAC,CAEtB,CC9iBaU,IAAAA,EAAqB,+BAC5BC,EAAqC,CACzCC,OAAQ,WAAA,GAGJC,EAAwC,IAAIxF,IAC5CyF,EAA2B,IAAIpF,IAkBrC,SAASqF,EAAiBC,GACxB,IAAIC,EAASJ,EAASzO,IAAI4O,GAO1B,OALKC,GAEHJ,EAAS7P,IAAIgQ,EADbC,EAAS,CAAED,QAAAA,EAAS7P,WAAY,CAAA,IAI3B8P,CACR,CAED,SAASC,EACPC,EACAC,EACAC,EACAC,EACAC,GAEA,IAAMC,EAAeH,EAAgBF,GAC/BF,EAA0C,CAC9CQ,SAAS,EACTC,cAAeF,EACfG,aAAcH,EACdV,UAAW,GACXK,GAAAA,EACAS,EAAkB,KAClBC,SAAU,IAAIC,kBAAiB,WAK7B,GAAa,aAATV,IAAuBH,EAAOW,EAAlC,CACkB,aAATR,IACPH,EAAOW,EAAmB9G,YAAW,WACnCmG,EAAOW,EAAmB,IADQ,GAEjC,MAEL,IAAMJ,EAAeH,EAAgBF,GAE1B,aAATC,GACAI,EAAaO,aAAed,EAAOU,aAAaI,YAChDP,EAAaQ,mBAAqBf,EAAOU,aAAaK,kBAGpDR,IAAiBP,EAAOU,eAC5BV,EAAOS,cAAgBF,EACvBD,EAAeN,GAbb,CAcH,IACDM,eAAAA,EACAD,SAAAA,EACAD,gBAAAA,GAYF,MAVa,aAATD,GAAuBD,EAAGY,WAC5Bd,EAAOY,SAASI,QAAQd,EAAGY,WAAY,CACrCG,WAAW,EACXC,SAAS,EACThR,YAAY,EACZiR,eAAe,IAGjBnB,EAAOY,SAASI,QAAQd,EA5E5B,SAAyBC,GACvB,MAAgB,SAATA,EACH,CACEc,WAAW,EACXC,SAAS,EACThR,YAAY,EACZiR,eAAe,GAEjB,CACEF,WAAW,EACXC,SAAS,EACThR,YAAY,EACZkR,gBAAiB,CAACjB,GAEzB,CA8D+BkB,CAAgBlB,IAEvCH,CACR,CAED,SAASsB,EACPC,EACAvB,GAEA,IAAMwB,EAAaxB,EAAOI,gBAAgBJ,EAAOE,IACjDF,EAAOU,aAAea,EAClBA,GAAsB,iBAARA,EAEbC,GACDD,EAAIT,aAAeU,EAAWV,YAC9BS,EAAIR,mBAAqBS,EAAWT,mBAEpCf,EAAOQ,SAAU,EACjBiB,MAEOF,IAAQC,IACjBxB,EAAOQ,SAAU,EACjBiB,KAEH,CAED,SAASC,EAAmB1B,GAC1B,IAAIuB,EAAMvB,EAAOS,cACjBT,EAAOH,UAAUzK,SAAQ,SAACuM,GAAA,OAAKJ,EAAMI,EAAEC,OAAOL,MAC9CD,EAkJF,SAA4BO,GAK1B,OAJKC,IACHA,EAAqB3R,SAAS4R,cAAc,QAE9CD,EAAmBE,UAAYH,EACxBC,EAAmBE,SAC3B,CAxJeC,CAAmBV,GAAMvB,EACxC,CACD,SAASkC,EAAoBlC,GAC3B,IAAMuB,EAAM,IAAI9G,IAAIuF,EAAOS,cAAc3P,MAAM,OAAOqR,OAAOC,UAC7DpC,EAAOH,UAAUzK,SAAQ,SAACuM,GAAA,OAAIA,EAAEC,OAAOL,MACvCD,EACEpG,MAAMnF,KAAKwL,GACRY,OAAOC,SACP5Q,KAAK,KACRwO,EAEH,CAED,SAASqC,EAAmBrC,GAC1B,IAAIuB,EAAqBvB,EAAOS,cAChCT,EAAOH,UAAUzK,SAAQ,SAACuM,GAAA,OAAKJ,EAAMI,EAAEC,OAAOL,MAC9CD,EAAcC,EAAKvB,EACpB,CAkBD,SAASsC,EAAuBtC,GAC9B,IAAIuB,EAAMvB,EAAOS,cACjBT,EAAOH,UAAUzK,SAAQ,SAACuM,GACxB,IACMY,EApBV,SAAAhK,GACEiK,IACAC,EAAAA,EAAAA,qBAEM3B,EAAa3Q,SAASuS,cAH5BF,EAAAA,gBAIA,IAAK1B,EAAY,OAAO,KACxB,IAAMC,EAAmB0B,EACrBtS,SAASuS,cAA2BD,GACpC,KACJ,OAAIA,IAAyB1B,EAAyB,KAC/C,CACLD,WAAAA,EACAC,iBAAAA,EAEH,CAMoB4B,CADChB,EAAEC,UAEpBL,EAAMgB,GAAYhB,KAEpBD,EAAcC,EAAKvB,EACpB,CAED,IAAM4C,EAAe,SAAC1C,GAAD,OAAiBA,EAAG8B,SAApB,EACfa,EAAe,SAAC3C,EAAajQ,GAAd,OAAiCiQ,EAAG8B,UAAY/R,CAAhD,EACrB,SAAS6S,EAAqB/C,GAC5B,IAAMgD,EAAgBjD,EAAiBC,GAUvC,OATKgD,EAAclB,OACjBkB,EAAclB,KAAO5B,EACnBF,EACA,OACA6C,EACAC,EACAnB,IAGGqB,EAAclB,IACtB,CAED,IAAMmB,EAAqB,SAAC9C,GAC1B,MAAO,CACLY,WAAYZ,EAAG+C,cACflC,iBAAkBb,EAAGgD,mBAExB,EACKC,EAAqB,SAACjD,EAAajQ,GAErCA,EAAM8Q,mBACL9Q,EAAM6Q,WAAWsC,SAASnT,EAAM8Q,mBAMnC9Q,EAAM6Q,WAAWuC,aAAanD,EAAIjQ,EAAM8Q,iBACzC,EACD,SAASuC,EAAyBvD,GAChC,IAAMgD,EAAgBjD,EAAiBC,GAUvC,OATKgD,EAAcQ,WACjBR,EAAcQ,SAAWtD,EACvBF,EACA,WACAiD,EACAG,EACAb,IAGGS,EAAcQ,QACtB,CAED,IAqDIzB,EAmGAlB,GAxJE4C,GAAgB,SAACtD,EAAaqB,GAAd,OACpBA,EAAOrB,EAAGuD,UAAYlC,EAAOrB,EAAGwD,gBAAgB,QAD5B,EAEhBC,GAAgB,SAACzD,GAAD,OAAiBA,EAAGuD,SAApB,EACtB,SAASG,GAAsB1D,GAC7B,IAAM6C,EAAgBjD,EAAiBI,GAUvC,OATK6C,EAAcc,UACjBd,EAAcc,QAAU5D,EACtBC,EACA,QACAyD,GACAH,GACAtB,IAGGa,EAAcc,OACtB,CAMD,SAASC,GAA0B5D,EAAaC,GAC9C,IALoB4D,EAKdhB,EAAgBjD,EAAiBI,GAUvC,OATK6C,EAAc7S,WAAWiQ,KAC5B4C,EAAc7S,WAAWiQ,GAAQF,EAC/BC,EACAC,GATgB4D,EAUH5D,EAVwB,SAACD,GAAD,IAAA8D,EAAA,cAAAA,EACzC9D,EAAG+D,aAAaF,MAAa,OACV,SAACA,GAAD,OAAsB,SAAC7D,EAAaqB,GAAd,OACjC,OAARA,EAAerB,EAAGgE,aAAaH,EAAUxC,GAAOrB,EAAGwD,gBAAgBK,GADhD,CASfI,CAAahE,GACbkC,IAGGU,EAAc7S,WAAWiQ,EACjC,CA6BD,SAASiE,GACPlE,EACAC,EACAwB,GAEA,GAAKA,EAAEnB,QAAP,CACAmB,EAAEnB,SAAU,EACZ,IAAMe,EAAMI,EAAEjB,aACTiB,EAAE9B,UAAUrQ,QAnCnB,SAAqC0Q,EAAaC,GAChD,IAEqBkE,EAAAC,EAFfvE,EAAUH,EAASzO,IAAI+O,GAC7B,GAAKH,EACL,GAAa,SAATI,EACYS,OAAdyD,EAAAtE,EAAQ8B,cAAMjB,EAAAA,EAAAA,aAAU2D,oBACjBxE,EAAQ8B,UACV,GAAa,UAAT1B,EAAkB,CAAA,IAAAqE,EAAAC,EACV7D,OAAjB4D,EAAAzE,EAAQ8D,iBAASjD,EAAAA,EAAAA,aAAU2D,oBACpBxE,EAAQ8D,OAChB,MAAM,GAAa,aAAT1D,EAAqB,CAAA,IAAAuE,EAAAC,EACZ/D,OAAlB8D,EAAA3E,EAAQwD,kBAAU3C,EAAAA,EAAAA,aAAU2D,oBACrBxE,EAAQwD,QAChB,KAAM,CAAA,IAAAqB,EAAAC,EAAAC,EACL,OAAAF,EAAA7E,EAAQ7P,aAAoB0Q,OAA5BiE,EAAAD,EAAqBzE,YAAOS,EAAAA,EAAAA,aAAU2D,oBAC/BxE,EAAQ7P,WAAWiQ,EAC3B,CACF,CAoBG4E,CAA4B7E,EAAIC,GAElCwB,EAAEtB,SAASH,EAAIqB,EANC,CAOjB,CAED,SAASlB,GAASsB,EAAkBzB,GAClCyB,EAAEE,MAAQuC,GAA6BlE,EAAI,OAAQyB,EAAEE,MACrDF,EAAEkC,SAAWO,GAAkClE,EAAI,QAASyB,EAAEkC,SAC9DlC,EAAE4B,UAAYa,GAAiClE,EAAI,WAAYyB,EAAE4B,UACjEtS,OAAO2K,KAAK+F,EAAEzR,YAAYkF,SAAQ,SAAI+K,GACpCiE,GAAkClE,EAAIC,EAAMwB,EAAEzR,WAAWiQ,MAE5D,CAED,SAASsB,KACP7B,EAASxK,QAAQiL,GAClB,CAsCD,SAAS2E,GAAmBC,GAG1B,GAAsB,aAAlBA,EAASC,MAAkD,IAA3BD,EAASrF,SAAShD,KAAtD,CAEA,IAAMuI,EAAmB,IAAI1K,IAAIwK,EAASrF,UACjBzP,SAASiV,iBAAiBH,EAASI,UAE3CjQ,SAAQ,SAAE8K,GACpBiF,EAAiBjI,IAAIgD,KACxB+E,EAASrF,SAAS9E,IAAIoF,GA7C5B,SAAuB+E,EAAoBlF,GACzC,IAAIC,EAAiD,KAC/B,SAAlBiF,EAASC,KACXlF,EAAS8C,EAAqB/C,GACH,UAAlBkF,EAASC,KAClBlF,EAAS4D,GAAsB7D,GACJ,cAAlBkF,EAASC,KAClBlF,EAAS8D,GAA0B/D,EAASkF,EAASK,WAC1B,aAAlBL,EAASC,OAClBlF,EAASsD,EAAyBvD,IAE/BC,IACLA,EAAOH,UAAU3K,KAAK+P,GACtBjF,EAAOM,eAAeN,GACvB,CAgCKuF,CAAcN,EAAU/E,MARsC,CAWnE,CAQD,SAASsF,KACP3F,EAAUzK,QAAQ4P,GACnB,CA4BD,SAASS,GAAY9D,GAEnB,MAAwB,oBAAbxR,SAAiCuP,GAE5CG,EAAU/E,IAAI6G,GAEdqD,GAAmBrD,GACZ,CACLhC,OAAQ,WA5CZ,IAAwBsF,KA6CHtD,GA5CV/B,SAASxK,SAAQ,SAAE8K,GAAA,OAnC9B,SAAsB+E,EAAoB/E,GACxC,IAAIF,EAAiD,KAUrD,GATsB,SAAlBiF,EAASC,KACXlF,EAAS8C,EAAqB5C,GACH,UAAlB+E,EAASC,KAClBlF,EAAS4D,GAAsB1D,GACJ,cAAlB+E,EAASC,KAClBlF,EAAS8D,GAA0B5D,EAAI+E,EAASK,WACrB,aAAlBL,EAASC,OAClBlF,EAASsD,EAAyBpD,IAE/BF,EAAL,CACA,IAAM0F,EAAQ1F,EAAOH,UAAU8F,QAAQV,IACxB,IAAXS,GAAc1F,EAAOH,UAAU+F,OAAOF,EAAO,GACjD1F,EAAOM,eAAeN,EAHT,CAId,CAoBiC6F,CAAaZ,EAAU/E,MACvD+E,EAASrF,SAASkG,QAClBjG,EAAS,OAAQoF,EA2Cd,GAEJ,CAED,SAASpD,GACPwD,EACAzD,GAEA,OAAO6D,GAAY,CACjBP,KAAM,OACNtF,SAAU,IAAInF,IACdmH,OAAAA,EACAyD,SAAAA,GAEH,CAcD,SAASxB,GACPwB,EACAzD,GAEA,OAAO6D,GAAY,CACjBP,KAAM,QACNtF,SAAU,IAAInF,IACdmH,OAAAA,EACAyD,SAAAA,GAEH,CAED,SAASC,GACPD,EACAC,EACA1D,GAEA,OAAKnC,EAAmBhL,KAAK6Q,GAEX,UAAdA,GAAuC,cAAdA,EACpBzB,GAAQwB,GAAU,SAAUU,GACjC,IAAMC,EAAoBpE,EAAO1G,MAAMnF,KAAKgQ,GAAYvU,KAAK,MAC7DuU,EAAWD,QACNE,GACLA,EACGlV,MAAM,QACNqR,OAAOC,SACPhN,SAAQ,SAACa,GAAA,OAAI8P,EAAWjL,IAAI7E,KAChC,IAGIwP,GAAY,CACjBP,KAAM,YACNI,UAAAA,EACA1F,SAAU,IAAInF,IACdmH,OAAAA,EACAyD,SAAAA,IAnB8C3F,CAqBjD,CAhGyB,oBAAbvP,WAENyQ,KACHA,GAAW,IAAIC,kBAAiB,WAC9B2E,IACD,KAGHA,KACA5E,GAASI,QAAQ7Q,SAAS8V,gBAAiB,CACzChF,WAAW,EACXC,SAAS,EACThR,YAAY,EACZiR,eAAe,KC3WnB,MAAM+E,GAAyC,CAAA,EAGxC,SAASC,GACdC,EACAC,GAIA,IAAK,MAAO/Q,EAAGD,KAAMpE,OAAOkK,QAAQkL,GAClC,OAAQ/Q,GACN,IAAK,MACH,IAAKgR,GAAOF,EAAK/Q,GAA4B,OAAO,EACpD,MACF,IAAK,OACH,GAAIiR,GAAOF,EAAK/Q,GAA4B,OAAO,EACnD,MACF,IAAK,OACH,IAAKkR,GAAQH,EAAK/Q,GAA4B,OAAO,EACrD,MACF,IAAK,OACH,GAAI8Q,GAAcC,EAAK/Q,GAA0B,OAAO,EACxD,MACF,QACE,IAAKmR,GAAmBnR,EAAGoR,GAAQL,EAAK9Q,IAAK,OAAO,EAG1D,OAAO,CACT,CAGA,SAASmR,GAAQL,EAAgBnU,GAC/B,MAAMX,EAAQW,EAAKnB,MAAM,KACzB,IAAI4V,EAAeN,EACnB,IAAK,IAAI9W,EAAI,EAAGA,EAAIgC,EAAM9B,OAAQF,IAAK,CACrC,IAAIoX,GAA8B,iBAAZA,KAAwBpV,EAAMhC,KAAMoX,GAGxD,OAAO,KAFPA,EAAUA,EAAQpV,EAAMhC,GAI5B,CACA,OAAOoX,CACT,CAWA,SAASF,GAAmBH,EAA2BpW,GAErD,GAAyB,iBAAdoW,EACT,OAAOpW,EAAQ,KAAOoW,EAExB,GAAyB,iBAAdA,EACT,OAAe,EAARpW,IAAcoW,EAEvB,GAAyB,kBAAdA,EACT,QAASpW,IAAUoW,EAGrB,GAAkB,OAAdA,EACF,OAAiB,OAAVpW,EAGT,GAAIiL,MAAMyL,QAAQN,KAAeO,GAAiBP,GAChD,OAAOtP,KAAKC,UAAU/G,KAAW8G,KAAKC,UAAUqP,GAIlD,IAAK,MAAMQ,KAAMR,EACf,IACGS,GACCD,EACA5W,EACAoW,EAAUQ,IAGZ,OAAO,EAGX,OAAO,CACT,CAGA,SAASD,GAAiBR,GACxB,MAAMxK,EAAO3K,OAAO2K,KAAKwK,GACzB,OACExK,EAAKpM,OAAS,GAAKoM,EAAKuG,QAAQ7M,GAAe,MAATA,EAAE,KAAY9F,SAAWoM,EAAKpM,MAExE,CA2BA,SAASuX,GAAKlS,EAAaC,GAEzB,OAAIoG,MAAMyL,QAAQ9R,GACTA,EAAOU,MAAM2K,GAAOpL,EAASuK,SAASa,KAExCpL,EAASuK,SAASxK,EAC3B,CAGA,SAASiS,GACPE,EACAnS,EACAC,GAEA,OAAQkS,GACN,IAAK,OACH,OAAO/P,EAAoBpC,KAAYoC,EAAoBnC,GAC7D,IAAK,OACH,OAAOmC,EAAoBpC,KAAYoC,EAAoBnC,GAC7D,IAAK,OACH,OAAOmC,EAAoBpC,GAAUoC,EAAoBnC,GAC3D,IAAK,QACH,OAAOmC,EAAoBpC,IAAWoC,EAAoBnC,GAC5D,IAAK,OACH,OAAOmC,EAAoBpC,GAAUoC,EAAoBnC,GAC3D,IAAK,QACH,OAAOmC,EAAoBpC,IAAWoC,EAAoBnC,GAC5D,IAAK,MACH,OAAOD,IAAWC,EACpB,IAAK,MACH,OAAOD,IAAWC,EACpB,IAAK,MACH,OAAOD,EAASC,EAClB,IAAK,OACH,OAAOD,GAAUC,EACnB,IAAK,MACH,OAAOD,EAASC,EAClB,IAAK,OACH,OAAOD,GAAUC,EACnB,IAAK,UAEH,OAAOA,EAAqB,MAAVD,EAA2B,MAAVA,EACrC,IAAK,MACH,QAAKqG,MAAMyL,QAAQ7R,IACZiS,GAAKlS,EAAQC,GACtB,IAAK,OACH,QAAKoG,MAAMyL,QAAQ7R,KACXiS,GAAKlS,EAAQC,GACvB,IAAK,OACH,OAAQ0R,GAAmB1R,EAAUD,GACvC,IAAK,QACH,QAAKqG,MAAMyL,QAAQ9R,IACZ2R,GAAmB1R,EAAUD,EAAOrF,QAC7C,IAAK,aACH,OAnEN,SAAmBqF,EAAaC,GAC9B,IAAKoG,MAAMyL,QAAQ9R,GAAS,OAAO,EACnC,MAAMoS,EAAQL,GAAiB9R,GAC1BO,GAAWmR,GAAmB1R,EAAUO,GACxCA,GAAW8Q,GAAc9Q,EAAGP,GACjC,IAAK,IAAIxF,EAAI,EAAGA,EAAIuF,EAAOrF,OAAQF,IACjC,GAAIuF,EAAOvF,IAAM2X,EAAMpS,EAAOvF,IAC5B,OAAO,EAGX,OAAO,CACT,CAwDa4X,CAAUrS,EAAQC,GAC3B,IAAK,OACH,IAAKoG,MAAMyL,QAAQ9R,GAAS,OAAO,EACnC,IAAK,IAAIvF,EAAI,EAAGA,EAAIwF,EAAStF,OAAQF,IAAK,CACxC,IAAI6X,GAAS,EACb,IAAK,IAAIC,EAAI,EAAGA,EAAIvS,EAAOrF,OAAQ4X,IACjC,GAAIZ,GAAmB1R,EAASxF,GAAIuF,EAAOuS,IAAK,CAC9CD,GAAS,EACT,KACF,CAEF,IAAKA,EAAQ,OAAO,CACtB,CACA,OAAO,EACT,IAAK,SACH,IACE,OAlJU3S,EAkJMM,EAjJjBoR,GAAY1R,KACf0R,GAAY1R,GAAS,IAAIf,OAAOe,EAAM/D,QAAQ,aAAc,WAEvDyV,GAAY1R,IA8IaC,KAAKI,EAGjC,CAFE,MAAOlD,GACP,OAAO,CACT,CACF,IAAK,QACH,OAnGN,SAAiB0D,GACf,GAAU,OAANA,EAAY,MAAO,OACvB,GAAI6F,MAAMyL,QAAQtR,GAAI,MAAO,QAC7B,MAAMgS,SAAWhS,EACjB,MAAI,CAAC,SAAU,SAAU,UAAW,SAAU,aAAagK,SAASgI,GAC3DA,EAEF,SACT,CA2FaC,CAAQzS,KAAYC,EAC7B,QAEE,OADApB,QAAQC,MAAM,qBAAuBqT,IAC9B,EA1Jb,IAAkBxS,CA4JlB,CAGA,SAAS8R,GAAOF,EAAgBmB,GAC9B,IAAKA,EAAW/X,OAAQ,OAAO,EAC/B,IAAK,IAAIF,EAAI,EAAGA,EAAIiY,EAAW/X,OAAQF,IACrC,GAAI6W,GAAcC,EAAKmB,EAAWjY,IAChC,OAAO,EAGX,OAAO,CACT,CAGA,SAASiX,GAAQH,EAAgBmB,GAC/B,IAAK,IAAIjY,EAAI,EAAGA,EAAIiY,EAAW/X,OAAQF,IACrC,IAAK6W,GAAcC,EAAKmB,EAAWjY,IACjC,OAAO,EAGX,OAAO,CACT,CC9KA,MAAMkY,GACc,oBAAXnO,QAA8C,oBAAblJ,SAEpCsX,GJoRC,WACL,IAAIvU,EACJ,IAEEA,EAAU,OAGZ,CAFE,MAAOvB,GACPuB,EAAU,EACZ,CACA,OAAOA,CACT,CI7RoBwU,GChBb,MAAeC,GAapBzR,wBACEhG,GAEA,MAAM0X,EAAkD,CAAA,EAaxD,aAXQC,QAAQC,IACZ7W,OAAOkK,QAAQjL,GAAYgH,KAAIqB,IAAA,IAAE1H,EAAekX,GAAexP,EAAA,OAC7DzG,KAAKkW,eAAenX,EAAekX,EAAe,MAGtD3S,SAAS6S,IACT,GAAIA,EAAK,CACP,MAAMvY,YAASuY,EAAIpX,cAAkBoX,MAAAA,OAAAA,EAAIF,gBACzCH,EAAKlY,GAAOuY,CACd,KAEKL,CACT,ECvCFvO,OAAO6O,UAAY7O,OAAO6O,WAAa,GAEvC,MAAMC,GAAgBhY,SAASgY,cACzBC,GAA4BD,GAAgBA,GAAcE,QAAU,CAAA,EACpEC,GAA+BjP,OAAOkP,mBAAqB,GASjE,SAASC,GAAUxY,GACjB,MACMsB,GADQ,KAAOnB,SAASY,QACVD,MAAK,KAAA4H,OAAM1I,EAAQ,MACvC,OAAwB,IAAjBsB,EAAM9B,OAAe8B,EAAM,GAAGR,MAAM,KAAK,GAAK,EACvD,CAGA,SAAS2X,KACP,OAAIpP,OAAO7G,QAAUA,OAAOkW,WAAmBlW,OAAOkW,aAC/C,uCAAwCjY,QAAQ,UAAWwF,IAE5DA,EACDzD,OAAOmW,gBAAgB,IAAI7S,WAAW,IAAI,GACxC,IAASG,EAA2B,GACvCY,SAAS,KAEf,CAEA,MAAM+R,GACJN,GAAcO,gBAAkBT,GAAYS,gBAAkB,SAC1DC,GAAUR,GAAcQ,SAAWV,GAAYU,SAAW,KAChE,IAwIIC,GAxIAC,GAAOV,GAAcU,MAAQZ,GAAYY,MAAQ,GACrD,SAASC,MA7BT,SAAmBjZ,EAAcC,GAC/B,MAAMiZ,EAAI,IAAI7Y,KAEd6Y,EAAEC,QAAQD,EAAE7M,UAAY,QACxBlM,SAASY,OAASf,EAAO,IAAMC,EAAQ,mBAAqBiZ,EAAE3Y,aAChE,CAyBE6Y,CAAUR,GAAaI,GACzB,CAkBA,SAASK,KAEP,IAAIC,EAA+B,CAAA,EACnC,IACE,MAAMtM,EAAWuM,eAAeC,QAAQ,cAMxC,GALIxM,IACFsM,EAAOvS,KAAK+H,MAAM9B,IAIhByM,SAASC,OAAQ,CACnB,MAAMC,EAAS,IAAIC,gBAAgBH,SAASC,QAC5C,IAAIG,GAAa,EACjB,CAAC,SAAU,SAAU,WAAY,OAAQ,WAAWzU,SAASE,IAE3D,MAAMwU,EAAexU,OAAAA,OAAAA,GAEf6K,EAAO,MAAQ7K,EAAE,GAAGyU,cAAgBzU,EAAE/D,MAAM,GAE9CoY,EAAOzM,IAAI4M,KACbR,EAAKnJ,GAAQwJ,EAAOxY,IAAI2Y,IAAU,GAClCD,GAAa,EACf,IAIEA,GACFN,eAAetO,QAAQ,aAAclE,KAAKC,UAAUsS,GAExD,CAEA,CADA,MAAO3X,GACP,CAGF,OAAO2X,CACT,CAEA,SAASU,KACP,IAAK3Q,OAAO6O,YAAc7O,OAAO6O,UAAU9S,QAAS,MAAO,GAC3D,MAAMgR,EAA+B,CAAA,EAqBrC,OApBA/M,OAAO6O,UAAU9S,SAAS6U,IAEnBA,GAAwB,iBAATA,KAAqB,WAAYA,KAGjD,UAAWA,GAEfhZ,OAAO2K,KAAKqO,GAAM7U,SAASE,IAEzB,GAAiB,iBAANA,GAAkBA,EAAErB,MAAM,UAAW,OAEhD,MAAMsN,EAAO0I,EAAiC3U,GAI1C,CAAC,SAAU,SAAU,WAAW+J,gBADXkC,KAEvB6E,EAAI9Q,GAAKiM,EACX,IACA,IAEG6E,CACT,CA0CA,SAAS3K,KAEP,MAAMvL,EAAakY,GAA8B,iBAC7C,CAAE,EA3CR,SACEA,EACAE,GAEA,MAAM4B,EAA0C,MAA7B9B,EAAY+B,cAEzBC,EAAKC,UAAUC,UAEfC,EAAUH,EAAGnW,MAAM,OACrB,OACAmW,EAAGnW,MAAM,UACT,SACAmW,EAAGnW,MAAM,WACT,UACAmW,EAAGnW,MAAM,UACT,SACA,UAEEuW,EAlGR,WAAiC,IAAhBC,6DAEf,OAAIzB,KAGJA,GAAOR,GAAUI,IACbI,KAGJA,GAAOP,KACHgC,GACFxB,KAGKD,IACT,CAmFgB0B,CAAQR,GAQtB,OANG5B,EAAcqC,mBAAqBvC,EAAYuC,oBAChDT,GAEAjB,KAGK,IACFe,KACHlB,CAACA,IAAU0B,EACX3W,IAAK4V,SAAS/U,KACdzC,KAAMwX,SAASxU,SACfD,KAAMyU,SAASzU,KACf4V,MAAOnB,SAASC,OAChBmB,UAAW1a,UAAYA,SAAS2a,MAChCC,WAAYX,EAAGnW,MAAM,QAAU,SAAW,UAC1CsW,aACGlB,KAEP,CAMM2B,CAAkB5C,GAAaE,IAInC,OAHIA,GAAcpY,YAChBe,OAAO7B,OAAOc,EAAYoY,GAAcpY,YAEnCA,CACT,CAK2C,WAAzCoY,GAAc2C,wBACyB,WAAvC7C,GAAY6C,uBAEZlC,GAAsB,IDtCjB,cAA+CpB,GAWpDuD,YAQGhS,GAAA,IARSiS,OACVA,EAAS,oBAAmBC,SAC5BA,EAAQC,iBACRA,EAAmB,CAAC,GAKrBnS,EACCoS,QACAxZ,KAAKqZ,OAASA,EACdrZ,KAAKsZ,SAAWA,EAChBtZ,KAAKuZ,iBAAmBA,CAC1B,CACAnV,qBAAqBrF,EAAuBkX,GAC1C,MAAMrY,EAAG,GAAAgJ,OAAM7H,EAAa,MAAA6H,OAAKqP,GACjC,IAAIE,EAAwC,KAC5C,IAAKnW,KAAKsZ,SAAU,OAAOnD,EAC3B,IACE,MAAMsD,EAAMzZ,KAAKsZ,SAASja,IAAIW,KAAKqZ,OAASzb,GACtC8F,EAAOuB,KAAK+H,MAAMyM,GAAO,MAC3B/V,EAAK3E,eAAiB2E,EAAKuS,gBAAkBvS,EAAKgW,cACpDvD,EAAMzS,EAGR,CADA,MAAO7D,GACP,CAEF,OAAOsW,CACT,CACA/R,sBAAsB+R,GACpB,MAAMvY,YAASuY,EAAIpX,cAAkBoX,MAAAA,OAAAA,EAAIF,gBACzC,IAAKjW,KAAKsZ,SAAU,OACpB,MAAMxY,EAAMmE,KAAKC,UAAUiR,GAC3BnW,KAAKsZ,SAASrb,IAAI+B,KAAKqZ,OAASzb,EAAKkD,EAAKd,KAAKuZ,iBACjD,GCP2D,CACzDF,OACE7C,GAAcmD,oBACdrD,GAAYqD,yBACZnZ,EACF8Y,SAAUM,IAG6B,iBAAzCpD,GAAc2C,wBACyB,iBAAvC7C,GAAY6C,yBAEZlC,GAAsB,IDhJjB,cAA8CpB,GAGnDuD,YAAYS,GACVA,EAAOA,GAAQ,GACfL,QACAxZ,KAAKqZ,OAASQ,EAAKR,QAAU,oBAC7B,IACErZ,KAAKoI,aAAeyR,EAAKzR,cAAgB9H,WAAW8H,YAEpD,CADA,MAAOvI,GACP,CAEJ,CACAuE,qBAAqBrF,EAAuBkX,GAC1C,MAAMrY,EAAG,GAAAgJ,OAAM7H,EAAa,MAAA6H,OAAKqP,GACjC,IAAIE,EAAwC,KAC5C,IAAKnW,KAAKoI,aAAc,OAAO+N,EAC/B,IACE,MAAMsD,QAAazZ,KAAKoI,aAAasP,QAAQ1X,KAAKqZ,OAASzb,IAAS,KAC9D8F,EAAOuB,KAAK+H,MAAMyM,GACpB/V,EAAK3E,eAAiB2E,EAAKuS,gBAAkBvS,EAAKgW,cACpDvD,EAAMzS,EAGR,CADA,MAAO7D,GACP,CAEF,OAAOsW,CACT,CACA/R,sBAAsB+R,GACpB,MAAMvY,YAASuY,EAAIpX,cAAkBoX,MAAAA,OAAAA,EAAIF,gBACzC,GAAKjW,KAAKoI,aACV,UACQpI,KAAKoI,aAAae,QAAQnJ,KAAKqZ,OAASzb,EAAKqH,KAAKC,UAAUiR,GAElE,CADA,MAAOtW,GACP,CAEJ,GC4G0D,CACxDwZ,OACE7C,GAAcmD,oBACdrD,GAAYqD,yBACZnZ,KAIN,MAAMsZ,GAAK,IFvKJ,MA8CLV,YAAYW,GAyBV,GAxBAA,EAAUA,GAAW,GAGrB/Z,KAAKoB,QAAUuU,GACf3V,KAAKga,EAAOha,KAAK+Z,QAAUA,EAC3B/Z,KAAKia,EAAYF,EAAQG,UAAY,KACrCla,KAAKma,EAAsB,IAAIxR,IAC/B3I,KAAKoa,EAAsB,IAAIzR,IAC/B3I,KAAKqa,EAAmB,GACxBra,KAAKsa,QAAUP,EAAQO,MACvBta,KAAKua,EAAiB,IAAI5R,IAC1B3I,KAAKwa,EAAW,GAChBxa,KAAKya,EAAW,EAChBza,KAAK0a,OAAQ,EACb1a,KAAK2a,EAAY,IAAIrS,IACrBtI,KAAK4a,EAAuB,IAAItS,IAChCtI,KAAK6a,EAAsB,GAC3B7a,KAAK8a,EAAyB,IAAIxS,IAClCtI,KAAK+a,EAAoB,IAAIpS,IAC7B3I,KAAKgb,GAAe,EACpBhb,KAAKib,EAAiB,GACtBjb,KAAKkb,EAAyB,IAAI5S,IAClCtI,KAAKmb,GAA2BpB,EAAQqB,yBAEpCrB,EAAQlO,WAAY,CACtB,GAAIkO,EAAQxV,cACV,MAAM,IAAIC,MAAM,8CAElB,IAAKuV,EAAQrT,UACX,MAAM,IAAIlC,MAAM,qBAElB,IAAI6W,GAAW,EACf,IACEA,IAAa,IAAI5Y,IAAIsX,EAAQzQ,SAAW,IAAIgS,SAASnZ,MACnD,mBAGF,CADA,MAAOtC,GACP,CAEF,GAAIwb,EACF,MAAM,IAAI7W,MAAM,4CAEpB,MACE,GAAIuV,EAAQnQ,mBACV,MAAM,IAAIpF,MAAM,mDAqBpB,GAjBIuV,EAAQwB,WACVvb,KAAK0a,OAAQ,GAGXhF,IAAaqE,EAAQyB,gBACvBjU,OAAOkU,YAAczb,KACrB3B,SAASqd,cAAc,IAAIC,MAAM,cAG/B5B,EAAQ6B,aACV5b,KAAK0a,OAAQ,EACb1a,KAAK6b,KACI9B,EAAQ+B,aACjB9b,KAAK+b,IAIH/b,KAAKga,EAAK/C,qBAAuBjX,KAAKga,EAAKgC,2BAC7C,IAAK,MAAMpe,KAAOoC,KAAKga,EAAKgC,2BAA4B,CACtD,MAAM7F,EAAMnW,KAAKga,EAAKgC,2BAA2Bpe,GAC7CuY,GACFnW,KAAKga,EAAK/C,oBAAoBgF,gBAAgB9F,GAAK1J,OAAM,QAI7D,CAIEzM,KAAK0a,OACP1a,KAAKkc,qBAAqBlc,KAAKuL,aAEnC,CAEAnH,iBAAwB2C,GACtB/G,KAAKmc,EAAWpV,EAChB,MAAMrD,QAAa1D,KAAKoc,eAAerV,GACvC/G,KAAKqc,EAAoB3Y,QACnB1D,KAAKkc,qBAAqBxY,GAC5BA,EAAK6X,WACPvb,KAAKga,EAAKuB,SAAW7X,EAAK6X,UAExB7X,EAAKkY,cACP5b,KAAKga,EAAK4B,YAAclY,EAAKkY,YAC7B5b,KAAK6b,KAEP7b,KAAK0a,OAAQ,EACb1a,KAAKsc,GACP,CAEOC,SAASvV,GACdhH,KAAKgb,GAAe,EAEpB,MAAMjU,EAAUC,EAAQD,QAExB,GAAIA,EAAQyV,sBAAwBzV,EAAQ0V,kBAC1C,MAAM,IAAIjY,MAAM,gDAGlB,GACExE,KAAKga,EAAK/C,sBACTjX,KAAKga,EAAKgC,2BAEX,MAAM,IAAIxX,MACR,4FAgBJ,GAZAxE,KAAKmc,EAAWpV,EAChB/G,KAAKqc,EAAoBtV,EACrBA,EAAQwU,WACVvb,KAAKga,EAAKuB,SAAWxU,EAAQwU,UAE3BxU,EAAQ6U,cACV5b,KAAKga,EAAK4B,YAAc7U,EAAQ6U,YAChC5b,KAAK6b,KAGP7b,KAAK0a,OAAQ,EAET1T,EAAQ0V,UAAW,CACrB,IAAK1c,KAAKga,EAAKtT,UACb,MAAM,IAAIlC,MAAM,8CAElB+H,EAAiBvM,MAAM,GACvB4I,EAAU5I,KACZ,CAEA,OAAOA,IACT,CAEAoE,WAAkB4C,GAIhB,GAHAhH,KAAKgb,GAAe,GAEpBhU,EAAUA,GAAW,IACTD,QAAS,CAEnB,SADM/G,KAAKsL,WAAWtE,EAAQD,SAC1BC,EAAQ0V,UAAW,CACrB,IAAK1c,KAAKga,EAAKtT,UACb,MAAM,IAAIlC,MAAM,8CAElB+H,EAAiBvM,MAAM,GACvB4I,EAAU5I,KACZ,CAEA,MAAO,CACLwM,SAAS,EACT7O,OAAQ,OAEZ,CAAO,CACL,MAAM+F,KAAEA,KAASyI,SAAcnM,KAAK2c,EAAS,IACxC3V,EACH4V,YAAY,IAOd,OALI5V,EAAQ0V,WACV9T,EAAU5I,YAGNA,KAAKsL,WAAW5H,GAAQ,CAAE,GACzByI,CACT,CACF,CAGA/H,mBAA0B4C,GACxBhH,KAAKgb,GAAe,GAEpBhU,EAAUA,GAAW,IACT6V,cAEV7c,KAAKga,EAAK8C,oBAAqB,GAEjC,MAAMpZ,KAAEA,SAAe1D,KAAK2c,EAAS,IAChC3V,EACH4V,YAAY,UAER5c,KAAKsL,WAAW5H,GAAQ,CAAE,GAE5B1D,KAAK+c,KACPnU,EAAU5I,KAEd,CAEAoE,sBACE4C,GAEA,MAAMmF,QAAYnM,KAAK2c,EAAS,IAC1B3V,GAAW,CAAA,EACf4V,YAAY,IAEVzQ,EAAIzI,YACA1D,KAAKsL,WAAWa,EAAIzI,KAE9B,CAEO6F,aACL,MAAO,CAACvJ,KAAK2L,cAAcrC,QAAStJ,KAAK4L,eAC3C,CACOD,cAML,MAAMqR,EAAchd,KAAKga,EAAK1Q,SAAW,4BACzC,MAAO,CACLA,QAAS0T,EAAYre,QAAQ,OAAQ,IACrCgO,eAAgB3M,KAAKga,EAAKrN,eAAiBqQ,GAAare,QACtD,OACA,IAEF+M,kBAAmB1L,KAAKga,EAAKiD,sBAC7BrQ,4BAA6B5M,KAAKga,EAAKpN,4BAE3C,CACOhB,eACL,OAAO5L,KAAKga,EAAKtT,WAAa,EAChC,CACO6E,aACL,OACEvL,KAAKmc,GAAY,CACfZ,SAAUvb,KAAKkd,cACftB,YAAa5b,KAAKmd,iBAGxB,CACOC,sBACL,OAAOpd,KAAKqc,GAAqBrc,KAAKuL,YACxC,CAEO7B,eACL,OAAO1J,KAAKga,EAAKnO,aAAc,CACjC,CAEOhC,wBACL,OAAO7J,KAAKga,EAAKpQ,kBACnB,CAEAxF,QAQGqC,GAAA,IAAAK,EAAA,IARoBuW,QACrBA,EAAOC,UACPA,EAASV,WACTA,EAAUF,UACVA,GAIDjW,EACC,IAAKzG,KAAKga,EAAKtT,UACb,MAAM,IAAIlC,MAAM,qBAGlB,OHjPGJ,eAYoBmZ,GAAA,IAZW1U,SACpCA,EAAQwU,QACRA,EAAOC,UACPA,EAASV,WACTA,EAAU1W,eACVA,GAODqX,EAKC,OAJKrX,IACHJ,EAAcI,gBAAiB,GAqDnC9B,eAU2BoZ,GAAA,IAVW3U,SACpCA,EAAQ+T,WACRA,EAAUS,QACVA,EAAOC,UACPA,GAMDE,EACC,MAAM5f,EAAMkL,EAAOD,GACb5C,EAAWuD,EAAYX,GACvBrK,EAAM,IAAID,KAEVkf,EAAa,IAAIlf,KACrBC,EAAI+L,UAAYzE,EAAcE,OAASF,EAAcC,gBAyFzD3B,iBACE,IAAImE,EAAJ,CACAA,GAAmB,EACnB,IACE,GAAInI,EAAUgI,aAAc,CAC1B,MAAMjK,QAAciC,EAAUgI,aAAasP,QACzC5R,EAAcG,UAEhB,IAAKH,EAAcQ,cAAgBnI,EAAO,CACxC,MAAMqE,EAAiCyC,KAAK+H,MAAM7O,GAC9CqE,GAAU4G,MAAMyL,QAAQrS,IAC1BA,EAAOc,SAAQoa,IAAiB,IAAf9f,EAAK8F,GAAKga,EACzBlV,EAAMvK,IAAIL,EAAK,IACV8F,EACH4G,QAAS,IAAI/L,KAAKmF,EAAK4G,UACvB,IAGNH,GACF,CACF,CAEA,CADA,MAAOtK,GACP,CAEqC,CACrC,MAAM8d,EAAYpX,EAAQc,oBACtBsW,IACFpX,EAAQ4B,iBAAmBwV,EAE/B,CA5BsB,CA6BxB,CApHQC,GACN,MAAM1S,EACHpF,EAAcQ,cAAiBgX,OAAkC9c,EAAtBgI,EAAMnJ,IAAI4G,GACxD,GACEiF,IACC0R,GAAc1R,EAASZ,QAAU9L,IAClC0M,EAASZ,QAAUmT,EAanB,OAVIvS,EAASC,KAAKzC,EAAYM,IAAIpL,GAG9BsN,EAASZ,QAAU9L,EACrBiN,EAAc5C,GAId0D,EAAiB1D,GAEZ,CAAEnF,KAAMwH,EAASxH,KAAM8I,SAAS,EAAM7O,OAAQ,SAChD,CACL,MAAMwO,QA0CV,SACEL,EACAuR,GAEA,OAAO,IAAItH,SAAS8H,IAClB,IACIC,EADAC,GAAW,EAEf,MAAMC,EAAUta,IACVqa,IACJA,GAAW,EACXD,GAASpW,aAAaoW,GACtBD,EAAQna,GAAQ,MAAK,EAGnB2Z,IACFS,EAAQ/V,YAAW,IAAMiW,KAAUX,IAGrCvR,EAAQI,MAAMxI,GAASsa,EAAOta,KAAO+I,OAAM,IAAMuR,KAAS,GAE9D,CA9DsBC,CAAexS,EAAc5C,GAAWwU,GAC1D,OACElR,GAAO,CACLzI,KAAM,KACN8I,SAAS,EACT7O,OAAQ,UACRkE,MAAO,IAAI2C,MAAM,WAGvB,CACF,CApGS0Z,CAAuB,CAC5BrV,WACA+T,aACAS,UACAC,aAEJ,CG0NWa,CAAgB,CACrBtV,SAAU7I,KACVqd,UACAC,UAAWA,GAAatd,KAAKga,EAAK1T,aAClCsW,aACA1W,eAAyD,QAAzCwW,EAAAA,QAAAA,EAAa1c,KAAKga,EAAK9T,sBAAkB,IAAAY,GAAAA,GAE7D,CAEQwV,IACN,GAAItc,KAAKia,EACP,IACEja,KAAKia,GAGP,CAFE,MAAOpa,GACP+B,QAAQC,MAAM,mBAAoBhC,EACpC,CAEJ,CAGOue,YAAY7C,GACjBvb,KAAKga,EAAKuB,SAAWA,EACrBvb,KAAK0a,OAAQ,EACb1a,KAAKsc,GACP,CAGAlY,2BACEE,EACAC,EACA5D,GAEA,MAAM0d,QAAqBha,EACzBC,EACAC,GAAiBvE,KAAKga,EAAKzV,cAC3B5D,GAEFX,KAAKoe,YACHnZ,KAAK+H,MAAMqR,GAEf,CAGOC,eAAe1C,GACpB5b,KAAKga,EAAK4B,YAAcA,EACxB5b,KAAK0a,OAAQ,EACb1a,KAAK6b,GACP,CAGAzX,8BACEE,EACAC,EACA5D,GAEA,MAAM4d,QAAwBla,EAC5BC,EACAC,GAAiBvE,KAAKga,EAAKzV,cAC3B5D,GAEFX,KAAKse,eAAerZ,KAAK+H,MAAMuR,GACjC,CAEAna,qBACEV,EACAa,EACA5D,GAuBA,OArBA+C,EAAO,IAAKA,IACH+Y,oBACP/Y,EAAK6X,SAAWtW,KAAK+H,YACb3I,EACJX,EAAK+Y,kBACLlY,GAAiBvE,KAAKga,EAAKzV,cAC3B5D,WAGG+C,EAAK+Y,mBAEV/Y,EAAK8Y,uBACP9Y,EAAKkY,YAAc3W,KAAK+H,YAChB3I,EACJX,EAAK8Y,qBACLjY,GAAiBvE,KAAKga,EAAKzV,cAC3B5D,WAGG+C,EAAK8Y,sBAEP9Y,CACT,CAEAU,oBAA2BhG,GACzB4B,KAAKga,EAAK5b,WAAaA,EACnB4B,KAAKga,EAAK/C,2BACNjX,KAAKkc,uBAETlc,KAAKga,EAAKnO,iBACN7L,KAAKwe,KAGbxe,KAAKsc,IACLtc,KAAK6b,IACP,CAEAzX,uBAA8BhG,GAC5B,OAAO4B,KAAKye,cAAc,IAAKze,KAAKga,EAAK5b,cAAeA,GAC1D,CAEAgG,4BAAmCsa,GACjC1e,KAAK6a,EAAsB6D,EACvB1e,KAAKga,EAAK/C,2BACNjX,KAAKkc,uBAETlc,KAAKga,EAAKnO,iBACN7L,KAAKwe,KAGbxe,KAAKsc,IACLtc,KAAK6b,IACP,CAEAzX,0BAAiCua,GAC/B3e,KAAKga,EAAKjO,iBAAmB4S,GAAQ,CAAA,EACjC3e,KAAKga,EAAKnO,iBACN7L,KAAKwe,KAGbxe,KAAKsc,IACLtc,KAAK6b,IACP,CAGO+C,kBAAkBxZ,GACvBpF,KAAK4a,EAAuBxV,EAC5BpF,KAAKsc,GACP,CAEAlY,aAAoBrC,GAGlB,GAFA/B,KAAKga,EAAKjY,IAAMA,EAChB/B,KAAKib,EAAiB,GAClBjb,KAAKga,EAAKnO,WAGZ,aAFM7L,KAAKwe,SACXxe,KAAK6b,GAA0B,GAGjC7b,KAAK6b,GAA0B,EACjC,CAEOlS,gBACL,MAAO,IAAK3J,KAAKga,EAAK5b,cAAe4B,KAAK6a,EAC5C,CAEO5Q,sBACL,OAAOjK,KAAKga,EAAKjO,kBAAoB,EACvC,CAEOE,oBAEL,OAAOjM,KAAK4a,GAAwB,IAAItS,GAC1C,CAEOuW,gCACL,OAAO7e,KAAKga,EAAKgC,4BAA8B,EACjD,CAEO9R,SACL,OAAOlK,KAAKga,EAAKjY,KAAO,EAC1B,CAEOmb,cACL,OAAOld,KAAKga,EAAKuB,UAAY,EAC/B,CAEO4B,iBACL,OAAOnd,KAAKga,EAAK4B,aAAe,EAClC,CAEOkD,wBACL,OAAO1V,MAAMnF,KAAKjE,KAAKoa,EACzB,CAEOxR,UAAUkE,GAEf,OADA9M,KAAKua,EAAevR,IAAI8D,GACjB,KACL9M,KAAKua,EAAexP,OAAO+B,EAAG,CAElC,CAEQiQ,IAAgB,IAAAgC,EACtB,OAAoC,QAA5BA,EAAA/e,KAAKga,EAAK9T,sBAAkB,IAAA6Y,GAAAA,IAAS/e,KAAKga,EAAK8C,kBACzD,CAEA1Y,UACE,IAAKpE,KAAKga,EAAKnO,WAAY,OAC3B,IAAK7L,KAAKgb,EAAc,OACxB,MAAM7O,QAAYnM,KAAK2c,EAAS,CAC9BC,YAAY,IAEVzQ,EAAIzI,YACA1D,KAAKsL,WAAWa,EAAIzI,KAE9B,CAEOsb,gBACL,OAAO,IAAI1W,IAAItI,KAAK2a,EACtB,CAEOsE,UHjaF,IAAqBpW,EGmaxB7I,KAAKua,EAAevG,QACpBhU,KAAK2a,EAAU3G,QACfhU,KAAKma,EAAoBnG,QACzBhU,KAAKoa,EAAoBpG,QACzBhU,KAAKkb,EAAuBlH,QAC5BhU,KAAKqa,EAAmB,GACxBra,KAAKwa,EAAW,GAChBxa,KAAKmc,OAAW3b,EACZR,KAAKya,GACP/S,aAAa1H,KAAKya,GH5aI5R,EG8aZ7I,KH7adqI,EAAoB/E,SAAS4b,GAAMA,EAAEnU,OAAOlC,KG+atC6M,IAAanO,OAAOkU,cAAgBzb,aAC/BuH,OAAOkU,YAIhBzb,KAAK8a,EAAuBxX,SAASmC,IACnCA,EAAI0Z,MAAM,IAEZnf,KAAK8a,EAAuB9G,QAC5BhU,KAAK+a,EAAkB/G,OACzB,CAEOoL,YAAYlF,GACjBla,KAAKia,EAAYC,CACnB,CAEOmF,eAAezhB,EAAagI,GACjC5F,KAAKga,EAAKjO,iBAAmB/L,KAAKga,EAAKjO,kBAAoB,GAC3D/L,KAAKga,EAAKjO,iBAAiBnO,GAAOgI,EAC9B5F,KAAKga,EAAKnO,WACZ7L,KAAKwe,KAGPxe,KAAK6b,IACL7b,KAAKsc,IACP,CAEOgD,IAAOC,GACZ,MAAMC,EAASxf,KAAKyf,EAAKF,EAAY,MAErC,OADAvf,KAAK0f,EAAmBH,EAAYC,GAC7BA,CACT,CAEOG,kBAAkB/hB,GAEvB,OADAoC,KAAK+a,EAAkB/R,IAAIpL,GACtBoC,KAAKga,EAAK4B,YACK5b,KAAKga,EAAK4B,YAAYvL,QAAQ5K,GAAQA,EAAI7H,MAAQA,IAEnEwH,KAAKK,GACGzF,KAAK4f,EAAmBna,KAEhC4K,QAAQlE,GAAgB,OAARA,IANgB,IAOrC,CAEO0T,yBACL7f,KAAKmb,GAA0B,EAC/Bnb,KAAK6b,GAA0B,EACjC,CAEQ+D,EAAmBL,EAA4BO,GACrD,MAAM5U,EAAWlL,KAAK8a,EAAuBzb,IAAIkgB,GAGjD,GACEA,EAAWQ,SACV/f,KAAK+a,EAAkB3P,IAAImU,EAAW3hB,OACtCsN,EAED,OAAO,KAIT,MAOMsU,EAPYxf,KAAKggB,EAAkCT,GAQrDvf,KAAKigB,EAAWV,GAAa,GAAG,EAAO,IACvCvf,KAAKsf,IAAIC,GAGPW,EAAYjb,KAAKC,UAAUsa,EAAOrhB,OAGxC,IACG2hB,GACDN,EAAOW,cACPjV,GACAA,EAASgV,YAAcA,EAEvB,OAAOV,EAOT,GAHItU,GAAUlL,KAAKogB,EAA0Bb,GAGzCC,EAAOW,aAAc,CACvB,MAAME,EAAa7a,EAA4B+Z,GAE/C,GACiB,aAAfc,GACAb,EAAOrhB,MAAMmiB,aACbf,EAAW7Z,YACX,CACA,MAAM3D,EAAMwd,EAAWgB,mBJtVxB,SAA2BC,EAAgBC,GAChD,IAAIC,EACAC,EACJ,IACED,EAAU,IAAIje,IAAI+d,GAClBG,EAAc,IAAIle,IAAIge,EAIxB,CAHE,MAAO5gB,GAEP,OADA+B,QAAQC,MAAwChC,kCAAAA,OAAAA,IACzC4gB,CACT,CAUA,OARAC,EAAQrd,aAAaC,SAAQ,CAACnF,EAAOP,KAE/B+iB,EAAYtd,aAAa+H,IAAIxN,IAGjC+iB,EAAYtd,aAAapF,IAAIL,EAAKO,EAAM,IAGnCwiB,EAAY5b,UACrB,CImUY6b,CAAkB5gB,KAAK6gB,IAAkBrB,EAAOrhB,MAAMmiB,aACtDd,EAAOrhB,MAAMmiB,YAEjB,GAAIxe,EAAcC,EAAKwd,EAAW7Z,aAOhC,OANA1F,KAAK8gB,IACH,8DACA,CACEC,GAAIxB,EAAW3hB,MAGZ4hB,EAETxf,KAAKib,EAAiBlZ,EACtB,MAAMif,EAAWhhB,KAAKihB,IAEL,IAAAC,EADjB,GAAIF,EACF,GAAItL,GACF1V,KAAK+b,IACLxU,OAAOQ,YAAW,KAChB,IACEiZ,EAASjf,EAGX,CAFE,MAAOlC,GACP+B,QAAQC,MAAMhC,EAChB,IACwB,QAAzBqhB,EAAElhB,KAAKga,EAAKmH,qBAAa,IAAAD,EAAAA,EAAI,UAE9B,IACEF,EAASjf,EAGX,CAFE,MAAOlC,GACP+B,QAAQC,MAAMhC,EAChB,CAGN,MAAO,GAAmB,WAAfwgB,EAAyB,CAClC,MAAMlB,EAAOnf,KAAKga,EAAKoH,wBACnBphB,KAAKga,EAAKoH,wBAAwB5B,EAAOrhB,OACzC6B,KAAKqhB,EAAiB7B,EAAOrhB,OAC7BghB,GACFnf,KAAK8a,EAAuB7c,IAAIshB,EAAY,CAC1CJ,OACAe,aAGN,CACF,CAEA,OAAOV,CACT,CAEQY,EAA0B3a,GAChC,MAAM/B,EAAO1D,KAAK8a,EAAuBzb,IAAIoG,GACzC/B,IACFA,EAAKyb,OACLnf,KAAK8a,EAAuB/P,OAAOtF,GAEvC,CAEQoW,EAA0BiE,GAChC,IAAK9f,KAAKmb,EAAyB,OAEnC,MAAMS,EAAc5b,KAAKga,EAAK4B,aAAe,GAGvC9R,EAAO,IAAInB,IAAIiT,GACrB5b,KAAK8a,EAAuBxX,SAAQ,CAACC,EAAGC,KACjCsG,EAAKsB,IAAI5H,KACZD,EAAE4b,OACFnf,KAAK8a,EAAuB/P,OAAOvH,GACrC,IAIF,IAAK,MAAMiC,KAAOmW,EAAa,CAC7B,MAAM4D,EAASxf,KAAK4f,EAAmBna,EAAKqa,GAG5C,GACEN,SAAAA,EAAQW,cAC6B,aAArC3a,EAA4BC,GAE5B,KAEJ,CACF,CAEQia,EAAsBH,EAA2BC,GACvD,MAAM5hB,EAAM2hB,EAAW3hB,IAGjB0jB,EAAOthB,KAAK2a,EAAUtb,IAAIzB,GAG7B0jB,GACDA,EAAK9B,OAAOW,eAAiBX,EAAOW,cACpCmB,EAAK9B,OAAO+B,cAAgB/B,EAAO+B,cAEnCvhB,KAAK2a,EAAU1c,IAAIL,EAAK,CAAE2hB,aAAYC,WACtCxf,KAAKua,EAAejX,SAASwJ,IAC3B,IACEA,EAAGyS,EAAYC,EAGjB,CAFE,MAAO3f,GACP+B,QAAQC,MAAMhC,EAChB,KAGN,CAEQ2hB,EAAmB5jB,EAAauO,GAEtC,GAAmB,aAAfA,EAAIxO,OAAuB,OAG/B,MAAM8jB,EAAmBxc,KAAKC,UAAUiH,EAAIhO,OAC5C,GAAI6B,KAAKqa,EAAiBzc,KAAS6jB,EAAnC,CAIA,GAHAzhB,KAAKqa,EAAiBzc,GAAO6jB,EAGzBzhB,KAAKga,EAAK0H,eACZ,IACE1hB,KAAKga,EAAK0H,eAAe9jB,EAAKuO,EAE9B,CADA,MAAOtM,GACP,CAKC6V,IAAcnO,OAAOlH,QAC1BL,KAAKwa,EAASpX,KAAK,CACjBxF,MACA+jB,GAAIxV,EAAIwV,KAEL3hB,KAAKya,IACRza,KAAKya,EAAWlT,OAAOQ,YAAW,KAEhC/H,KAAKya,EAAW,EAChB,MAAMmH,EAAI,IAAI5hB,KAAKwa,GACnBxa,KAAKwa,EAAW,GAGXxa,KAAKga,EAAK6H,aAEfta,OACGlH,MAAK,iCAAAuG,OAEF5G,KAAKga,EAAK6H,YAAW,YAAAjb,OACZlI,mBAAmBuG,KAAKC,UAAU0c,KAE7C,CACEpZ,MAAO,WACPsZ,KAAM,YAGTrV,OAAM,QAEL,GACHzM,KAAKga,EAAK+H,kBAAoB,MA1CkB,CA4CvD,CAEQC,EACNpkB,EACAO,EACAR,EACAskB,EACA1C,EACAC,GAEA,MAAM0C,EAAqB,CACzB/jB,QACAwjB,KAAMxjB,EACNgkB,KAAMhkB,EACNR,SACAskB,OAAQA,GAAU,IAQpB,OANI1C,IAAY2C,EAAI3C,WAAaA,GAC7BC,IAAQ0C,EAAIE,iBAAmB5C,GAGnCxf,KAAKwhB,EAAmB5jB,EAAKskB,GAEtBA,CACT,CAEOG,KAAoDzkB,GACzD,OAAOoC,KAAKsiB,YAAY1kB,GAAK+jB,EAC/B,CAEOY,MAAqD3kB,GAC1D,OAAOoC,KAAKsiB,YAAY1kB,GAAKukB,GAC/B,CAEOK,gBAGL5kB,EAAQ6kB,GACR,MAAMtkB,EAAQ6B,KAAKsiB,YAAmC1kB,GAAKO,MAC3D,OAAiB,OAAVA,EAAkBskB,EAAsCtkB,CACjE,CAOOukB,QAGL3B,GACA,OAAO/gB,KAAKsiB,YAAYvB,EAC1B,CAEOuB,YAGLvB,GACA,OAAO/gB,KAAK2iB,EAAa5B,EAC3B,CAEQ4B,EAGN5B,EAAO6B,GAGP,IAFAA,EAAUA,GAAW,CAAEC,kBAAmB,IAAIla,MAElCka,kBAAkBzX,IAAI2V,GAMhC,OAAO/gB,KAAKgiB,EAAkBjB,EAAI,KAAM,sBAM1C,GAJA6B,EAAQC,kBAAkB7Z,IAAI+X,GAC9B6B,EAAQ7B,GAAKA,EAGT/gB,KAAK4a,EAAqBxP,IAAI2V,GAMhC,OAAO/gB,KAAKgiB,EACVjB,EACA/gB,KAAK4a,EAAqBvb,IAAI0hB,GAC9B,YAKJ,IAAK/gB,KAAKga,EAAKuB,WAAavb,KAAKga,EAAKuB,SAASwF,GAG7C,OAAO/gB,KAAKgiB,EAAkBjB,EAAI,KAAM,kBAI1C,MAAM2B,EAAgC1iB,KAAKga,EAAKuB,SAASwF,GAGzD,GAAI2B,EAAQI,MACVA,EAAO,IAAK,MAAMC,KAAQL,EAAQI,MAAO,CAEvC,GAAIC,EAAKC,iBACP,IAAK,MAAMC,KAAmBF,EAAKC,iBAAkB,CACnD,MAAME,EAAeljB,KAAK2iB,EAAaM,EAAgBlC,GAAI6B,GAE3D,GAA4B,uBAAxBM,EAAavlB,OACf,OAAOqC,KAAKgiB,EAAkBjB,EAAI,KAAM,sBAQ1C,IAJe1M,GADC,CAAElW,MAAO+kB,EAAa/kB,OAGpC8kB,EAAgB1O,WAAa,CAAA,GAElB,CAEX,GAAI0O,EAAgBE,KAGlB,OAAOnjB,KAAKgiB,EAAkBjB,EAAI,KAAM,gBAQ1C,SAAS+B,CACX,CACF,CAIF,GAAIC,EAAKK,SAAWpjB,KAAKqjB,EAAeN,EAAKK,SAM3C,SAIF,GAAI,UAAWL,EAAM,CAEnB,GAAIA,EAAKxO,YAAcvU,KAAKsjB,GAAiBP,EAAKxO,WAMhD,SAIF,IACGvU,KAAKujB,GACJR,EAAK5hB,MAAQ4f,EACbgC,EAAKS,cACLxjB,KAAKga,EAAK/C,sBAAwB8L,EAAKU,uBACnCV,EAAKW,uBACLljB,EACJuiB,EAAKxhB,MACLwhB,EAAKY,SACLZ,EAAKa,aAQP,SAgBF,OANIb,EAAKc,QACPd,EAAKc,OAAOvgB,SAASiS,IACnBvV,KAAK8jB,GAAOvO,EAAEgK,WAAYhK,EAAEiK,OAAO,IAIhCxf,KAAKgiB,EAAkBjB,EAAIgC,EAAKgB,MAAY,QAAShB,EAAKhC,GACnE,CACA,IAAKgC,EAAKpd,WAOR,SAIF,MAAMF,EAAqB,CACzBE,WAAYod,EAAKpd,WACjB/H,IAAKmlB,EAAKnlB,KAAOmjB,GAEf,aAAcgC,IAAMtd,EAAIke,SAAWZ,EAAKY,UACxCZ,EAAKiB,UAASve,EAAIue,QAAUjB,EAAKiB,SACjCjB,EAAKS,gBAAe/d,EAAI+d,cAAgBT,EAAKS,eAC7CT,EAAKW,oBACPje,EAAIie,kBAAoBX,EAAKW,mBAC3BX,EAAKU,yBACPhe,EAAIge,uBAAyBV,EAAKU,6BACTjjB,IAAvBuiB,EAAKkB,gBACPxe,EAAIwe,cAAgBlB,EAAKkB,oBACGzjB,IAA1BuiB,EAAKmB,mBACPze,EAAIye,iBAAmBnB,EAAKmB,kBAC1BnB,EAAKoB,YAAW1e,EAAI0e,UAAYpB,EAAKoB,WACrCpB,EAAKqB,OAAM3e,EAAI2e,KAAOrB,EAAKqB,MAC3BrB,EAAKsB,SAAQ5e,EAAI4e,OAAStB,EAAKsB,QAC/BtB,EAAK7kB,OAAMuH,EAAIvH,KAAO6kB,EAAK7kB,MAC3B6kB,EAAKuB,QAAO7e,EAAI6e,MAAQvB,EAAKuB,OAC7BvB,EAAK5hB,OAAMsE,EAAItE,KAAO4hB,EAAK5hB,MAC3B4hB,EAAKa,cAAane,EAAIme,YAAcb,EAAKa,aACzCb,EAAKK,UAAS3d,EAAI2d,QAAUL,EAAKK,SACjCL,EAAKxO,YAAW9O,EAAI8O,UAAYwO,EAAKxO,WAGzC,MAAMpI,EAAMnM,KAAKyf,EAAKha,EAAKsb,GAE3B,GADA/gB,KAAK0f,EAAmBja,EAAK0G,GACzBA,EAAIgU,eAAiBhU,EAAIoY,YAC3B,OAAOvkB,KAAKgiB,EACVjB,EACA5U,EAAIhO,MACJ,aACA4kB,EAAKhC,GACLtb,EACA0G,EAGN,CAUF,OAAOnM,KAAKgiB,EACVjB,OACyBvgB,IAAzBkiB,EAAQD,aAA6B,KAAOC,EAAQD,aACpD,eAEJ,CAEQc,GACNpiB,EACAqiB,EACAE,EACAniB,EACAoiB,EACAC,GAEA,IAAKriB,QAAsBf,IAAbmjB,EAAwB,OAAO,EAE7C,IAAKpiB,GAAsB,IAAboiB,EAAgB,OAAO,EAErC,MAAMa,UAAEA,GAAcxkB,KAAKykB,GACzBjB,EACAE,GAEF,IAAKc,EACH,OAAO,EAGT,MAAMljB,EAAIJ,EAAKC,EAAMqjB,EAAWZ,GAAe,GAC/C,OAAU,OAANtiB,IAEGC,EACHF,EAAQC,EAAGC,QACEf,IAAbmjB,GACAriB,GAAKqiB,EAEX,CAEQL,GAAiB/O,GACvB,OAAOF,GAAcrU,KAAK2J,gBAAiB4K,EAC7C,CAEQ8O,EAAeD,GACrB,OAAOA,EAAQ3f,MAAM4M,IACnB,MAAMmU,UAAEA,GAAcxkB,KAAKykB,GAAkBpU,EAAOmD,WACpD,IAAKgR,EAAW,OAAO,EACvB,MAAMljB,EAAIJ,EAAKmP,EAAOlP,KAAMqjB,EAAWnU,EAAOuT,aAAe,GAC7D,OAAU,OAANtiB,IACI+O,EAAOgU,OAAO5gB,MAAMihB,GAAMrjB,EAAQC,EAAGojB,IAAG,GAEpD,CAEQjF,EACNF,EACAoF,GAEA,MAAM/mB,EAAM2hB,EAAW3hB,IACjBgnB,EAAgBrF,EAAW5Z,WAAWjI,OAG5C,GAAIknB,EAAgB,EAGlB,OAAO5kB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,IAA0B,IAAtB3kB,KAAKga,EAAK6K,QAGZ,OAAO7kB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAOhD,IAHApF,EAAavf,KAAK8kB,GAAgBvF,IAIrB7Z,cACV5D,EAAc9B,KAAK6gB,IAAkBtB,EAAW7Z,aAMjD,OAAO1F,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,MAAMI,EJ97BH,SACLhE,EACAhf,EACA6iB,GAEA,IAAK7iB,EACH,OAAO,KAGT,MAAM6V,EAAS7V,EAAI/C,MAAM,KAAK,GAC9B,IAAK4Y,EACH,OAAO,KAGT,MAAMzV,EAAQyV,EACXjZ,QAAQ,MAAO,IACfK,MAAM,KACNoG,KAAK4f,GAAOA,EAAGhmB,MAAM,IAAK,KAC1BqR,QAAO5J,IAAA,IAAEjD,GAAEiD,EAAA,OAAKjD,IAAMud,CAAE,IACxB3b,KAAI0B,IAAA,IAAIvD,CAAAA,GAAEuD,EAAA,OAAKme,SAAS1hB,EAAE,IAE7B,OAAIpB,EAAMzE,OAAS,GAAKyE,EAAM,IAAM,GAAKA,EAAM,GAAKyiB,EAC3CziB,EAAM,GAER,IACT,CIq6BuB+iB,CACjBtnB,EACAoC,KAAK6gB,IACL+D,GAEF,GAAmB,OAAfG,EAMF,OAAO/kB,KAAKigB,EAAWV,EAAYwF,GAAY,EAAOJ,GAIxD,GAAI3kB,KAAKga,EAAKjO,kBAAoBnO,KAAOoC,KAAKga,EAAKjO,iBAOjD,OAAO/L,KAAKigB,EAAWV,EANLvf,KAAKga,EAAKjO,iBAAiBnO,IAMC,EAAO+mB,GAIvD,GAA0B,UAAtBpF,EAAWlT,SAA4C,IAAtBkT,EAAW4F,OAK9C,OAAOnlB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,MAAMnB,cAAEA,EAAagB,UAAEA,GAAcxkB,KAAKykB,GACxClF,EAAWiE,cACXxjB,KAAKga,EAAK/C,sBAAwBsI,EAAWkE,uBACzClE,EAAWmE,uBACXljB,GAEN,IAAKgkB,EAKH,OAAOxkB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAGhD,IAAIS,GAAY,EAEZC,GAAoB,EACpBC,GAA+B,EACnC,GAAItlB,KAAKga,EAAK/C,sBAAwBsI,EAAWkE,uBAAwB,CACvE,MAAM7d,UAAEA,EAAS2f,iBAAEA,GAAqBvlB,KAAKwlB,GAA0B,CACrEC,OAAQlG,EAAW3hB,IACnB8nB,iBAAkBnG,EAAW0E,cAC7B0B,iBAAkBpG,EAAWiE,cAC7BoC,qBAAsBrG,EAAWmE,kBACjCmC,oBAAqBtG,EAAW2E,iBAChC4B,QAASvG,EAAW6E,OAEtBiB,EAAoBzf,GAAa,EACjCwf,EAAWxf,EACX0f,IAAiCC,CACnC,CAGA,IAAKF,EAAmB,CAEtB,GAAI9F,EAAW6D,SACb,GAAIpjB,KAAKqjB,EAAe9D,EAAW6D,SAKjC,OAAOpjB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,QAE3C,GACLpF,EAAW4E,YJ7rCZ,SACLK,EACAL,GAEA,MAAM7iB,EAAIJ,EAAK,KAAOijB,EAAU,GAAIK,EAAW,GAC/C,OAAU,OAANljB,GACGA,GAAK6iB,EAAU,IAAM7iB,EAAI6iB,EAAU,EAC5C,CIurCS4B,CAAYvB,EAAWjF,EAAW4E,WAMnC,OAAOnkB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,GAAIpF,EAAWhd,UJ7/Bd,SAAoBA,GACzB,IACE,OAAOA,GAIT,CAHE,MAAO1C,GAEP,OADA+B,QAAQC,MAAMhC,IACP,CACT,CACF,CIs/BiCqC,CAAWqd,EAAWhd,SAK/C,OAAOvC,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,GACEpF,EAAWhL,YACVvU,KAAKsjB,GAAiB/D,EAAWhL,WAMlC,OAAOvU,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,GAAIpF,EAAWyD,iBACb,IAAK,MAAMC,KAAmB1D,EAAWyD,iBAAkB,CACzD,MAAME,EAAeljB,KAAK2iB,EAAaM,EAAgBlC,IAEvD,GAA4B,uBAAxBmC,EAAavlB,OACf,OAAOqC,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,IAAKtQ,GADW,CAAElW,MAAO+kB,EAAa/kB,OACV8kB,EAAgB1O,WAAa,CAAE,GAKzD,OAAOvU,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,EAElD,CAIF,GACEpF,EAAWyG,SACVhmB,KAAKimB,GAAiB1G,EAAWyG,QAMlC,OAAOhmB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,EAElD,CAGA,GAAIpF,EAAWxd,MAAQ/B,KAAKkmB,GAAY3G,EAAWxd,KAKjD,OAAO/B,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,MAAMrjB,EAAIJ,EACRqe,EAAWpe,MAAQvD,EACnB4mB,EACAjF,EAAWqE,aAAe,GAE5B,GAAU,OAANtiB,EAKF,OAAOtB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAehD,GAZKU,IAQHD,EJnxCC,SAAyB9jB,EAAW+iB,GACzC,IAAK,IAAI7mB,EAAI,EAAGA,EAAI6mB,EAAO3mB,OAAQF,IACjC,GAAI6D,EAAQC,EAAG+iB,EAAO7mB,IACpB,OAAOA,EAGX,OAAQ,CACV,CI4wCiB2oB,CAAgB7kB,EANzBie,EAAW8E,QJxpCZ,SACLO,EACAjB,EACAK,IAEAL,OAAwBnjB,IAAbmjB,EAAyB,EAAIA,GAGzB,EAIbA,EAAW,EACFA,EAAW,IAIpBA,EAAW,GAIb,MAAMyC,GA5JwB9kB,EA4JAsjB,IA3JrB,EAAU,GACZ,IAAIxb,MAAM9H,GAAG+kB,KAAK,EAAI/kB,GAFxB,IAAyBA,GA6J9B0iB,EAAUA,GAAWoC,GACT1oB,SAAWknB,IAMrBZ,EAAUoC,GAIZ,MAAME,EAActC,EAAQuC,QAAO,CAACC,EAAGC,IAAQA,EAAMD,GAAG,IACpDF,EAAc,KAAQA,EAAc,QAItCtC,EAAUoC,GAIZ,IAAIM,EAAa,EACjB,OAAO1C,EAAQ5e,KAAKohB,IAClB,MAAMG,EAAQD,EAEd,OADAA,GAAcF,EACP,CAACG,EAAOA,EAAShD,EAAsB6C,EAAE,GAEpD,CIymCQI,CACEhC,OACwBpkB,IAAxB+e,EAAWoE,SAAyB,EAAIpE,EAAWoE,SACnDpE,EAAWyE,WAMbsB,EAKF,OAAOtlB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,OAAWnkB,GAAW,GAItE,GAAI4kB,EAAW,EAKb,OAAOplB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,GAAI,UAAWpF,EAMb,OAAOvf,KAAKigB,EACVV,OACqB/e,IAArB+e,EAAWwE,OAAuB,EAAIxE,EAAWwE,OACjD,EACAY,GAKJ,GAAI3kB,KAAKga,EAAK6M,OAKZ,OAAO7mB,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,GAA0B,YAAtBpF,EAAWlT,OAKb,OAAOrM,KAAKigB,EAAWV,GAAa,GAAG,EAAOoF,GAIhD,MAAMnF,EAASxf,KAAKigB,EAClBV,EACA6F,GACA,EACAT,EACArjB,EACA+jB,GAIF,GAAIrlB,KAAKga,EAAK/C,sBAAwBsI,EAAWkE,uBAAwB,CACvE,MAAMqD,QACJA,EACAlpB,IAAKmpB,EAAO5Q,IACZA,GACEnW,KAAKgnB,GACPxD,EACAze,EAASyf,GACT,CACE,CAACxkB,KAAKinB,GACJ1H,EAAW3hB,IACX2hB,EAAW0E,gBACTzE,EAAO5hB,MAGXkpB,IAEF9mB,KAAKga,EAAKgC,2BACRhc,KAAKga,EAAKgC,4BAA8B,GAC1Chc,KAAKga,EAAKgC,2BAA2B+K,GAAW5Q,EAEhDnW,KAAKga,EAAK/C,oBAAoBgF,gBAAgB9F,GAElD,CAgBA,OAbAnW,KAAK8jB,GAAOvE,EAAYC,GAGxB,aAAcD,GACZA,EAAW2H,UACXlnB,KAAKoa,EAAoBpR,IAAIuW,EAAW2H,UAQnC1H,CACT,CAEAsB,IAAIqG,EAAaC,GACVpnB,KAAKsa,QACNta,KAAKga,EAAK8G,IAAK9gB,KAAKga,EAAK8G,IAAIqG,EAAKC,GACjCxlB,QAAQkf,IAAIqG,EAAKC,GACxB,CAEOC,2BACL,OAAOje,MAAMnF,KAAKjE,KAAKkb,EAAuBoM,SAChD,CAEOC,yBAAyBC,GAC9BxnB,KAAKkb,EAAyB,IAAI5S,IAChCkf,EACGnX,QAAQlM,GAAMA,GAAKA,EAAEob,YAAcpb,EAAEqb,SACrCpa,KAAKjB,GACG,CAACnE,KAAKynB,GAAatjB,EAAEob,WAAYpb,EAAEqb,QAASrb,KAG3D,CAEOujB,4BACA1nB,KAAKga,EAAK2N,mBAEf3nB,KAAKkb,EAAuB5X,SAASskB,IAC9BA,GAASA,EAAKrI,YAAeqI,EAAKpI,OAGrCxf,KAAK8jB,GAAO8D,EAAKrI,WAAYqI,EAAKpI,QAFlC5d,QAAQC,MAAM,iCAAkC,CAAE+lB,KAAMA,GAG1D,IAGF5nB,KAAKkb,EAAuBlH,QAC9B,CAEO6T,oBAAoBC,GACzB9nB,KAAKga,EAAK2N,iBAAmBG,EAC7B9nB,KAAK0nB,2BACP,CAEQD,GACNlI,EACAC,GAEA,OACEA,EAAOgE,cACPhE,EAAOgF,UACPjF,EAAW3hB,IACX4hB,EAAO+B,WAEX,CAEQuC,GAAUvE,EAA2BC,GAC3C,MAAMhc,EAAIxD,KAAKynB,GAAalI,EAAYC,GAExC,GAAKxf,KAAKga,EAAK2N,kBASf,IAAI3nB,KAAKma,EAAoB/O,IAAI5H,GAAjC,CACAxD,KAAKma,EAAoBnR,IAAIxF,GAE7B,IACExD,KAAKga,EAAK2N,iBAAiBpI,EAAYC,EAGzC,CAFE,MAAO3f,GACP+B,QAAQC,MAAMhC,EAChB,CAPqC,OAP9BG,KAAKkb,EAAuB9P,IAAI5H,IACnCxD,KAAKkb,EAAuBjd,IAAIuF,EAAG,CAAE+b,aAAYC,UAcvD,CAEQsF,GAAmBvF,GACzB,MAAM3hB,EAAM2hB,EAAW3hB,IACjBmqB,EAAI/nB,KAAKga,EAAK0E,UAWpB,OAVIqJ,GAAKA,EAAEnqB,IAEqB,iBAD9B2hB,EAAapgB,OAAO7B,OAAO,CAAA,EAAIiiB,EAAYwI,EAAEnqB,KACvBmE,MACpBwd,EAAWxd,IAAMP,EAEf+d,EAAWxd,MAKVwd,CACT,CAEQkF,GAAkBpW,EAAe2Z,GACvC,IAAIxE,EAAgBnV,GAAQ,KAExBmW,EAAiB,GAwBrB,OAtBIxkB,KAAK6a,EAAoB2I,GAC3BgB,EAAYxkB,KAAK6a,EAAoB2I,GAC5BxjB,KAAKga,EAAK5b,WACnBomB,EAAYxkB,KAAKga,EAAK5b,WAAWolB,IAAkB,GAC1CxjB,KAAKga,EAAKiO,OACnBzD,EAAYxkB,KAAKga,EAAKiO,KAAKzE,IAAkB,KAI1CgB,GAAawD,IACZhoB,KAAK6a,EAAoBmN,GAC3BxD,EAAYxkB,KAAK6a,EAAoBmN,GAC5BhoB,KAAKga,EAAK5b,WACnBomB,EAAYxkB,KAAKga,EAAK5b,WAAW4pB,IAAa,GACrChoB,KAAKga,EAAKiO,OACnBzD,EAAYxkB,KAAKga,EAAKiO,KAAKD,IAAa,IAEtCxD,IACFhB,EAAgBwE,IAIb,CAAExE,gBAAegB,YAC1B,CAEQvE,EACNV,EACA2I,EACAC,EACAxD,EACAyD,EACAC,GAEA,IAAIlI,GAAe,GAEf+H,EAAiB,GAAKA,GAAkB3I,EAAW5Z,WAAWjI,UAChEwqB,EAAiB,EACjB/H,GAAe,GAGjB,MAAMqD,cAAEA,EAAagB,UAAEA,GAAcxkB,KAAKykB,GACxClF,EAAWiE,cACXxjB,KAAKga,EAAK/C,sBAAwBsI,EAAWkE,uBACzClE,EAAWmE,uBACXljB,GAGA4jB,EAA+B7E,EAAW6E,KAC5C7E,EAAW6E,KAAK8D,GAChB,GAEE/b,EAAiB,CACrBvO,IAAKwmB,EAAKxmB,KAAO,GAAKsqB,EACtBvD,YACAxE,eACAgI,WACA5G,YAAa2G,EACb/pB,MAAOohB,EAAW5Z,WAAWuiB,GAC7B1E,gBACAgB,YACA6D,mBAAoBA,GAOtB,OAJIjE,EAAKlmB,OAAMiO,EAAIjO,KAAOkmB,EAAKlmB,WAChBsC,IAAX4nB,IAAsBjc,EAAIic,OAASA,GACnChE,EAAKG,cAAapY,EAAIoY,YAAcH,EAAKG,aAEtCpY,CACT,CAEQ0U,IACN,OAAO7gB,KAAKga,EAAKjY,MAAQ2T,GAAYnO,OAAOoQ,SAAS/U,KAAO,GAC9D,CAEQsjB,GAAYoC,GAClB,MAAMvmB,EAAM/B,KAAK6gB,IACjB,IAAK9e,EAAK,OAAO,EAEjB,MAAMwmB,EAAWxmB,EAAIpD,QAAQ,eAAgB,IAAIA,QAAQ,WAAY,KAErE,QAAI2pB,EAAS3lB,KAAKZ,MACdumB,EAAS3lB,KAAK4lB,EAEpB,CAEQtC,GAAiBuC,GACvB,MAAMxC,EAAShmB,KAAKga,EAAKgM,QAAU,CAAA,EACnC,IAAK,IAAIxoB,EAAI,EAAGA,EAAIgrB,EAAU9qB,OAAQF,IACpC,GAAIwoB,EAAOwC,EAAUhrB,IAAK,OAAO,EAEnC,OAAO,CACT,CAEQwiB,EACNT,GAEA,MAAMc,EAAa7a,EAA4B+Z,GAC/C,GAAmB,WAAfc,EAAyB,CAC3B,GAAIrgB,KAAKga,EAAKyO,yBAA0B,OAAO,EAE/C,GAAIzoB,KAAKga,EAAK0O,oBACRnJ,EAAW5Z,WAAWlC,MAAMF,GAAMA,EAAEolB,KACtC,OAAO,CAGb,KAAO,IAAmB,aAAftI,EA0BT,OAAO,EAzBP,GAAIrgB,KAAKga,EAAK4O,8BAA+B,OAAO,EAGpD,IACE,MAAMhU,EAAU,IAAInS,IAAIzC,KAAK6gB,KAC7B,IAAK,MAAMtd,KAAKgc,EAAW5Z,WAAY,CACrC,IAAKpC,IAAMA,EAAE+c,YAAa,SAC1B,MAAMve,EAAM,IAAIU,IAAIc,EAAE+c,aAGtB,GAAItgB,KAAKga,EAAK6O,yCAA0C,CACtD,GAAI9mB,EAAI+mB,WAAalU,EAAQkU,SAAU,OAAO,EAC9C,GAAI/mB,EAAImB,OAAS0R,EAAQ1R,KAAM,OAAO,CACxC,CACF,CAQF,CAPE,MAAOrD,GAMP,OAJAG,KAAK8gB,IAAI,wCAAyC,CAChDC,GAAIxB,EAAW3hB,IACfiE,MAAOhC,KAEF,CACT,CAIF,CAEA,SACE0f,EAAW2H,YACVlnB,KAAKga,EAAK+O,kBAAoB,IAAIxb,SAASgS,EAAW2H,UAM3D,CAEO8B,iBACL,OAAOhpB,KAAKib,CACd,CAEQgG,IAGN,OAAIjhB,KAAKga,EAAKgH,SACLhhB,KAAKga,EAAKgH,SACRtL,GACD3T,IACNwF,OAAOoQ,SAAShZ,QAAQoD,EAAI,EAGzB,IACT,CAEQga,IACN,GAAK/b,KAAKga,EAAK8B,aAAgBpG,GAC/B,IAAI,IAAAuT,EACF,MAAMC,EAAW7qB,SAAS4R,cAAc,SACxCiZ,EAAShZ,UACP,oEACF7R,SAAS8qB,KAAKC,YAAYF,GAC1B7qB,SAAS8V,gBAAgBkV,UAAUrgB,IAAI,mBAGvCjB,YAAW,KACT1J,SAAS8V,gBAAgBkV,UAAUvpB,OAAO,kBAAkB,GAC/B,QAA9BmpB,EAAEjpB,KAAKga,EAAKsP,0BAAkB,IAAAL,EAAAA,EAAI,KAGrC,CAFE,MAAOppB,GACP+B,QAAQC,MAAMhC,EAChB,CACF,CAEQwhB,EAAiBkI,GACvB,IAAK7T,GAAW,OAChB,MAAMyJ,EAAuB,GAC7B,GAAIoK,EAAQC,IAAK,CACf,MAAMtK,EAAI7gB,SAAS4R,cAAc,SACjCiP,EAAEhP,UAAYqZ,EAAQC,IACtBnrB,SAAS8qB,KAAKC,YAAYlK,GAC1BC,EAAK/b,MAAK,IAAM8b,EAAEpf,UACpB,CACA,GAAIypB,EAAQZ,GAAI,CACd,MAAMc,EAASprB,SAAS4R,cAAc,UACtCwZ,EAAOvZ,UAAYqZ,EAAQZ,GACvB3oB,KAAKga,EAAK0P,mBACZD,EAAOE,MAAQ3pB,KAAKga,EAAK0P,kBAE3BrrB,SAAS8qB,KAAKC,YAAYK,GAC1BtK,EAAK/b,MAAK,IAAMqmB,EAAO3pB,UACzB,CAMA,OALIypB,EAAQ1jB,cACV0jB,EAAQ1jB,aAAavC,SAAS6P,IAC5BgM,EAAK/b,KFzxCb,SAAA0D,GACEyM,IAAAA,EAAAA,EAAAA,SACAqW,EAAAA,EAAAA,OACAzrB,EAAAA,EAAAA,MACWkQ,EAAXmF,EAAAA,UACA9C,EAAAA,EAAAA,eACAC,EAAAA,EAAAA,qBAEA,GAAa,SAATtC,EAAiB,CACnB,GAAe,WAAXub,EACF,OAAO7Z,GAAKwD,GAAU,SAAG9D,GAAA,OAAIA,SAAOtR,EAAAA,EAAS,GAApB,IACpB,GAAe,QAAXyrB,EACT,OAAO7Z,GAAKwD,GAAU,WAAA,OAAA,MAAMpV,EAAAA,EAAS,EAAf,GAEzB,MAAM,GAAa,UAATkQ,EAAkB,CAC3B,GAAe,WAAXub,EACF,OAAO7X,GAAQwB,GAAU,SAAG9D,GACtBtR,GAAOsR,EAAIzG,IAAI7K,EACpB,IACI,GAAe,WAAXyrB,EACT,OAAO7X,GAAQwB,GAAU,SAAG9D,GACtBtR,GAAOsR,EAAG,OAAQtR,EACvB,IACI,GAAe,QAAXyrB,EACT,OAAO7X,GAAQwB,GAAU,SAAG9D,GAC1BA,EAAIuE,QACA7V,GAAOsR,EAAIzG,IAAI7K,EACpB,GAEJ,MAAM,GAAa,aAATkQ,GACT,GAAe,QAAXub,GAAoBlZ,EACtB,OAnFN,SACE6C,EACAzD,GAEA,OAAO6D,GAAY,CACjBP,KAAM,WACNtF,SAAU,IAAInF,IACdmH,OA4E4B,WAAA,MAAO,CAC/Ba,qBAAAA,EACAD,eAAAA,EAFwB,EA3E5B6C,SAAAA,GAEH,CAyEY9B,CAAS8B,OAKb,CACL,GAAe,WAAXqW,EACF,OAAOpW,GAAUD,EAAUlF,GAAM,SAAGoB,GAAA,OAC1B,OAARA,EAAeA,GAAG,MAAItR,EAAAA,EAAS,IAAMA,MAAAA,EAAAA,EAAS,EADZ,IAG/B,GAAe,QAAXyrB,EACT,OAAOpW,GAAUD,EAAUlF,GAAM,WAAA,OAAA,MAAMlQ,EAAAA,EAAS,EAAf,IAC5B,GAAe,WAAXyrB,EACT,OAAOpW,GAAUD,EAAUlF,GAAM,WAAA,OAAM,IAAN,GAEpC,CACD,OAAOT,CACR,CEyuCiBkC,CAAmBqD,GAAiCtF,OAAO,IAGlE,KACLsR,EAAK7b,SAASumB,GAAOA,KAAK,CAE9B,CAEQC,GAAwCpmB,GAC9C,MAAMtF,EAAa,IAAIuK,IACjB4S,EAAW7X,GAAQA,EAAK6X,SAAW7X,EAAK6X,SAAWvb,KAAKkd,cACxDtB,EACJlY,GAAQA,EAAKkY,YAAclY,EAAKkY,YAAc5b,KAAKmd,iBAoBrD,OAnBAhe,OAAO2K,KAAKyR,GAAUjY,SAASyd,IAC7B,MAAM2B,EAAUnH,EAASwF,GACzB,GAAI2B,EAAQI,MACV,IAAK,MAAMC,KAAQL,EAAQI,MACrBC,EAAKpd,aACPvH,EAAW4K,IAAI+Z,EAAKS,eAAiB,MACjCT,EAAKW,mBACPtlB,EAAW4K,IAAI+Z,EAAKW,mBAI5B,IAEF9H,EAAYxW,KAAKma,IACfnhB,EAAW4K,IAAIuW,EAAWiE,eAAiB,MACvCjE,EAAWmE,mBACbtlB,EAAW4K,IAAIuW,EAAWmE,kBAC5B,IAEKta,MAAMnF,KAAK7F,EACpB,CAEAgG,2BAAkCV,GAChC,GAAI1D,KAAKga,EAAK/C,oBAAqB,CACjC,MAAM7Y,EAAa4B,KAAK+pB,GAA2BrmB,GACnD1D,KAAKga,EAAKgC,iCAAmChc,KAAKga,EAAK/C,oBAAoB+S,kBACzE5rB,EAEJ,CACF,CAEQ6rB,GACNtE,EACAC,GAEA,IAAK5lB,KAAKga,EAAKgC,2BAA4B,MAAO,CAAA,EAClD,MAAMwH,cAAEA,EAAagB,UAAEA,GAAcxkB,KAAKykB,GACxCkB,GAEIuE,YAAa1G,EAAa,MAAA5c,OAAK7B,EAASyf,KAG5ChB,cAAeE,EACfc,UAAW2F,GACTnqB,KAAKykB,GAAkBmB,GACrBwE,EAAcD,EACbzG,GAAAA,OAAAA,EAAsB3e,MAAAA,OAAAA,EAASolB,IAClC,KAEEzQ,EAAiC,CAAA,EAavC,OAZI0Q,GAAepqB,KAAKga,EAAKgC,2BAA2BoO,IACtDjrB,OAAO7B,OACLoc,EACA1Z,KAAKga,EAAKgC,2BAA2BoO,GAAa1Q,aAAe,CAAA,GAGjE1Z,KAAKga,EAAKgC,2BAA2BkO,IACvC/qB,OAAO7B,OACLoc,EACA1Z,KAAKga,EAAKgC,2BAA2BkO,GAASxQ,aAAe,CAAA,GAG1DA,CACT,CAEQ8L,GAiBNpe,GAAA,IAjBgCqe,OAChCA,EAAMC,iBACNA,EAAgBC,iBAChBA,EAAgBC,qBAChBA,EAAoBC,oBACpBA,EAAmBC,QACnBA,GAQD1e,EAICse,EAAmBA,GAAoB,EACvCG,EAAsBA,GAAuB,EAC7CF,EAAmBA,GAAoB,KACvCG,EAAUA,GAAW,GACrB,MAAM/E,EAAK/gB,KAAKinB,GAA8BxB,EAAQC,GAChDhM,EAAc1Z,KAAKiqB,GACvBtE,EACAC,GAIF,GAAIC,EAAsB,EACxB,IAAK,IAAIroB,EAAI,EAAGA,GAAKqoB,EAAqBroB,IAExC,QAAgCgD,IAA5BkZ,EADe1Z,KAAKinB,GAA8BxB,EAAQjoB,IAE5D,MAAO,CACLoI,WAAY,EACZ2f,kBAAkB,GAK1B,MAAM8E,EAAe3Q,EAAYqH,GACjC,QAAqBvgB,IAAjB6pB,EAEF,MAAO,CAAEzkB,WAAY,GACvB,MAAMA,EAAYkgB,EAAQwE,WAAWza,GAAMA,EAAEjS,MAAQysB,IACrD,OAAIzkB,EAAY,EAEP,CAAEA,WAAY,GAEhB,CAAEA,YACX,CAEQqhB,GACNsD,EACAC,GAGA,OADAA,EAA0BA,GAA2B,EAC3CD,GAAAA,OAAAA,eAAkBC,EAC9B,CAEQT,GACNrmB,GAEA,MAAMtF,EAAqC,CAAA,EAS3C,OARA4B,KAAKga,EAAKyQ,iCAAoCzqB,KAAKga,EAChDyQ,iCAECzqB,KAAKga,EAAKyQ,iCADVzqB,KAAK8pB,GAAwCpmB,GAEjD1D,KAAKga,EAAKyQ,iCAAiCnnB,SAAS+K,IAClD,MAAMmW,UAAEA,GAAcxkB,KAAKykB,GAAkBpW,GAC7CjQ,EAAWiQ,GAAQtJ,EAASyf,EAAU,IAEjCpmB,CACT,CAEQ4oB,GACNjoB,EACAkX,EACAyD,GAMA,MAAM9b,EAAG,GAAAgJ,OAAM7H,EAAa,MAAA6H,OAAKqP,GAC3ByU,EACJ1qB,KAAKga,EAAKgC,4BACVhc,KAAKga,EAAKgC,2BAA2Bpe,IACjCoC,KAAKga,EAAKgC,2BAA2Bpe,GAAK8b,aAC1C,GACAiR,EAAiB,IAAKD,KAAwBhR,GAIpD,MAAO,CACL9b,MACAuY,IAAK,CACHpX,gBACAkX,iBACAyD,YAAaiR,GAEf7D,QATA7hB,KAAKC,UAAUwlB,KAAyBzlB,KAAKC,UAAUylB,GAW3D,GElrDwB,IACrBrU,GACHzK,aAAcyK,GAAYzK,WAC1B8b,iBAAkB,CAAC9nB,EAAG6kB,KACpB,MAAMkG,EAAI,CAAEC,cAAehrB,EAAEjC,IAAKktB,aAAcpG,EAAE9mB,KAGlD2J,OAAOwjB,MAAQxjB,OAAOwjB,KAAK,QAAS,oBAAqBH,GAGzDrjB,OAAO6O,WACL7O,OAAO6O,UAAUhT,KAAK,CAAE2J,MAAO,uBAAwB6d,IAGzDrjB,OAAOyjB,WACLzjB,OAAOyjB,UAAUC,OACjB1jB,OAAOyjB,UAAUC,MAAM,oBAAqBL,EAAE,KAE/CpU,GACHpY,WAAYuL,KACZsN,yBAKF6C,GAAGsF,aAAY,KACb/gB,SAASqd,cAAc,IAAIwP,YAAY,kBAAkB,IAG3DpR,GAAGhc,KAAK,CACNiJ,QAASyP,GAAczP,QACvB2V,YACElG,GAAc2U,aACd7U,GAAY6U,cACqB,IAAjC3U,GAActQ,kBAKlB,IAAIklB,GAAazT,SAAS/U,KAC1ByoB,aAAY,KACN1T,SAAS/U,OAASwoB,KACpBA,GAAazT,SAAS/U,KACtBkX,GAAGwR,OAAOF,IACVtR,GAAGyR,iBAAiB5hB,MACtB,GACC,KAGHtL,SAAS4J,iBAAiB,qBAAqB,KACzC0P,SAAS/U,OAASwoB,KACpBA,GAAazT,SAAS/U,KACtBkX,GAAGwR,OAAOF,KAEZtR,GAAGyR,iBAAiB5hB,KAAgB,IAItCtL,SAAS4J,iBAAiB,qBAAqB,KAC7CkP,IAAa,IAGf,MAAMqU,GAAgB1e,IACpB,IACEA,GAAMA,EAAGgN,GAGX,CAFE,MAAOja,GACP+B,QAAQC,MAAM,kCAAmChC,EACnD,UAIE0H,OAAOkkB,kBACLriB,MAAMyL,QAAQtN,OAAOkkB,mBACvBlkB,OAAOkkB,iBAAiBnoB,SAASwJ,IAC/B0e,GAAa1e,EAAG,IAKtBvF,OAAOkkB,iBAAmB,CACxBroB,KAAO0J,IACL0e,GAAa1e,EAAG"}